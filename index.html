<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AI OS V15.7 - ç»ˆææ°”æ³¡ä¿®å¤ç‰ˆ</title>
  <style>
    /* --- 1. å…¨å±€åŸºç¡€è®¾ç½® --- */
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none;user-select:none}
    html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Comic Sans MS",sans-serif;background:#fff;color:#555}
    input,textarea,select{user-select:text}
    button{cursor:pointer}

    /* --- 2. æ ¸å¿ƒå¸ƒå±€ (æ¨±èŠ±ç²‰) --- */
    #os-root{
      width:100%;height:100%;
      background: linear-gradient(180deg, #fff0f5 0%, #fff5f7 50%, #ffe6ee 100%);
      display:flex;flex-direction:column;position:relative;
    }
    .status-bar{height:28px;padding:0 15px;display:flex;justify-content:space-between;align-items:center;font-size:12px;color:#ff8fab;font-weight:600;z-index:20;}
    .desktop-area{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative}
    .swiper-container{flex:1;display:flex;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;z-index:10}
    .swiper-container::-webkit-scrollbar{display:none}
    
    .desktop-page{min-width:100%;width:100%;height:100%;padding:5px 20px 20px 20px;display:flex;flex-direction:column;scroll-snap-align:start; overflow-y: auto;}

    /* --- 3. Bento æ¡Œé¢ --- */
    .bento-box { width: 100%; display: flex; flex-direction: column; gap: 24px; padding-bottom: 40px; }
    .top-time-widget { padding: 0 5px; text-align:left; margin-bottom: -5px; margin-top: 0; }
    .tt-one-line { font-size: 28px; font-weight: 700; color: #ff8fab; letter-spacing: 0.5px; text-shadow: 0 2px 5px rgba(255, 143, 171, 0.1); }
    .bento-row { display: flex; justify-content: space-between; height: 155px; gap: 14px; flex-shrink: 0; }
    .bento-img { width: 48%; background-color: #fff; border-radius: 30px; box-shadow: 0 8px 20px rgba(255, 182, 193, 0.25); background-size: cover; background-position: center; position: relative; transition:transform 0.1s; border: 2px solid #fff; }
    .bento-img:active { transform:scale(0.98); }
    .bento-apps { width: 48%; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 10px; }
    .app-icon-wrap { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; cursor: pointer; }
    .app-icon-wrap:active { transform: scale(0.92); }
    .app-icon { width: 62px; height: 62px; border-radius: 20px; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: 0 6px 15px rgba(255, 182, 193, 0.15); border: 1px solid #fff0f5; color: #333; }
    .app-name { color: #ff8fab; font-size: 12px; font-weight: 600; text-align: center; white-space: nowrap; overflow: hidden; width: 100%; }
    .app-icon-placeholder { opacity: 0.3; border: 2px dashed #ffb7b2; background: transparent; box-shadow: none; }
    
    .bento-card { height: 120px; background: #fff; border-radius: 30px; box-shadow: 0 8px 20px rgba(255, 182, 193, 0.25); display: flex; align-items: flex-start; padding: 18px 20px; justify-content: space-between; border: 2px solid #fff; flex-shrink: 0; }
    .bc-info { display: flex; flex-direction: column; gap: 8px; flex: 1; }
    .bc-pill { background: #ffeef2; color: #ff8fab; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight:bold; width: fit-content; cursor: pointer; }
    .bc-text { font-size: 13px; color: #999; margin-left: 4px; margin-top: 5px; cursor: pointer; }
    .bc-avatar { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.08); align-self: center; cursor: pointer; }
    .bottom-dock { width: 100%; height: 55px; background: rgba(255, 255, 255, 0.6); border-radius: 28px; border: 2px solid #fff; display: flex; align-items: center; padding: 0 20px; gap: 15px; box-shadow: 0 5px 15px rgba(255, 182, 193, 0.15); margin-top: 10px; backdrop-filter: blur(5px); flex-shrink: 0; }
    .bd-icon { font-size: 20px; opacity: 0.6; }
    .bd-text { font-size: 14px; color: #ff8fab; opacity: 0.8; font-weight: 500; }

    /* --- 4. App çª—å£ --- */
    .app-win { position: absolute; inset: 0; background: #fffbfd; z-index: 100; display: none; flex-direction: column; }
    .app-win.show { display: flex !important; animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .nav { height: 50px; background: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; border-bottom: 1px solid rgba(0,0,0,0.03); flex-shrink: 0; z-index: 50; }
    .nav-t { font-size: 17px; font-weight: 600; color: #444; }
    .nav-btn { background: none; border: none; color: #666; font-size: 16px; padding: 8px 15px; border-radius: 8px; display: flex; align-items: center; gap: 4px; font-weight: 500; }
    .nav-btn:active { background: #f0f0f0; opacity: 0.7; }
    .scroll-content { flex: 1; overflow-y: auto; height: 0; padding: 15px; }
    
        /* --- ğŸ… ä¸“æ³¨æ—¶é’Ÿ (Focus) æ ·å¼ --- */
    .clock-setup-view { padding: 30px; display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: center; gap: 20px; }
    .clock-run-view { display: none; flex-direction: column; align-items: center; height: 100%; padding-top: 20px; position: relative; overflow: hidden; }
    
    /* AI æ°”æ³¡åŒºåŸŸ (å¸¦åå­—ç‰ˆ) */
    .clock-ai-area { width: 90%; display: flex; gap: 10px; align-items: flex-start; margin-bottom: 20px; z-index: 10; min-height: 80px; }
    
    /* å·¦ä¾§å¤´åƒ+åå­—å®¹å™¨ */
    .clock-ai-left { display: flex; flex-direction: column; align-items: center; gap: 4px; width: 60px; flex-shrink: 0; }
    
    .clock-ai-av { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); object-fit: cover; }
    
    /* æ–°å¢ï¼šåå­—æ ·å¼ */
    .clock-ai-name { font-size: 11px; color: #888; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; font-weight: bold; text-shadow: 0 1px 2px rgba(255,255,255,0.8); }
    
    .clock-ai-bub { background: #fff; padding: 12px 15px; border-radius: 15px; border-top-left-radius: 2px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); font-size: 14px; color: #555; position: relative; flex: 1; line-height: 1.5; }
    .clock-ai-bub::after { content: ''; position: absolute; top: 15px; left: -8px; width: 0; height: 0; border-top: 8px solid transparent; border-bottom: 8px solid transparent; border-right: 8px solid #fff; }


    /* åœ†ç¯è¿›åº¦æ¡ */
    .ring-container { position: relative; width: 260px; height: 260px; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; }
    .progress-ring__circle { transition: stroke-dashoffset 0.5s linear; transform: rotate(-90deg); transform-origin: 50% 50%; }
    .clock-time-text { position: absolute; font-size: 48px; font-weight: bold; color: #ff8fab; font-family: monospace; letter-spacing: -2px; }
    .clock-status-text { position: absolute; top: 170px; font-size: 14px; color: #aaa; letter-spacing: 2px; }

    /* åº•éƒ¨æŒ‰é’® */
    .clock-controls { width: 100%; padding: 0 30px; display: flex; justify-content: space-between; align-items: center; margin-top: auto; margin-bottom: 40px; }
    .cc-btn { width: 70px; height: 70px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.1s; cursor: pointer; }
    .cc-btn:active { transform: scale(0.9); }
    .cc-pause { background: #fff; color: #ffb7b2; border: 2px solid #ffb7b2; }
    .cc-giveup { background: #f5f5f5; color: #999; font-size: 20px; }
    .cc-pause.disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }


    /* --- 5. ç»„ä»¶æ ·å¼ --- */
    .btn { padding: 0 16px; height: 36px; border-radius: 18px; border: none; font-size: 14px; display: inline-flex; justify-content: center; align-items: center; cursor: pointer; font-weight: 500; transition: opacity 0.2s; }
    .btn:active { opacity: 0.7; }
    .btn-blue { background: #a2d2ff; color: #fff; }
    .btn-gray { background: #f5f5f5; color: #666; }
    .btn-red { background: #ffafcc; color: #fff; }
    .btn-block { width: 100%; display: flex; }
    .f-item { margin-bottom: 15px; }
    .f-lbl { display: block; font-size: 13px; color: #888; margin-bottom: 6px; font-weight: 500; }
    .f-in, .f-area, .f-sel { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 12px; background: #fff; font-size: 15px; color: #555; }
    
    /* èŒƒå›´æ»‘å—æ ·å¼ */
    .f-range-wrap { display: flex; align-items: center; gap: 10px; }
    .f-range { flex: 1; }
    .f-val { font-size: 12px; color: #ff8fab; width: 30px; text-align: right; }

    /* ğŸŒŸ é¢„è®¾åˆ†ç»„åˆ—è¡¨æ ·å¼ */
    .preset-group-item {
      background: #fff; border-bottom: 1px solid #f0f0f0; padding: 20px;
      display: flex; align-items: center; justify-content: space-between; cursor: pointer;
    }
    .preset-group-item:first-child { border-top-left-radius: 20px; border-top-right-radius: 20px; }
    .preset-group-item:last-child { border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; border-bottom: none; }
    .pg-name { font-size: 16px; font-weight: bold; color: #333; font-family: "Comic Sans MS", cursive, sans-serif; }
    .pg-radio { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #ccc; display: flex; align-items: center; justify-content: center; }
    .pg-radio.active { border-color: #0984e3; }
    .pg-radio.active::after { content: ''; width: 14px; height: 14px; background: #0984e3; border-radius: 50%; }

    /* ğŸŒŸ é¢„è®¾è„šæœ¬åˆ—è¡¨æ ·å¼ (æ— åŠ¨ç”»ï¼Œé˜²é—ªçƒ) */
    .st-list-header { display: flex; justify-content: space-between; padding: 10px 20px; font-size: 12px; color: #999; font-weight: bold; }
    .st-list-item {
      background: #fff; border-radius: 20px; padding: 12px 15px; margin-bottom: 12px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0,0,0,0.02); border: 1px solid #f8f8f8;
    }
    .st-list-item.dragging { opacity: 0.5; background: #f0f0f0; border: 2px dashed #ccc; }
    .st-li-left { display: flex; align-items: center; gap: 12px; flex: 1; overflow: hidden; }
    .st-li-drag { color: #ddd; font-size: 16px; cursor: grab; padding: 5px; }
    .st-li-icon { font-size: 16px; color: #ff8fab; min-width: 20px; text-align: center; }
    .st-li-name { font-weight: bold; color: #555; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .st-li-right { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
    .st-li-edit { color: #ccc; font-size: 16px; cursor: pointer; }
    .st-li-token { font-size: 12px; color: #666; width: 30px; text-align: right; font-family: monospace; }
    
    /* å¼€å…³æ»‘å— */
    .st-switch { position: relative; display: inline-block; width: 36px; height: 20px; }
    .st-switch input { opacity: 0; width: 0; height: 0; }
    .st-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e0e0e0; transition: .4s; border-radius: 20px; }
    .st-slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    input:checked + .st-slider { background-color: #ffafcc; }
    input:checked + .st-slider:before { transform: translateX(16px); }

    /* ğŸŒŸ ä»¿ SillyTavern ç¼–è¾‘é¡µæ ·å¼ */
    .st-edit-page { padding: 10px; }
    .st-edit-header { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #444; }
    .st-grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    .st-field { display: flex; flex-direction: column; gap: 5px; }
    .st-label { font-size: 13px; color: #888; font-weight: 500; }
    .st-input { background: #f9f9f9; border: none; padding: 12px; border-radius: 12px; font-size: 14px; color: #555; outline: none; }
    .st-select { background: #f9f9f9; border: none; padding: 12px; border-radius: 12px; font-size: 14px; color: #555; outline: none; appearance: none; }
    .st-textarea { width: 100%; height: 250px; background: #f9f9f9; border: none; padding: 15px; border-radius: 15px; font-size: 14px; line-height: 1.6; color: #555; resize: none; font-family: monospace; }
    .st-desc { font-size: 11px; color: #aaa; margin-top: 5px; }

    /* ğŸŒ ä¸–ç•Œä¹¦ Pro æ ·å¼ */
    .wi-list-item { background: #fff; border-radius: 15px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; }
    .wi-card {
      background: #fff; border-radius: 20px; padding: 20px; margin-bottom: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.05); border: 1px solid #f0f0f0;
      display: flex; flex-direction: column; gap: 15px;
    }
    .wi-card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f5f5f5; padding-bottom: 10px; margin-bottom: 5px; }
    .wi-status-dot { width: 14px; height: 14px; border-radius: 50%; background: #eee; border: 2px solid #ddd; cursor: pointer; }
    .wi-status-dot.on { background: #00b894; border-color: #00b894; box-shadow: 0 0 8px rgba(0,184,148,0.4); }
    .wi-row-flex { display: flex; gap: 10px; align-items: center; }
    .wi-pill-input { background: #f9f9f9; border: 1px solid #eee; border-radius: 20px; padding: 8px 15px; font-size: 13px; text-align: center; width: 100%; outline: none; transition: border 0.2s; }
    .wi-pill-input:focus { border-color: #ffafcc; background: #fff; }
    .wi-tag { background: #ffeef2; color: #ff8fab; padding: 4px 10px; border-radius: 10px; font-size: 11px; font-weight: bold; white-space: nowrap; }
    .wi-content-area { width: 100%; height: 120px; background: #fcfcfc; border: 1px solid #eee; border-radius: 15px; padding: 15px; font-size: 14px; line-height: 1.5; resize: none; font-family: monospace; }
    .wi-content-area:focus { border-color: #ffafcc; background: #fff; }
    .wi-logic-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .wi-logic-btn { padding: 5px 12px; border-radius: 15px; border: 1px solid #eee; background: #fff; font-size: 12px; color: #666; cursor: pointer; }
    .wi-logic-btn.active { background: #ffafcc; color: #fff; border-color: #ffafcc; }

      /* --- èŠå¤©æ°”æ³¡ä¿®å¤å¼€å§‹ --- */
    .msg-row { display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-start; }
    .msg-row.me { flex-direction: row-reverse; }
    .msg-av { width: 40px; height: 40px; border-radius: 50%; background: #eee; object-fit: cover; flex-shrink: 0; cursor: pointer; }
    
    /* ğŸŒŸ ä¿®å¤å®¹å™¨ï¼šä½¿ç”¨ flex å¸ƒå±€æ¥æ§åˆ¶æ°”æ³¡çš„å·¦å³å¯¹é½ */
    .msg-content-wrap { 
        max-width: 70%; 
        display: flex; 
        flex-direction: column; 
        /* é»˜è®¤é å·¦ï¼ˆAIï¼‰ */
        align-items: flex-start; 
    }
    
    /* ç”¨æˆ·å‘çš„æ¶ˆæ¯é å³å¯¹é½ */
    .msg-row.me .msg-content-wrap {
        align-items: flex-end;   
    }
    
    /* ğŸŒŸ ç»ˆæä¿®å¤æ°”æ³¡æœ¬ä½“ï¼šåƒ QQ ä¸€æ ·ç´§å‡‘ */
    .msg-bub { 
        padding: 10px 14px;      /* èˆ’æœçš„å†…è¾¹è· */
        font-size: 16px;         /* å­—ä½“ç¨å¾®å¤§ä¸€ç‚¹ç‚¹ï¼Œæ›´åƒAPP */
        line-height: 1.5;        /* è‰¯å¥½çš„è¡Œé«˜ */
        border-radius: 12px;     /* é€‚ä¸­çš„åœ†è§’ */
        position: relative;
        
        word-wrap: break-word;   /* å…è®¸é•¿å•è¯æ¢è¡Œ */
        word-break: break-all;   /* å¼ºåˆ¶æ¢è¡Œï¼Œé˜²æ­¢é•¿æ•°å­—æ’‘ç ´ */
        white-space: pre-wrap;   /* ä¿ç•™æ¢è¡Œç¬¦ */
        
        cursor: pointer; 
        box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
        
        /* ğŸ”¥ æ ¸å¿ƒé­”æ³•ï¼šfit-content è®©å®½åº¦é€‚åº”æ–‡å­—ï¼Œblock è®©é«˜åº¦æ­£å¸¸ */
        width: fit-content;      
        height: auto;            
        display: block;          
        
        /* é¢œè‰²é€»è¾‘ä¿ç•™ */
        background: #fff;
        color: #333;
        border-top-left-radius: 4px; /* AIæ°”æ³¡å·¦ä¸Šè§’å°–ä¸€ç‚¹ */
    }
    
    /* ç”¨æˆ·çš„æ°”æ³¡é¢œè‰²å’Œåœ†è§’æ–¹å‘ */
    .msg-row.me .msg-bub { 
        background: #0099ff;     /* QQ ç»å…¸è“ï¼Œæˆ–è€…ä¿ç•™ä½ çš„ #a2d2ff */
        color: #fff; 
        border-radius: 12px;
        border-top-right-radius: 4px; /* ç”¨æˆ·æ°”æ³¡å³ä¸Šè§’å°–ä¸€ç‚¹ */
    }
    
    /* é’ˆå¯¹éè‡ªå·±çš„æ°”æ³¡ï¼ˆAIï¼‰ */
    .msg-row:not(.me) .msg-bub {
        background: #fff;
        color: #333;
    }
    /* --- èŠå¤©æ°”æ³¡ä¿®å¤ç»“æŸ --- */
    .msg-system { align-self: center; background: transparent; color: #b0b0b0; font-size: 12px; padding: 5px 0; margin-bottom: 10px; text-align: center; width: 100%; }
    .pink-transfer { background: linear-gradient(135deg, #fff0f5 0%, #ffe4e1 100%) !important; color: #888 !important; padding: 12px 15px !important; min-width: 200px; display: flex; align-items: center; gap: 12px; border-radius: 14px !important; position: relative; overflow: hidden; border: 1px solid #fff; box-shadow: 0 2px 8px rgba(255, 182, 193, 0.15); }
    .pink-transfer.received { opacity: 0.6; filter: grayscale(0.1); } 
    .pt-icon-box { width: 40px; height: 40px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .pt-info { display: flex; flex-direction: column; gap: 2px; }
    .pt-amount { font-size: 17px; font-weight: bold; color: #ff8fab; }
    .pt-status { font-size: 12px; color: #999; }
    .msg-loc { background: #fff !important; padding: 0 !important; width: 240px; overflow: hidden; border-radius: 12px !important; border: 1px solid #eee; position: relative; display: flex; flex-direction: column; }
    .msg-loc-top { padding: 12px 12px 8px 12px; background: #fff; z-index: 2; }
    .msg-loc-t { font-size: 16px; font-weight: 600; color: #444; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .msg-loc-d { font-size: 12px; color: #999; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .msg-loc-map-box { width: 100%; height: 110px; position: relative; background: #f2f2f2; background-image: linear-gradient(transparent 95%, #e0e0e0 95%), linear-gradient(90deg, transparent 95%, #e0e0e0 95%); background-size: 20px 20px; }
    .msg-loc-street { position: absolute; top: 30%; left: -10%; width: 120%; height: 12px; background: #fff; transform: rotate(15deg); border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; }
    .msg-loc-dot { position: absolute; width: 6px; height: 6px; background: #ccc; border-radius: 50%; }
    .msg-loc-pin { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); font-size: 32px; color: #ffafcc; text-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 5; }
    .msg-loc-shadow { position: absolute; top: 50%; left: 50%; width: 12px; height: 6px; background: rgba(0,0,0,0.2); border-radius: 50%; transform: translate(-50%, 0); animation: pinShadow 1.5s infinite; }
    @keyframes pinShadow { 0%, 100% { transform: translate(-50%, 0) scale(1); opacity: 0.3; } 50% { transform: translate(-50%, 0) scale(1.5); opacity: 0.1; } }
    .msg-loc-btm { padding: 8px 12px; background: #fff; border-top: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: #999; z-index: 2; }
    .msg-voice-fake { display: flex; flex-direction: column; align-items: flex-start; min-width: 80px; gap: 4px; }
    .mv-top { display: flex; align-items: center; gap: 8px; }
    .mv-icon { font-size: 16px; }
    .mv-wave { font-family: monospace; letter-spacing: -1px; font-size: 14px; }
    .mv-sec { font-size: 12px; opacity: 0.7; margin-left: 5px; }
    .mv-text { display: none; font-size: 14px; margin-top: 4px; padding-top: 4px; border-top: 1px solid rgba(0,0,0,0.1); width: 100%; opacity: 0.9; }
    .msg-voice-fake.show-text .mv-text { display: block; }
    .msg-voice-call { background: #fff !important; padding: 15px !important; display: flex; align-items: center; gap: 10px; min-width: 200px; color: #444 !important; }
    .msg-voice-icon { width: 30px; height: 30px; background: #f0f0f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; }
    .msg-gift { background: linear-gradient(135deg, #fff0f5 0%, #ffe4e1 100%) !important; color: #555 !important; padding: 12px 15px !important; min-width: 180px; display: flex; align-items: center; gap: 12px; border-radius: 14px !important; border: 2px solid #fff; box-shadow: 0 2px 8px rgba(255, 182, 193, 0.2); position: relative; overflow: hidden; }
    .msg-gift.received { opacity: 0.7; filter: grayscale(0.2); }
    .mg-icon { font-size: 28px; }
    .mg-text { font-size: 14px; font-weight: bold; color: #d87093; }
    .mg-sub { font-size: 11px; color: #999; }
    .mg-btn { position: absolute; right: 10px; bottom: 10px; background: #ffafcc; color: #fff; border: none; padding: 4px 10px; border-radius: 12px; font-size: 11px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .mg-btn:active { transform: scale(0.95); }
    .quote-box { background: rgba(0,0,0,0.05); border-left: 3px solid rgba(0,0,0,0.2); padding: 4px 8px; margin-bottom: 5px; font-size: 12px; color: inherit; opacity: 0.8; border-radius: 4px; }
    .quote-bar { background: #f9f9f9; padding: 10px 15px; font-size: 13px; color: #666; display: none; justify-content: space-between; align-items: center; border-top: 1px solid #eee; }
    .bubble-menu { position: absolute; background: #2c2c2c; color: #fff; border-radius: 8px; display: none; z-index: 200; box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-size: 14px; white-space: nowrap; flex-direction: row; overflow: hidden; }
    .bubble-menu div { padding: 10px 20px; cursor: pointer; border-right: 1px solid #444; }
    .bubble-menu div:last-child { border-right: none; }
    .bubble-menu div:active { background: #444; }
    .chat-footer { background: #f7f7f7; border-top: 1px solid #e5e5e5; padding: 8px 10px; display: flex; flex-direction: column; gap: 8px; }
    .chat-input-row { display: flex; align-items: center; gap: 8px; height: 40px; }
    .chat-plus-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #999; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #666; flex-shrink: 0; background: transparent; cursor: pointer; }
    .chat-plus-panel { height: 0; overflow: hidden; transition: height 0.25s ease; background: #f7f7f7; display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 0 20px; border-top: 1px solid #eee; overflow-y: auto; }
    .chat-plus-panel.open { height: 180px; padding-top: 20px; padding-bottom: 20px; }
    .panel-item { display: flex; flex-direction: column; align-items: center; gap: 8px; font-size: 12px; color: #666; cursor: pointer; flex-shrink: 0; }
    .panel-icon { width: 55px; height: 55px; background: #fff; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 24px; border: 1px solid #e0e0e0; }
    .top-pop-menu { position: absolute; top: 50px; right: 10px; background: #4c4c4c; color: #fff; border-radius: 8px; display: none; flex-direction: column; z-index: 200; box-shadow: 0 5px 15px rgba(0,0,0,0.3); min-width: 140px; }
    .top-pop-menu.show { display: flex; }
    .tpm-item { padding: 12px 15px; border-bottom: 1px solid #5b5b5b; font-size: 14px; display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .tpm-item:last-child { border-bottom: none; }
    .tpm-item:active { background: #3a3a3a; }
    .modal-mask { position: absolute; inset: 0; background: rgba(0,0,0,0.4); z-index: 300; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .modal-mask.show { display: flex; }
        /* æ‰¾åˆ° .modal-box å¹¶æ›¿æ¢æˆè¿™ä¸ª */
    .modal-box { 
        width: 85%; 
        max-height: 85%; 
        background: #fff; 
        border-radius: 20px; 
        display: flex; 
        flex-direction: column; 
        overflow: hidden; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
        
        /* âœ¨ ä¼˜åŒ–ï¼šå‘Šè¯‰æµè§ˆå™¨è¿™ä¸ªä¸œè¥¿ä¼šå˜ï¼Œæå‰å‡†å¤‡ */
        will-change: transform, opacity;
        /* âœ¨ ä¼˜åŒ–ï¼šåˆå§‹çŠ¶æ€è®¾ä¸ºé€æ˜ï¼Œé˜²æ­¢å†…å®¹æ²¡åŠ è½½å®Œå°±æ˜¾ç¤º */
        opacity: 0; 
        transform: scale(0.95);
    }
    
    /* å½“çˆ¶çº§æœ‰ .show æ—¶ï¼Œå­å…ƒç´ æ‰å¼€å§‹åŠ¨ç”» */
    .modal-mask.show .modal-box {
        animation: popIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    @keyframes popIn { 
        from { transform: scale(0.95); opacity: 0; } 
        to { transform: scale(1); opacity: 1; } 
    }

    .modal-h { padding: 15px; background: #fff; border-bottom: 1px solid #eee; font-weight: bold; display: flex; justify-content: space-between; font-size: 16px; }
    .modal-b { padding: 20px; overflow-y: auto; flex: 1; }
    .input-modal-box { width: 80%; background: #fff; border-radius: 20px; padding: 20px; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: popIn 0.2s; }
    .im-title { font-size: 18px; font-weight: bold; text-align: center; color: #333; }
    .im-input { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 12px; font-size: 16px; background: #f9f9f9; }
    .im-btns { display: flex; gap: 10px; }
    .handbook-page { width: 90%; height: 80%; background-color: #fdfbf7; border-radius: 10px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); position: relative; display: flex; flex-direction: column; font-family: "Comic Sans MS", "Chalkboard SE", cursive, sans-serif; color: #555; animation: popIn 0.3s; border-left: 12px solid #ffb7b2; padding: 0; overflow: hidden; }
    .binder-rings { position: absolute; left: 6px; top: 30px; bottom: 30px; width: 10px; display: flex; flex-direction: column; justify-content: space-around; z-index: 5; }
    .ring { width: 12px; height: 12px; background: #ddd; border-radius: 50%; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.3); border: 1px solid #bbb; }
    .hb-container { flex: 1; display: flex; flex-direction: column; padding: 20px 20px 20px 30px; overflow-y: auto; background-image: linear-gradient(#e8e8e8 1px, transparent 1px); background-size: 100% 25px; line-height: 25px; }
    .hb-header-tape { align-self: center; background: #ffafcc; color: #fff; padding: 5px 25px; font-weight: bold; font-size: 16px; transform: rotate(-2deg); box-shadow: 2px 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; position: relative; }
    .hb-header-tape::before, .hb-header-tape::after { content: ''; position: absolute; top: 0; bottom: 0; width: 5px; background: rgba(255,255,255,0.3); border-left: 1px dashed rgba(255,255,255,0.5); }
    .hb-header-tape::before { left: 0; } .hb-header-tape::after { right: 0; }
    .hb-sticker-card { background: #fff; padding: 15px; margin-bottom: 20px; box-shadow: 2px 4px 10px rgba(0,0,0,0.05); position: relative; transform: rotate(1deg); border: 1px solid #eee; }
    .hb-sticker-card.dark { transform: rotate(-1deg); background: #f8f8f8; border: 1px solid #ddd; }
    .tape-strip { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 80px; height: 25px; background: rgba(255, 230, 109, 0.6); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .hb-label { font-weight: bold; color: #ff8fab; font-size: 14px; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
    .hb-text { font-size: 15px; color: #666; line-height: 1.6; }
    .hb-btn-row { display: flex; justify-content: space-between; margin-top: auto; padding-top: 15px; }
    .hb-btn { background: none; border: 2px dashed #ffb7b2; color: #ff8fab; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 12px; cursor: pointer; }
    .hb-btn:active { background: #ffeef2; }
    .hb-close-x { position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; background: #ffafcc; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
    .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px; }
    .shop-item { background: #fff; border-radius: 15px; padding: 15px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #eee; position: relative; }
    .si-icon { font-size: 40px; margin-bottom: 5px; }
    .si-name { font-weight: bold; color: #555; font-size: 14px; }
    .si-price { color: #ff8fab; font-weight: bold; margin: 5px 0; }
    .si-btn { background: #a2d2ff; color: #fff; border: none; padding: 5px 15px; border-radius: 15px; font-size: 12px; }
    .si-btn:active { transform: scale(0.95); }
    .backpack-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; }
    .backpack-item { background: #fff; border-radius: 12px; padding: 10px; display: flex; flex-direction: column; align-items: center; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .bi-icon { font-size: 30px; }
    .bi-name { font-size: 12px; color: #666; margin-top: 5px; text-align: center; }
    .bi-count { font-size: 10px; color: #999; background: #f0f0f0; padding: 2px 6px; border-radius: 10px; margin-top: 4px; }
    #voice-call-overlay { position: fixed; inset: 0; background: linear-gradient(135deg, #2c3e50 0%, #000000 100%); background-size: cover; background-position: center; z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: flex-start; padding: 0 20px; color: #fff; }
    #voice-call-overlay.show { display: flex; animation: fadeIn 0.3s; }
    .vc-top-part { margin-top: 60px; display: flex; flex-direction: column; align-items: center; width: 100%; flex-shrink: 0; }
    .vc-avatar-box { position: relative; width: 110px; height: 110px; flex-shrink: 0; }
    .vc-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid rgba(255,255,255,0.2); }
    .vc-pulse { position: absolute; inset: -10px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); animation: pulse 2s infinite; }
    @keyframes pulse { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(1.5); opacity: 0; } }
    .vc-name { font-size: 24px; font-weight: bold; margin-top: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .vc-status { font-size: 14px; opacity: 0.9; margin-top: 8px; font-variant-numeric: tabular-nums; text-shadow: 0 1px 2px rgba(0,0,0,0.5); min-height: 20px; }
    .vc-subtitle { margin-top: auto; margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 16px; width: 100%; min-height: 50px; max-height: 120px; overflow-y: auto; font-size: 16px; line-height: 1.5; text-align: center; backdrop-filter: blur(5px); text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
    .vc-footer { width: 100%; margin-bottom: 220px; display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
    .vc-input-row { width: 100%; display: flex; gap: 10px; margin-bottom: 40px; }
    .vc-input { flex: 1; background: rgba(255,255,255,0.25); border: 1px solid rgba(255,255,255,0.3); border-radius: 24px; padding: 12px 18px; color: #fff; font-size: 16px; backdrop-filter: blur(10px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .vc-input::placeholder { color: rgba(255,255,255,0.7); }
    .vc-send-btn { background: rgba(52, 152, 219, 0.8); border: none; border-radius: 50%; width: 44px; height: 44px; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .vc-btns { display: flex; width: 100%; justify-content: center; }
    .vc-btn { width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; cursor: pointer; transition: transform 0.1s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .vc-btn:active { transform: scale(0.9); }
    .vc-btn-red { background: #ff4d4f; color: #fff; }
    .vc-bg-btn { position: absolute; top: 20px; right: 20px; width: 36px; height: 36px; border-radius: 50%; background: rgba(0,0,0,0.3); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); }
    #lock-screen { position: fixed; inset: 0; background: #000; z-index: 9999; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.5s cubic-bezier(0.7,0,0.3,1); }
    #lock-screen.unlocked { transform: translateY(-100%); }
    .tarot-cards { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; }
    .tarot-card { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 10px; width: 80px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .storage-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 13px; }
    .storage-name { font-weight: 500; color: #555; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 60%; }
    .storage-size { color: #999; margin-right: 10px; }
    .storage-btn { padding: 4px 8px; font-size: 11px; border-radius: 4px; border: 1px solid #ffb7b2; color: #ff8fab; background: #fff; }
    .storage-btn:active { background: #ffeef2; }
    .storage-btn-del { border-color: #ff4d4f; color: #ff4d4f; }
    .storage-btn-del:active { background: #fff0f0; }
    .hide { display: none !important; }
    
        /* ğŸ“” æ—¥è®°æœ¬é‡æ„ï¼šå¥¶æ²¹æ‰‹è´¦é£ (ä¿®å¤ç‰ˆ V2) */
    
    /* 1. å…¨å±€èƒŒæ™¯ */
    .diary-app-bg {
        background-color: #fff9f9;
        background-image: radial-gradient(#ffe4e1 2px, transparent 2px);
        background-size: 24px 24px;
        height: 100%;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    /* 2. ä¸“å±å¯çˆ±å¯¼èˆªæ  (ä¿®å¤é‡å é—®é¢˜) */
    .diary-nav {
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-bottom: 2px dashed #ffe4e1;
        flex-shrink: 0;
        z-index: 50;
    }
    .diary-nav-title {
        font-size: 18px;
        font-weight: 800;
        color: #ffb7b2;
        letter-spacing: 1px;
    }
    .diary-back-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #fff;
        border: 2px solid #ffb7b2;
        color: #ffb7b2;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 18px;
        box-shadow: 0 2px 5px rgba(255, 183, 178, 0.2);
    }
    .diary-close-btn {
        font-size: 24px;
        color: #ffb7b2;
        background: none;
        border: none;
        font-weight: bold;
    }

    /* 3. æ»šåŠ¨åŒºåŸŸ (ä¿®å¤å†…å®¹è¢«é®æŒ¡) */
    .diary-scroll-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        padding-bottom: 40px;
    }

    /* 4. é¦–é¡µå¤§å¡ç‰‡ */
    .diary-entry-card {
        background: #fff;
        border-radius: 24px;
        padding: 25px;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(255, 182, 193, 0.15);
        border: 3px solid #fff;
        transition: transform 0.1s;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .diary-entry-card:active { transform: scale(0.98); }

    /* è£…é¥°åœ†åœˆ */
    .dec-circle {
        position: absolute;
        right: -20px;
        top: -20px;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        opacity: 0.15;
    }
    
    /* å¡ç‰‡æ–‡å­— */
    .dec-title-cn { font-size: 20px; font-weight: 800; color: #5d4037; margin-bottom: 6px; position: relative; z-index: 2; }
    .dec-desc { font-size: 13px; color: #9e9e9e; position: relative; z-index: 2; }
    .dec-title-en {
        font-family: sans-serif; font-weight: 900; font-size: 32px;
        opacity: 0.08; position: absolute; bottom: 5px; right: 15px;
        letter-spacing: -1px; pointer-events: none;
    }

    /* é…è‰²æ–¹æ¡ˆ */
    .card-user { border-left: 8px solid #ffb7b2; }
    .card-user .dec-circle { background: #ffb7b2; }
    .card-ai { border-left: 8px solid #a2d2ff; }
    .card-ai .dec-circle { background: #a2d2ff; }
    .card-ex { border-left: 8px solid #cdb4db; }
    .card-ex .dec-circle { background: #cdb4db; }

    /* 5. æ—¥è®°å†…å®¹å°å¡ç‰‡ (ä¾¿ç­¾é£) */
    .note-card {
        background: #fff;
        border-radius: 18px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        border: 1px solid #f0f0f0;
        position: relative;
    }
    .note-header {
        display: flex; align-items: center; gap: 10px;
        margin-bottom: 12px; padding-bottom: 10px;
        border-bottom: 2px dashed #f5f5f5;
    }
    .note-date { font-size: 22px; font-weight: 800; color: #ffb7b2; font-family: monospace; letter-spacing: -1px; }
    .note-tag { font-size: 10px; padding: 4px 10px; border-radius: 12px; background: #fff0f5; color: #ffb7b2; font-weight: bold; }
    .note-content { font-size: 15px; line-height: 1.7; color: #666; white-space: pre-wrap; }
    .note-footer { margin-top: 15px; display: flex; justify-content: flex-end; gap: 15px; }
    .note-action { font-size: 12px; color: #ccc; font-weight: bold; cursor: pointer; }
    .note-action.active { color: #ffcc00; }

    /* 6. æŒ‰é’® */
    .cute-btn {
        background: #ffb7b2; color: #fff; border: none;
        padding: 14px; border-radius: 16px; font-weight: bold; font-size: 15px;
        box-shadow: 0 5px 15px rgba(255, 183, 178, 0.3); width: 100%; margin-bottom: 20px;
    }
    .cute-btn:active { transform: scale(0.98); }
    .cute-btn.blue { background: #a2d2ff; box-shadow: 0 5px 15px rgba(162, 210, 255, 0.3); }
    .cute-btn.purple { background: #cdb4db; box-shadow: 0 5px 15px rgba(205, 180, 219, 0.3); }

    /* 7. å†™æ—¥è®°å¼¹çª— */
    .paper-modal { position: absolute; inset: 0; background: #fff; z-index: 200; display: none; flex-direction: column; }
    .paper-area {
        flex: 1; padding: 30px; font-size: 16px; line-height: 32px;
        border: none; resize: none; outline: none; color: #555;
        background-image: linear-gradient(transparent 31px, #f0f0f0 31px);
        background-size: 100% 32px; background-color: #fff;
    }
        /* ==============================
       ğŸŒ¸ å…¨å±€ç²‰ç™½ç”œå¿ƒä¸»é¢˜ (è¦†ç›–ç‰ˆ) ğŸŒ¸
       ============================== */

    /* 1. å…¨å±€èƒŒæ™¯ & å­—ä½“é¢œè‰² */
    body, #os-root {
        background: linear-gradient(180deg, #fff0f5 0%, #fff9fb 100%) !important;
        color: #5d4037 !important; /* å­—ä½“æ”¹æˆæš–æ£•è‰²ï¼Œæ¯”é»‘è‰²æ›´è½¯ */
    }

    /* 2. é¡¶éƒ¨å¯¼èˆªæ  (å˜ç²‰) */
    .nav {
        background: rgba(255, 240, 245, 0.95) !important; /* æµ…ç²‰èƒŒæ™¯ */
        border-bottom: 1px solid #ffcce0 !important;      /* æ·±ç²‰è¾¹æ¡† */
    }
    .nav-t {
        color: #d87093 !important; /* æ ‡é¢˜å˜ç«ç‘°ç²‰ */
        font-weight: 700 !important;
    }
    .nav-btn {
        color: #ff8fab !important; /* æŒ‰é’®å˜ç²‰ */
        background: #fff !important;
        border-radius: 12px !important;
        box-shadow: 0 2px 5px rgba(255, 182, 193, 0.2) !important;
    }

    /* 3. QQ èŠå¤©èƒŒæ™¯ */
    #qq-chat-v {
        background: #fff5f7 !important; /* ææ·¡çš„ç²‰è‰²èƒŒæ™¯ */
        background-image: radial-gradient(#ffe6ee 1px, transparent 1px) !important; /* åŠ ä¸€ç‚¹ç‚¹æ³¢ç‚¹çº¹ç† */
        background-size: 20px 20px !important;
    }

    /* 4. æ°”æ³¡æ ·å¼ (æ ¸å¿ƒ) */
    /* è¿™é‡Œçš„ !important æ˜¯ä¸ºäº†è¦†ç›–ä¹‹å‰çš„ JS è®¾å®š */
    
    /* è¿™é‡Œçš„ .msg-bub æ˜¯é€šç”¨è®¾ç½® */
    .msg-bub {
        border-radius: 16px !important; /* æ›´åœ†æ¶¦ */
        box-shadow: 0 3px 10px rgba(255, 182, 193, 0.15) !important;
        border: none !important;
    }

    /* ğŸ‘§ ä½ çš„æ°”æ³¡ (ç²‰è‰²) */
    .msg-row.me .msg-bub {
        background: #ffc2d1 !important; /* æ¨±èŠ±ç²‰ */
        color: #fff !important;
        border-top-right-radius: 2px !important; /* ä¿æŒå°–è§’ */
    }

    /* ğŸ¤– AI çš„æ°”æ³¡ (ç™½è‰² + ç²‰è¾¹) */
    .msg-row:not(.me) .msg-bub {
        background: #fff !important;
        color: #6d4c41 !important; /* æš–æ£•è‰²å­— */
        border: 1px solid #ffeef2 !important; /* ææ·¡ç²‰è¾¹æ¡† */
        border-top-left-radius: 2px !important;
    }

    /* 5. åº•éƒ¨è¾“å…¥æ¡†åŒºåŸŸ */
    .chat-footer {
        background: #fff0f5 !important;
        border-top: 1px solid #ffcce0 !important;
    }
    #msg-in {
        background: #fff !important;
        border: 2px solid #ffe6ee !important;
        color: #d87093 !important;
    }
    #msg-in::placeholder { color: #ffcce0; }

    /* 6. æŒ‰é’®å˜ç²‰ */
    .btn-blue {
        background: #ffafcc !important; /* äº®ç²‰è‰² */
        color: #fff !important;
        box-shadow: 0 4px 10px rgba(255, 175, 204, 0.4) !important;
    }
    .btn-gray {
        background: #fff !important;
        color: #ff8fab !important;
        border: 1px solid #ffb7b2 !important;
    }

    /* 7. å¥½å‹åˆ—è¡¨ç¾åŒ– */
    #ct-list div {
        border-bottom: 1px dashed #ffe6ee !important; /* è™šçº¿åˆ†å‰²æ›´å¯çˆ± */
    }
    #ct-list img {
        border: 2px solid #fff0f5 !important;
    }
    /* âœ¨ ä¿®å¤ï¼šå»æ‰å¯¼èˆªæ æŒ‰é’®çš„ç™½åº•æ–¹æ¡† */
    .nav-btn {
        background: transparent !important; /* èƒŒæ™¯å˜é€æ˜ */
        box-shadow: none !important;        /* å»æ‰é˜´å½± */
        border: none !important;            /* å»æ‰è¾¹æ¡† */
    }
    
    /* ç‚¹å‡»æ—¶ç¨å¾®æœ‰ä¸€ç‚¹ç‚¹åé¦ˆï¼Œä¸ç„¶ä¸çŸ¥é“ç‚¹æ²¡ç‚¹åˆ° */
    /* âœ¨ ä¿®å¤ï¼šç‚¹å‡»æŒ‰é’®æ—¶åªæ”¹å˜é€æ˜åº¦ï¼Œä¸æ”¹å˜èƒŒæ™¯è‰²ï¼Œé˜²æ­¢é—ªçƒ */
.nav-btn:active { 
    background: transparent !important; 
    opacity: 0.5; 
    transform: scale(0.95); 
}

    /* ğŸ“ å¼ºåŠ›ä¿®å¤ï¼šè®©è¯­éŸ³é€šè¯æ°”æ³¡å¼ºåˆ¶å˜ç™½ */
    .msg-row.me .msg-bub.msg-voice-call {
        background: #fff !important;          /* å¼ºåˆ¶ç™½åº• */
        color: #5d4037 !important;            /* å­—ä½“å˜å›æš–æ£•è‰² */
        border: 1px solid #ffeef2 !important; /* åŠ ä¸ªæ·¡ç²‰è¾¹æ¡†å¥½çœ‹ */
    }

    /* é¡ºä¾¿æŠŠé‚£ä¸ªç”µè¯å°å›¾æ ‡çš„èƒŒæ™¯ä¹Ÿä¿®ä¸€ä¸‹ï¼Œä¸ç„¶åœ¨ç™½åº•ä¸Šä¸å¥½çœ‹ */
    .msg-row.me .msg-voice-icon {
        background: #f0f0f0 !important;       /* æµ…ç°åº• */
        color: #555 !important;               /* æ·±ç°å›¾æ ‡ */
    }
        /* ğŸ’¸ è½¬è´¦å¡ç‰‡ï¼šè‰è“ç‰›å¥¶æ·¡ç²‰ç‰ˆ */
    .msg-row .msg-bub.pink-transfer {
        /* èƒŒæ™¯ï¼šè¶…çº§æ¸©æŸ”çš„æ·¡ç²‰è‰²æ¸å˜ */
        background: linear-gradient(135deg, #ffcce0 0%, #ffbbcc 100%) !important;
        
        /* è¾¹æ¡†ï¼šåŠ ç²—ç™½è¾¹ï¼Œåƒè´´çº¸ */
        border: 3px solid #fff !important;
        border-radius: 22px !important;
        
        /* é˜´å½±ï¼šæ·¡æ·¡çš„ç²‰è‰²å…‰æ™• */
        box-shadow: 0 5px 15px rgba(255, 182, 193, 0.3) !important;
        
        /* å¸ƒå±€ */
        padding: 10px 15px !important;
        min-width: 210px !important;
        display: flex !important;
        align-items: center !important;
        gap: 12px !important;
    }

    /* å·¦ä¾§åœ†åœˆ */
    .pt-icon-box {
        background: #fff !important;
        color: #ffafcc !important; /* ç¬¦å·å˜æˆå«©ç²‰è‰² */
        width: 44px !important;
        height: 44px !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.05) !important;
        font-size: 0 !important; 
    }
    .pt-icon-box::after {
        content: 'Â¥';
        font-size: 24px !important;
        font-weight: bold !important;
        font-family: sans-serif !important;
    }

    /* é‡‘é¢æ•°å­— */
    .pt-amount {
        color: #fff !important; /* çº¯ç™½æ–‡å­— */
        font-size: 22px !important;
        font-weight: 800 !important;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
        font-family: "Comic Sans MS", sans-serif !important;
    }

    /* çŠ¶æ€å°å­— */
    .pt-status {
        color: rgba(255,255,255,0.95) !important;
        font-size: 11px !important;
        font-weight: normal !important;
        margin-top: 2px !important;
    }
        /* ğŸ”® å¡”ç½—ç‰Œå‡çº§ç‰ˆæ ·å¼ */
    .tarot-container {
        display: flex; flex-direction: column; height: 100%; padding: 15px;
        background: linear-gradient(180deg, #f3e5f5 0%, #e1bee7 100%);
    }
    
    /* é˜¶æ®µ 1: è¾“å…¥é—®é¢˜ */
    .tarot-step-1 { display: flex; flex-direction: column; height: 100%; justify-content: center; align-items: center; gap: 20px; animation: fadeIn 0.5s; }
    .tarot-big-icon { font-size: 80px; margin-bottom: 10px; text-shadow: 0 5px 15px rgba(156, 39, 176, 0.3); }
    
    /* é˜¶æ®µ 2: æŠ½ç‰ŒåŒºåŸŸ */
    .tarot-step-2 { display: none; flex-direction: column; height: 100%; animation: fadeIn 0.5s; }
    .tarot-deck-area { 
        flex: 1; display: flex; flex-wrap: wrap; justify-content: center; align-content: center; gap: 5px; 
        perspective: 1000px; overflow-y: auto; padding: 10px;
    }
    .tarot-card-back {
        width: 50px; height: 80px; 
        background: linear-gradient(135deg, #6a1b9a 0%, #4a148c 100%);
        border: 2px solid #fff; border-radius: 6px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        cursor: pointer; transition: transform 0.2s;
        display: flex; align-items: center; justify-content: center;
        font-size: 20px; color: rgba(255,255,255,0.3);
    }
    .tarot-card-back:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(106, 27, 154, 0.4); }
    .tarot-card-back.selected { opacity: 0; pointer-events: none; transform: scale(0); }

    /* é€‰ä¸­çš„ç‰Œå±•ç¤ºåŒº */
    .tarot-slots { 
        height: 120px; display: flex; justify-content: center; gap: 15px; align-items: center; 
        border-top: 1px dashed #ce93d8; margin-top: 10px; padding-top: 10px;
    }
    .tarot-slot {
        width: 60px; height: 90px; border: 2px dashed #ba68c8; border-radius: 8px;
        display: flex; align-items: center; justify-content: center; font-size: 12px; color: #ba68c8;
        position: relative;
    }
    .tarot-card-face {
        width: 100%; height: 100%; background: #fff; border-radius: 6px; border: 1px solid #ba68c8;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        text-align: center; padding: 2px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        animation: flipIn 0.6s;
    }
    @keyframes flipIn { from { transform: rotateY(90deg); opacity: 0; } to { transform: rotateY(0); opacity: 1; } }

    /* é˜¶æ®µ 3: ç»“æœä¸å†å² */
    .tarot-step-3 { display: none; flex-direction: column; height: 100%; animation: fadeIn 0.5s; }
    .tarot-result-box { background: #fff; padding: 15px; border-radius: 15px; margin-top: 15px; flex: 1; overflow-y: auto; font-size: 14px; line-height: 1.6; color: #555; border: 1px solid #f3e5f5; }
    
    .tarot-history-item {
        background: #fff; padding: 12px; border-radius: 12px; margin-bottom: 10px;
        border-left: 4px solid #ab47bc; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        cursor: pointer;
    }
    .th-q { font-weight: bold; color: #4a148c; margin-bottom: 4px; }
    .th-date { font-size: 11px; color: #999; }
    .th-cards { font-size: 12px; color: #7b1fa2; margin-top: 4px; }
  </style>
</head>
<body>

<!-- ğŸ”’ é”å± -->
<div id="lock-screen" onclick="this.classList.add('unlocked')">
  <div style="font-size:64px;font-weight:300;font-family:sans-serif" id="ls-time">12:00</div>
  <div style="margin-top:10px;opacity:0.8;font-size:16px">1æœˆ1æ—¥ æ˜ŸæœŸä¸€</div>
  <div style="margin-top:60px;font-size:13px;opacity:0.5">å‘ä¸Šæ»‘åŠ¨è§£é”</div>
</div>

<!-- ğŸ“ å…¨å±è¯­éŸ³é€šè¯ç•Œé¢ -->
<div id="voice-call-overlay">
  <div class="vc-bg-btn" onclick="changeVoiceBg()">ğŸ–¼ï¸</div>
  <div class="vc-top-part">
    <div class="vc-avatar-box">
      <div class="vc-pulse"></div>
      <img id="vc-av" class="vc-avatar" src="">
    </div>
    <div class="vc-name" id="vc-name">AIåŠ©æ‰‹</div>
    <div class="vc-status" id="vc-status">æ­£åœ¨ç­‰å¾…å¯¹æ–¹æ¥å—é‚€è¯·...</div>
  </div>
  <div class="vc-subtitle" id="vc-subtitle">(AI çš„å£°éŸ³ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ...)</div>
  <div class="vc-footer">
    <div class="vc-input-row">
      <input id="vc-in" class="vc-input" placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯...">
      <button class="vc-send-btn" onclick="sendVoiceText()">â†‘</button>
    </div>
    <div class="vc-btns">
      <div class="vc-btn vc-btn-red" onclick="endVoiceCall()">ğŸ“</div>
    </div>
  </div>
</div>

<!-- ğŸ“± ä¸»ç•Œé¢ -->
<div id="os-root">
  <div class="status-bar">
    <span id="sb-time">12:00</span>
    <span>AI OS</span>
  </div>

  <div class="desktop-area">
    <div class="swiper-container" id="swiper">
      
      <!-- ğŸŒ¸ ç¬¬ 1 é¡µ -->
      <div class="desktop-page">
        <div class="bento-box">
          <div class="top-time-widget">
            <div class="tt-one-line" id="tt-full">1æœˆ1æ—¥ å‘¨ä¸€ 12:00</div>
          </div>
          <div class="bento-row">
            <div class="bento-img" id="img-p1-tl" onclick="upBento('p1-tl')"></div>
            <div class="bento-apps">
              <div class="app-icon-wrap" onclick="openApp('qq')"><div class="app-icon">ğŸ§</div><span class="app-name">QQ</span></div>
              <div class="app-icon-wrap" onclick="openApp('tarot')"><div class="app-icon">ğŸ”®</div><span class="app-name">å¡”ç½—</span></div>
              <div class="app-icon-wrap" onclick="openApp('life')"><div class="app-icon">ğŸ§˜</div><span class="app-name">ç”Ÿæ´»</span></div>
              <div class="app-icon-wrap" onclick="openApp('clock')"><div class="app-icon">ğŸ…</div><span class="app-name">ä¸“æ³¨</span></div>
            </div>
          </div>
          <div class="bento-card">
            <div class="bc-info">
              <div class="bc-pill" id="bc-sch" onclick="editBento('sch')">ğŸ“… è¡Œç¨‹</div>
              <div class="bc-text" id="bc-txt" onclick="editBento('txt')">ç‚¹å‡»è®¾ç½®ä¸€å¥æ²»æ„ˆçš„è¯...</div>
            </div>
            <img class="bc-avatar" id="bc-av" src="https://via.placeholder.com/100" onclick="upBento('av')">
          </div>
          <div class="bento-row">
            <div class="bento-apps">
              <div class="app-icon-wrap" onclick="openApp('study')"><div class="app-icon">ğŸ“</div><span class="app-name">å­¦ä¹ </span></div>
              <div class="app-icon-wrap" onclick="openApp('goals')"><div class="app-icon">ğŸ¯</div><span class="app-name">ç›®æ ‡</span></div>
              <div class="app-icon-wrap" onclick="openApp('notes')"><div class="app-icon">ğŸ“</div><span class="app-name">ä¾¿ç­¾</span></div>
              <div class="app-icon-wrap" onclick="openApp('games')"><div class="app-icon">ğŸ®</div><span class="app-name">æ¸¸æˆ</span></div>
            </div>
            <div class="bento-img" id="img-p1-br" onclick="upBento('p1-br')"></div>
          </div>
          <div class="bottom-dock">
            <div class="bd-icon">ğŸ”</div>
            <div class="bd-text">Search...</div>
          </div>
        </div>
      </div>

      <!-- ğŸŒ¸ ç¬¬ 2 é¡µ (çº¯å‡€ç‰ˆ) -->
      <div class="desktop-page">
        <div class="bento-box">
          <div class="bento-row">
            <div class="bento-img" id="img-p2-tl" onclick="upBento('p2-tl')"></div>
            <div class="bento-apps">
              <div class="app-icon-wrap" onclick="openApp('presets')"><div class="app-icon">ğŸ›ï¸</div><span class="app-name">é¢„è®¾</span></div>
              <div class="app-icon-wrap" onclick="openApp('worldinfo')"><div class="app-icon">ğŸŒ</div><span class="app-name">ä¸–ç•Œä¹¦</span></div>
              <div class="app-icon-wrap" onclick="openApp('diary')"><div class="app-icon">ğŸ“”</div><span class="app-name">æ—¥è®°</span></div>
              <div class="app-icon-wrap" onclick="openApp('user')"><div class="app-icon">ğŸ‘¤</div><span class="app-name">ç”¨æˆ·</span></div>
            </div>
          </div>
          <!-- ğŸŒŸ ç¬¬äºŒé¡µè‡ªå®šä¹‰ç»„ä»¶ -->
          <div class="bento-card">
            <div class="bc-info">
              <div class="bc-pill" id="bc-p2-pill" onclick="editBento('p2-pill')">âœ¨ å¤‡å¿˜å½•</div>
              <div class="bc-text" id="bc-p2-txt" onclick="editBento('p2-txt')">ç‚¹å‡»ç¼–è¾‘å†…å®¹...</div>
            </div>
            <img class="bc-avatar" id="bc-p2-av" src="https://via.placeholder.com/100" onclick="upBento('p2-av')">
          </div>
          <div class="bento-row">
            <div class="bento-apps">
              <div class="app-icon-wrap" onclick="openModal('settings')"><div class="app-icon">âš™ï¸</div><span class="app-name">è®¾ç½®</span></div>
              <div class="app-icon-wrap app-icon-placeholder"><div class="app-icon"></div></div>
              <div class="app-icon-wrap app-icon-placeholder"><div class="app-icon"></div></div>
              <div class="app-icon-wrap app-icon-placeholder"><div class="app-icon"></div></div>
            </div>
            <div class="bento-img" id="img-p2-br" onclick="upBento('p2-br')"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ğŸ… ä¸“æ³¨ App -->
<div class="app-win" id="win-clock">
  <div class="nav">
    <button class="nav-btn" onclick="closeApp('clock')">âœ•</button>
    <span class="nav-t">ä¸“æ³¨æ—¶åˆ»</span>
    <div style="width:40px"></div>
  </div>
  
  <!-- 1. è®¾ç½®ç•Œé¢ (Setup View) -->
  <div id="clock-setup" class="clock-setup-view">
    <div style="font-size:60px;margin-bottom:10px">ğŸ…</div>
    <div style="font-size:20px;font-weight:bold;color:#555;margin-bottom:20px">å¼€å§‹ä¸“æ³¨</div>
    
    <div class="f-item" style="width:100%">
      <label class="f-lbl">é€‰æ‹©é™ªä¼´ AI</label>
      <select id="clock-ai-sel" class="f-sel"></select>
    </div>
    
    <div class="f-item" style="width:100%">
      <label class="f-lbl">èƒŒæ™¯ç™½å™ªéŸ³ ğŸµ</label>
      <select id="clock-noise-sel" class="f-sel">
        <option value="">(æ— å£°)</option>
        <option value="rain">ğŸŒ§ï¸ ä¸‹é›¨å¤©</option>
        <option value="fire">ğŸ”¥ å£ç‚‰ç«</option>
        <option value="forest">ğŸŒ² æ£®æ—é¸Ÿé¸£</option>
        <option value="night">ğŸ¦— å¤å¤œè™«é¸£</option>
      </select>
    </div>
    
    <div class="f-item" style="width:100%">
      <label class="f-lbl">ä¸“æ³¨æ—¶é•¿: <span id="clock-val-disp" style="color:#ff8fab;font-weight:bold">25</span> åˆ†é’Ÿ</label>
      <div class="f-range-wrap">
        <span style="font-size:12px;color:#999">5</span>
        <input type="range" class="f-range" min="5" max="120" step="5" value="25" oninput="getId('clock-val-disp').innerText=this.value">
        <span style="font-size:12px;color:#999">120</span>
      </div>
    </div>

    <button class="btn btn-blue btn-block" style="height:50px;font-size:18px;margin-top:20px" onclick="startFocus()">ğŸš€ å¼€å§‹ä¸“æ³¨</button>
  </div>

  <!-- 2. è¿è¡Œç•Œé¢ (Run View) -->
  <div id="clock-run" class="clock-run-view">
    <!-- AI åŒºåŸŸ -->
    <div class="clock-ai-area">
      <div class="clock-ai-left">
        <img id="clock-run-av" class="clock-ai-av" src="">
        <span id="clock-run-name" class="clock-ai-name">AI</span>
      </div>
      <div id="clock-run-bub" class="clock-ai-bub">...</div>
    </div>

    <!-- è¿›åº¦ç¯ -->
    <div class="ring-container">
      <svg class="progress-ring" width="260" height="260">
        <circle class="progress-ring__circle" stroke="#ffeef2" stroke-width="12" fill="transparent" r="120" cx="130" cy="130"/>
        <circle id="ring-bar" class="progress-ring__circle" stroke="#ff8fab" stroke-width="12" stroke-linecap="round" fill="transparent" r="120" cx="130" cy="130" style="stroke-dasharray: 754; stroke-dashoffset: 0;"/>
      </svg>
      <div class="clock-time-text" id="clock-timer">25:00</div>
      <div class="clock-status-text" id="clock-status">FOCUSING</div>
    </div>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="clock-controls">
      <button class="cc-btn cc-giveup" onclick="giveUpFocus()">ğŸ³ï¸<br><span style="font-size:10px">æ”¾å¼ƒ</span></button>
      <button id="btn-pause" class="cc-btn cc-pause" onclick="togglePause()">â¸<br><span style="font-size:10px" id="pause-txt">æš‚åœ(1)</span></button>
    </div>
  </div>
  
  <!-- éšå½¢æ’­æ”¾å™¨ -->
  <audio id="clock-bgm" loop style="display:none"></audio>
</div>


<!-- QQ -->
<div class="app-win" id="win-qq">
  <div id="qq-list-v" style="display:flex;flex-direction:column;height:100%">
    <div class="nav">
      <button class="nav-btn" onclick="closeApp('qq')">âœ•</button>
      <span class="nav-t">æ¶ˆæ¯</span>
      <button class="nav-btn" onclick="toggleTopMenu()">+</button>
      <div class="top-pop-menu" id="top-menu">
        <div class="tpm-item" onclick="addContact()">ğŸ‘¤ æ·»åŠ å¥½å‹</div>
        <div class="tpm-item" onclick="importSillyTavern()">ğŸ“¥ å¯¼å…¥è§’è‰²å¡</div>
      </div>
    </div>
    <div class="scroll-content" id="ct-list" style="background:#fff"></div>
  </div>
  
  <div id="qq-chat-v" style="display:none;flex-direction:column;height:100%;background:#f2f2f2;background-size:cover;background-position:center">
    <div class="nav">
      <button class="nav-btn" onclick="exitChat()">â®</button>
      <span class="nav-t" id="chat-t">AI</span>
      <div style="display:flex">
        <button class="nav-btn" onclick="showInnerThoughts()">ğŸ€</button>
        <button class="nav-btn" onclick="openAiSettings()">ğŸ±</button>
      </div>
    </div>
    <div class="scroll-content" id="chat-box" style="padding-bottom:20px"></div>
    <div class="quote-bar" id="quote-bar">
      <span id="quote-text">æ­£åœ¨å¼•ç”¨...</span>
      <span onclick="cancelQuote()" style="font-weight:bold;cursor:pointer">âœ•</span>
    </div>
    <div class="chat-footer">
      <div class="chat-input-row">
        <div class="chat-plus-btn" onclick="togglePlusPanel()">+</div>
        <input id="msg-in" class="f-in" style="margin:0;flex:1;padding:8px 12px;border-radius:20px;border:none;height:36px" placeholder="å‘æ¶ˆæ¯...">
        <button class="btn btn-gray" onclick="triggerAiReply()" style="width:60px;padding:0">å›å¤</button>
        <button class="btn btn-blue" onclick="sendMsg('text')" style="width:60px;padding:0">å‘é€</button>
      </div>
      <div class="chat-plus-panel" id="plus-panel">
        <div class="panel-item" onclick="summarizeChat(true)">
          <div class="panel-icon" style="color:#6c5ce7">ğŸ“</div>
          <span>è®°å¿†æ€»ç»“</span>
        </div>
        <div class="panel-item">
          <div class="panel-icon" style="color:#ff9ff3">ğŸ‘›</div>
          <span id="user-balance-disp" style="font-weight:bold;color:#d87093;font-size:11px">Â¥ 2000</span>
        </div>
        <div class="panel-item" onclick="openShop()">
          <div class="panel-icon" style="color:#ff6b81">ğŸ›ï¸</div>
          <span>å•†åº—</span>
        </div>
        <div class="panel-item" onclick="openUserBackpack()">
          <div class="panel-icon" style="color:#a29bfe">ğŸ’</div>
          <span>æˆ‘çš„èƒŒåŒ…</span>
        </div>
        <div class="panel-item" onclick="openInputModal('è½¬è´¦é‡‘é¢', 'ä¾‹å¦‚ 520.00', 'transfer')">
          <div class="panel-icon" style="color:#fa9d3b">ğŸ’°</div>
          <span>è½¬è´¦</span>
        </div>
        <div class="panel-item" onclick="openInputModal('ä½ç½®åç§°', 'ä¾‹å¦‚ å¹¸ç¦å¤§è¡—1å·', 'loc')">
          <div class="panel-icon" style="color:#1dd1a1">ğŸ“</div>
          <span>å®šä½</span>
        </div>
        <div class="panel-item" onclick="startVoiceCall(false)">
          <div class="panel-icon" style="color:#333">ğŸ“</div>
          <span>è¯­éŸ³é€šè¯</span>
        </div>
        <div class="panel-item" onclick="forwardChat()">
          <div class="panel-icon" style="color:#0984e3">â†ªï¸</div>
          <span>è½¬å‘è®°å½•</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ğŸŒ ä¸–ç•Œä¹¦ App -->
<div class="app-win" id="win-worldinfo">
  <div class="nav">
    <button class="nav-btn" onclick="closeApp('worldinfo')">âœ•</button>
    <span class="nav-t">ä¸–ç•Œä¹¦</span>
    <div style="display:flex;gap:5px">
      <button class="nav-btn" onclick="createWorldInfo()">â•</button>
      <button class="nav-btn" onclick="importWorldInfo()">ğŸ“¥</button>
    </div>
  </div>
  <div class="scroll-content" id="wi-list"></div>
</div>

<!-- ğŸŒ ä¸–ç•Œä¹¦è¯¦æƒ…é¡µ (Proç‰ˆ) -->
<div class="app-win" id="win-wi-detail">
  <div class="nav">
    <button class="nav-btn" onclick="closeWiDetail()">â® è¿”å›</button>
    <span class="nav-t" id="wi-detail-title">ç¼–è¾‘ä¸–ç•Œä¹¦</span>
    <button class="nav-btn" onclick="addWiEntry()">â• æ¡ç›®</button>
  </div>
  <div class="scroll-content" id="wi-entries-list" style="background:#f5f5f5"></div>
</div>

<!-- ğŸ›ï¸ é¢„è®¾ App (åˆ†ç»„ç‰ˆ) -->
<div class="app-win" id="win-presets">
  <div class="nav">
    <button class="nav-btn" onclick="closeApp('presets')">âœ•</button>
    <span class="nav-t">é¢„è®¾ (è„šæœ¬)</span>
    <div style="display:flex;gap:5px">
      <button class="nav-btn" onclick="createPresetCollection()">â•</button>
      <button class="nav-btn" onclick="importPreset()">ğŸ“¥</button>
    </div>
  </div>
  <div class="scroll-content" id="preset-collections-list" style="background:#f5f5f5;padding:15px"></div>
</div>

<!-- ğŸ›ï¸ é¢„è®¾è¯¦æƒ…é¡µ (è„šæœ¬åˆ—è¡¨) -->
<div class="app-win" id="win-preset-detail">
  <div class="nav">
    <button class="nav-btn" onclick="closePresetDetail()">â® è¿”å›</button>
    <span class="nav-t" id="pd-title">é¢„è®¾è¯¦æƒ…</span>
    <button class="nav-btn" onclick="addPresetScript()">â• è„šæœ¬</button>
  </div>
  <div class="scroll-content">
    <div class="st-list-header">
      <span>åç§°</span>
      <span>è¯ç¬¦</span>
    </div>
    <div id="preset-scripts-list"></div>
  </div>
</div>

<!-- ğŸ›ï¸ é¢„è®¾ç¼–è¾‘å¼¹çª— (ä»¿ ST ç¼–è¾‘é¡µ) -->
<div class="modal-mask" id="preset-edit-modal">
  <div class="modal-box">
    <div class="modal-h"><span>ç¼–è¾‘é¢„è®¾</span><span onclick="closePresetEdit()">âœ•</span></div>
    <div class="modal-b st-edit-page">
      <div class="st-edit-header">ç¼–è¾‘</div>
      <div class="st-grid-row">
        <div class="st-field">
          <span class="st-label">å§“å</span>
          <input id="pe-name" class="st-input">
          <span class="st-desc">æ­¤æç¤ºè¯çš„åç§°ã€‚</span>
        </div>
        <div class="st-field">
          <span class="st-label">è§’è‰²</span>
          <select id="pe-role" class="st-select">
            <option value="system">System</option>
            <option value="user">User</option>
            <option value="assistant">Assistant</option>
          </select>
          <span class="st-desc">æ­¤æ¶ˆæ¯å½’å±äºè°ã€‚</span>
        </div>
      </div>
      <div class="st-grid-row">
        <div class="st-field">
          <span class="st-label">è§¦å‘å™¨</span>
          <select id="pe-trigger" class="st-select">
            <option value="normal">æ­£å¸¸</option>
            <option value="continue">ç»§ç»­</option>
            <option value="always">æ€»æ˜¯</option>
          </select>
        </div>
        <div class="st-field">
          <span class="st-label">ä½ç½®</span>
          <select id="pe-pos" class="st-select">
            <option value="after_char">è§’è‰²å</option>
            <option value="before_char">è§’è‰²å‰</option>
            <option value="at_depth">æŒ‡å®šæ·±åº¦</option>
          </select>
        </div>
      </div>
      <div class="st-field" style="margin-bottom:15px">
        <span class="st-label">æ·±åº¦ (Depth)</span>
        <input id="pe-depth" type="number" class="st-input" value="0">
        <span class="st-desc">æç¤ºè¯åœ¨èŠå¤©è®°å½•ä¸­çš„æ·±åº¦ã€‚</span>
      </div>
      <div class="st-field">
        <span class="st-label">æç¤ºè¯å†…å®¹</span>
        <textarea id="pe-content" class="st-textarea"></textarea>
      </div>
      <button class="btn btn-blue btn-block" style="margin-top:20px" onclick="savePresetScript()">ä¿å­˜</button>
      <button class="btn btn-red btn-block" style="margin-top:10px" onclick="deletePresetScript()">åˆ é™¤</button>
    </div>
  </div>
</div>

<!-- ğŸ€ å¿ƒå£°æ‰‹è´¦å¼¹çª— (å…¨æ–°å¯çˆ±é«˜çº§é£) -->
<div class="modal-mask" id="thought-modal">
  <div class="handbook-page">
    <div class="hb-close-x" onclick="closeThoughts()">âœ•</div>
    <div class="binder-rings">
      <div class="ring"></div><div class="ring"></div><div class="ring"></div><div class="ring"></div><div class="ring"></div>
    </div>
    <div class="hb-container">
      <div class="hb-header-tape">ğŸ¤« ç§˜å¯†æ‰‹è´¦æœ¬</div>
      
      <div id="hb-current-view" style="display:flex;flex-direction:column;height:100%">
        <div id="hb-content" style="flex:1">æ­£åœ¨å·å¬å¿ƒå£°...</div>
      </div>
      
      <div id="hb-history-view" style="display:none;flex-direction:column;height:100%">
        <div id="hb-hist-list" style="flex:1"></div>
      </div>

      <div class="hb-btn-row">
        <button class="hb-btn" onclick="closeThoughts()">åˆä¸Šæ—¥è®°</button>
        <button class="hb-btn hb-btn-hist" onclick="toggleThoughtHistory()">ğŸ“– ç¿»çœ‹æ—§è´¦</button>
      </div>
    </div>
  </div>
</div>

<!-- ğŸ›ï¸ å•†åº—å¼¹çª— -->
<div class="modal-mask" id="shop-modal">
  <div class="modal-box" style="background:#fff0f5">
    <div class="modal-h" style="background:#fff0f5;border-bottom:none"><span style="color:#d87093">ğŸ›ï¸ ç”œå¿ƒä¾¿åˆ©åº—</span><span onclick="closeShop()">âœ•</span></div>
    <div class="modal-b" id="shop-content" style="padding:10px"></div>
  </div>
</div>

<!-- ğŸ’ èƒŒåŒ…å¼¹çª— -->
<div class="modal-mask" id="backpack-modal">
  <div class="modal-box" style="background:#f0f8ff">
    <div class="modal-h" style="background:#f0f8ff;border-bottom:none"><span style="color:#6c5ce7">ğŸ’ æˆ‘çš„èƒŒåŒ…</span><span onclick="closeBackpack()">âœ•</span></div>
    <div class="modal-b" id="backpack-content" style="padding:10px"></div>
  </div>
</div>

<!-- æ°”æ³¡èœå• -->
<div class="bubble-menu" id="bub-menu">
  <div onclick="doQuote()">å¼•ç”¨</div>
  <div onclick="doRecall()" style="color:#ff6b6b">æ’¤å›</div>
</div>

<!-- ğŸ“” æ—¥è®°æœ¬ (æœ€ç»ˆä¿®å¤ç‰ˆ) -->
<div class="app-win" id="win-diary">
  
  <!-- ä¸»è§†å›¾ -->
  <div id="diary-main-view" class="diary-app-bg">
    <!-- ä¸“å±å¯¼èˆªæ  -->
    <div class="diary-nav">
      <div style="width:30px"></div> <!-- å ä½ç¬¦ -->
      <div class="diary-nav-title">æˆ‘çš„æ‰‹è´¦æœ¬</div>
      <button class="diary-close-btn" onclick="closeApp('diary')">âœ•</button>
    </div>
    
    <div class="diary-scroll-area">
      <!-- ç”¨æˆ·æ—¥è®°å…¥å£ -->
      <div class="diary-entry-card card-user" onclick="openDiarySub('user')">
        <div class="dec-circle"></div>
        <div class="dec-title-cn">ç§å¯†æ—¥è®°</div>
        <div class="dec-desc">è®°å½•åªæœ‰è‡ªå·±çŸ¥é“çš„å°ç§˜å¯†</div>
        <div class="dec-title-en">PRIVATE</div>
      </div>

      <!-- AI æ—¥è®°å…¥å£ -->
      <div class="diary-entry-card card-ai" onclick="openDiarySub('ai')">
        <div class="dec-circle"></div>
        <div class="dec-title-cn">è§‚å¯Ÿæ—¥è®°</div>
        <div class="dec-desc">å·çœ‹ AI çš„å†…å¿ƒç‹¬ç™½</div>
        <div class="dec-title-en">OBSERVE</div>
      </div>

      <!-- äº¤æ¢æ—¥è®°å…¥å£ -->
      <div class="diary-entry-card card-ex" onclick="openDiarySub('ex')">
        <div class="dec-circle"></div>
        <div class="dec-title-cn">äº¤æ¢æ—¥è®°</div>
        <div class="dec-desc">ä¸ AI äº¤æ¢å½¼æ­¤çš„å¿ƒæƒ…</div>
        <div class="dec-title-en">EXCHANGE</div>
      </div>
    </div>
  </div>

  <!-- å­é¡µé¢ï¼šç”¨æˆ·æ—¥è®° -->
  <div class="diary-sub-page" id="dsp-user" style="display:none; flex-direction:column; height:100%; background:#fff9f9;">
    <div class="diary-nav">
      <button class="diary-back-btn" onclick="closeDiarySub()">â®</button>
      <div class="diary-nav-title" style="color:#ffb7b2">ç§å¯†æ—¥è®°</div>
      <div style="width:36px"></div>
    </div>
    <div class="diary-scroll-area">
      <button class="cute-btn" onclick="openWriteModal()">âœï¸ å†™ä¸€ç¯‡æ–°æ—¥è®°</button>
      <div id="diary-list-user"></div>
    </div>
  </div>

  <!-- å­é¡µé¢ï¼šAI æ—¥è®° -->
  <div class="diary-sub-page" id="dsp-ai" style="display:none; flex-direction:column; height:100%; background:#fff9f9;">
    <div class="diary-nav">
      <button class="diary-back-btn" style="border-color:#a2d2ff; color:#a2d2ff" onclick="closeDiarySub()">â®</button>
      <div class="diary-nav-title" style="color:#a2d2ff">è§‚å¯Ÿæ—¥è®°</div>
      <div style="width:36px"></div>
    </div>
    <div class="diary-scroll-area">
      <div class="f-item">
        <label class="f-lbl">é€‰æ‹©è§‚å¯Ÿå¯¹è±¡</label>
        <select id="ai-diary-sel" class="f-sel" onchange="renderAiDiaryList()"></select>
      </div>
      <button class="cute-btn blue" onclick="generateAiDiary()">âœ¨ ç”Ÿæˆä»Šæ—¥è§‚å¯Ÿ</button>
      <div id="diary-list-ai"></div>
    </div>
  </div>

  <!-- å­é¡µé¢ï¼šäº¤æ¢æ—¥è®° -->
  <div class="diary-sub-page" id="dsp-ex" style="display:none; flex-direction:column; height:100%; background:#fff9f9;">
    <div class="diary-nav">
      <button class="diary-back-btn" style="border-color:#cdb4db; color:#cdb4db" onclick="closeDiarySub()">â®</button>
      <div class="diary-nav-title" style="color:#cdb4db">äº¤æ¢æ—¥è®°</div>
      <div style="width:36px"></div>
    </div>
    <div class="diary-scroll-area">
      <div class="f-item">
        <label class="f-lbl">é€‰æ‹©äº¤æ¢å¯¹è±¡</label>
        <select id="ex-diary-sel" class="f-sel"></select>
      </div>
      <div style="background:#fff;padding:20px;border-radius:16px;margin-bottom:20px;border:1px dashed #cdb4db;color:#888;font-size:13px;line-height:1.6">
        <span style="color:#cdb4db;font-weight:bold">HOW TO PLAY</span><br>
        1. ç³»ç»Ÿä¼šæå–ä½ æœ€è¿‘çš„ä¸€ç¯‡æ—¥è®°ã€‚<br>
        2. AI ä¼šé˜…è¯»å¹¶å†™ä¸‹å®ƒçš„æ„Ÿæƒ³ã€‚<br>
        3. æœ€ç»ˆç”Ÿæˆä¸€ç¯‡åŒäººæ—¥è®°ã€‚
      </div>
      <button class="cute-btn purple" onclick="startExchangeDiary()">ğŸ’Œ å¼€å§‹äº¤æ¢</button>
    </div>
  </div>

  <!-- âœï¸ å†™æ—¥è®°å…¨å±å¼¹çª— -->
  <div class="paper-modal" id="write-modal">
    <div class="diary-nav">
      <button class="diary-close-btn" style="font-size:16px;color:#999" onclick="closeWriteModal()">å–æ¶ˆ</button>
      <div class="diary-nav-title">è®°å½•å¿ƒæƒ…</div>
      <button class="diary-close-btn" style="font-size:16px;color:#ffb7b2" onclick="saveNewDiary()">å®Œæˆ</button>
    </div>
    <textarea id="wm-content" class="paper-area" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆ..."></textarea>
  </div>
</div>

<!-- ğŸ”® å¡”ç½—å åœ (å®Œç¾å¯¼èˆªæ ç‰ˆ) -->
<div class="app-win" id="win-tarot">
  <div class="nav">
    <!-- 1. å…³é—­æŒ‰é’® (é»˜è®¤æ˜¾ç¤º) -->
    <button id="tarot-close-btn" class="nav-btn" onclick="closeApp('tarot')">âœ•</button>
    
    <!-- 2. è¿”å›æŒ‰é’® (é»˜è®¤éšè—ï¼Œä½ç½®å’Œå…³é—­æŒ‰é’®ä¸€æ ·) -->
    <button id="tarot-back-btn" class="nav-btn" style="display:none; color:#8e24aa; font-weight:bold" onclick="resetTarot()">â®</button>
    
    <span class="nav-t" style="color:#8e24aa">ç¥ç§˜å¡”ç½—</span>
    <button class="nav-btn" onclick="showTarotHistory()">ğŸ“œ</button>
  </div>
  
  <div class="tarot-container">
    
    <!-- 1. æé—®ç•Œé¢ -->
    <div id="tarot-view-1" class="tarot-step-1">
      <div class="tarot-big-icon">ğŸ”®</div>
      <div style="text-align:center;color:#6a1b9a;font-weight:bold">å¿ƒä¸­é»˜å¿µä½ çš„é—®é¢˜</div>
      <input id="tarot-input-q" class="f-in" style="text-align:center;border:2px solid #e1bee7" placeholder="ä¾‹å¦‚ï¼šæœ€è¿‘çš„è¿åŠ¿å¦‚ä½•ï¼Ÿ">
      <button class="btn btn-blue" style="background:#ab47bc;width:80%;box-shadow:0 4px 10px rgba(171, 71, 188, 0.4)" onclick="startTarotSession()">å¼€å§‹æ´—ç‰Œ</button>
    </div>

    <!-- 2. æŠ½ç‰Œç•Œé¢ -->
    <div id="tarot-view-2" class="tarot-step-2">
      <div style="text-align:center;padding:10px;color:#6a1b9a;font-weight:bold" id="tarot-instruction">è¯·å‡­ç›´è§‰æŠ½å– 3 å¼ ç‰Œ</div>
      <div class="tarot-deck-area" id="tarot-deck"></div>
      <div class="tarot-slots" id="tarot-slots">
        <div class="tarot-slot">1</div>
        <div class="tarot-slot">2</div>
        <div class="tarot-slot">3</div>
      </div>
    </div>

    <!-- 3. è§£è¯»/å†å²ç•Œé¢ -->
    <div id="tarot-view-3" class="tarot-step-3">
      <div id="tarot-result-header" style="padding-bottom:10px;border-bottom:1px dashed #ccc"></div>
      <div id="tarot-result-content" class="tarot-result-box"></div>
      <button id="tarot-ai-btn" class="btn btn-blue btn-block" style="margin-top:10px;background:#8e24aa" onclick="requestTarotAI()">âœ¨ å¬å”¤ AI è§£è¯»</button>
      <button class="btn btn-gray btn-block" style="margin-top:10px" onclick="resetTarot()">ğŸ”„ æ–°çš„å åœ</button>
    </div>

  </div>
</div>
<!-- ç”¨æˆ· (å¤šäººè®¾å‡çº§ç‰ˆ) -->
<div class="app-win" id="win-user">
  <div class="nav">
    <button class="nav-btn" onclick="closeApp('user')">âœ•</button>
    <span class="nav-t">æˆ‘çš„æ¡£æ¡ˆ</span>
    <div style="width:40px"></div>
  </div>
  
  <div class="scroll-content" style="background:#f9f9f9">
    <!-- 1. å½“å‰ç¼–è¾‘åŒºåŸŸ -->
    <div style="background:#fff;padding:20px;border-radius:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);margin-bottom:20px">
        <div style="text-align:center;margin-bottom:20px">
          <img id="u-av-preview" src="https://via.placeholder.com/100" style="width:100px;height:100px;border-radius:50%;border:4px solid #fff0f5;box-shadow:0 5px 15px rgba(255, 182, 193, 0.4);object-fit:cover">
        </div>
        
        <div class="f-item">
          <label class="f-lbl">å¤´åƒé“¾æ¥ (URL)</label>
          <input id="u-av-url" class="f-in" placeholder="ç²˜è´´å›¾ç‰‡é“¾æ¥..." oninput="document.getElementById('u-av-preview').src=this.value">
        </div>

        <div class="f-item"><label class="f-lbl">æ˜µç§°</label><input id="u-name" class="f-in"></div>
        <div class="f-item"><label class="f-lbl">äººè®¾/å¤‡æ³¨</label><textarea id="u-desc" class="f-area" style="height:80px" placeholder="ä¾‹å¦‚ï¼š18å²çš„é«˜ä¸­ç”Ÿï¼Œæ€§æ ¼å‚²å¨‡..."></textarea></div>
        
        <div style="display:flex;gap:10px">
            <button class="btn btn-blue" style="flex:1" onclick="saveUser()">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
            <button class="btn btn-gray" style="flex:1;background:#fff0f5;color:#ff8fab;border:1px solid #ffb7b2" onclick="saveAsNewProfile()">â• å­˜ä¸ºæ–°é©¬ç”²</button>
        </div>
    </div>

    <!-- 2. é©¬ç”²åˆ—è¡¨åŒºåŸŸ -->
    <div style="padding:0 5px">
        <div style="font-size:14px;font-weight:bold;color:#999;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
            <span>ğŸ­ æˆ‘çš„é©¬ç”²åº“</span>
            <span style="font-size:10px;font-weight:normal">ç‚¹å‡»åˆ‡æ¢</span>
        </div>
        <div id="user-profiles-list">
            <!-- åˆ—è¡¨ä¼šæ¸²æŸ“åœ¨è¿™é‡Œ -->
        </div>
    </div>
  </div>
</div>


  <div class="scroll-content">
    <div style="text-align:center;margin:20px 0">
      <img id="u-av" src="https://via.placeholder.com/100" style="width:100px;height:100px;border-radius:50%;border:3px solid #fff;box-shadow:0 5px 15px rgba(0,0,0,0.1)">
    </div>
    <div class="f-item"><label class="f-lbl">æ˜µç§°</label><input id="u-name" class="f-in"></div>
    <div class="f-item"><label class="f-lbl">äººè®¾/å¤‡æ³¨</label><textarea id="u-desc" class="f-area" style="height:100px"></textarea></div>
    <button class="btn btn-blue btn-block" onclick="saveUser()">ä¿å­˜</button>
  </div>
</div>

<!-- é€šç”¨å¼¹çª— -->
<div class="modal-mask" id="md-root">
  <div class="modal-box">
    <div class="modal-h"><span id="md-t">æ ‡é¢˜</span><span onclick="closeMd()">âœ•</span></div>
    <div class="modal-b" id="md-b"></div>
  </div>
</div>

<!-- ğŸŒ¸ ä¸“ç”¨è¾“å…¥å¼¹çª— -->
<div class="modal-mask" id="input-modal">
  <div class="input-modal-box">
    <div class="im-title" id="im-title">è¾“å…¥å†…å®¹</div>
    <input class="im-input" id="im-val" placeholder="">
    <div class="im-btns">
      <button class="btn btn-gray" style="flex:1" onclick="closeInputModal()">å–æ¶ˆ</button>
      <button class="btn btn-blue" style="flex:1" onclick="confirmInputModal()">ç¡®å®š</button>
    </div>
  </div>
</div>

<!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
<input type="file" id="file-in" class="hide">
<input type="file" id="file-import" class="hide">
<input type="file" id="file-preset" class="hide">
<input type="file" id="file-world" class="hide">

<script>
/* --- 1. æ ¸å¿ƒæ•°æ®ä¸å·¥å…· --- */
var db = {
  user: { name: "æˆ‘", avatar: "", desc: "æ™®é€šç”¨æˆ·", balance: 2000.00, inventory: [] },
  contacts: [
    { id: "c1", name: "AIåŠ©æ‰‹", avatar: "", chat: [{role:"ai", content:"ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ã€‚", type:"text"}], thoughts: [], desc: "ä¸€ä¸ªä¹äºåŠ©äººçš„AI", maxReply: 1, translate: false, blocked: false, patMeSuffix: "", patAiSuffix: "", balance: 5000.00, chatBg: "", inventory: [], linkedWorldInfo: [], linkedPresetId: "" }
  ],
  diary: [], 
  ai_diary: [], 
  theme: { bento: {}, voiceBg: "" }, 
  api: { 
    url: "", key: "", model: "gpt-3.5-turbo",
    temp: 0.7, top_k: 0, freq_pen: 0, pres_pen: 0 
  },
  world_info: [], 
  presetCollections: [], 
  activePresetId: ""
};

function init() {
  var saved = localStorage.getItem("ai_os_v13_0");
  if (saved) { 
    try { 
      var savedDb = JSON.parse(saved);
      db = { ...db, ...savedDb };
            // ğŸ”® åˆå§‹åŒ–å¡”ç½—å†å²
      if(!db.tarot_history) db.tarot_history = [];
            // ğŸ­ åˆå§‹åŒ–å¤šäººè®¾åˆ—è¡¨
      if(!db.user_profiles) db.user_profiles = [];
      if(!db.theme) db.theme = { bento: {}, voiceBg: "" };
      if(!db.theme.bento) db.theme.bento = {};
      if(db.theme.voiceBg === undefined) db.theme.voiceBg = "";
      if(!db.ai_diary) db.ai_diary = []; 
      if(!db.user.inventory) db.user.inventory = [];
      if(!db.world_info) db.world_info = [];
      
      if(savedDb.presets && Array.isArray(savedDb.presets) && savedDb.presets.length > 0) {
          if(!db.presetCollections) db.presetCollections = [];
          if(db.presetCollections.length === 0) {
              var defaultId = 'pc_' + Date.now();
              db.presetCollections.push({
                  id: defaultId,
                  name: "é»˜è®¤æ”¶è—é›† (æ—§ç‰ˆè¿ç§»)",
                  scripts: savedDb.presets
              });
              db.activePresetId = defaultId;
              delete db.presets; 
          }
      }
      if(!db.presetCollections) db.presetCollections = [];
      if(!db.activePresetId && db.presetCollections.length > 0) db.activePresetId = db.presetCollections[0].id;

      if(db.api.temp === undefined) db.api.temp = 0.7;
      if(db.api.top_k === undefined) db.api.top_k = 0;
      if(db.api.freq_pen === undefined) db.api.freq_pen = 0;
      if(db.api.pres_pen === undefined) db.api.pres_pen = 0;

      db.contacts.forEach(c => { 
        if(c.blocked === undefined) c.blocked = false; 
        if(c.balance === undefined) c.balance = 5000.00;
        if(c.chatBg === undefined) c.chatBg = "";
        if(c.maxReply === undefined) c.maxReply = 1;
        if(c.thoughts === undefined) c.thoughts = []; 
        if(!c.inventory) c.inventory = [];
        if(!c.linkedWorldInfo) c.linkedWorldInfo = []; 
        if(c.linkedPresets) delete c.linkedPresets; 
        if(!c.linkedPresetId) c.linkedPresetId = ""; 
        if(c.mode) delete c.mode; // ğŸ—‘ï¸ åˆ é™¤æ—§çš„ mode å­—æ®µ
      });
      if(db.user.balance === undefined) db.user.balance = 2000.00;
      db.diary.forEach(d => { if(d.isFav === undefined) d.isFav = false; });
      
      // ğŸ—‘ï¸ æ¸…ç†æ—§çš„æ­£åˆ™æ•°æ®
      if(db.regexScripts) delete db.regexScripts;

    } catch(e){ console.error("Load error", e); } 
  }
  
  setInterval(updateTime, 1000);
  updateTime();
  initBento();
}

function save() {
  try {
    localStorage.setItem("ai_os_v13_0", JSON.stringify(db));
    updateSysStatus();
  } catch(e) {
    console.error("Save failed", e);
    alert("ä¿å­˜å¤±è´¥ï¼å‚¨å­˜ç©ºé—´å·²æ»¡ã€‚\nè¯·å»ã€è®¾ç½®ã€‘é‡Œä½¿ç”¨â€œå‚¨å­˜ç©ºé—´å¤§ä¾¦æ¢â€æ¸…ç†ï¼");
  }
}

function updateSysStatus() {
  var usage = getStorageUsage();
  var el = getId('sys-status-text');
  if(el) el.innerText = "å·²ç”¨ " + usage + " KB";
}

// è®¡ç®—å¯¹è±¡å¤§å° (KB)
function getSize(obj) {
  return (JSON.stringify(obj).length * 2 / 1024).toFixed(2);
}

function getStorageUsage() {
  var total = 0;
  for(var x in localStorage) {
    if(localStorage.hasOwnProperty(x)) {
      total += localStorage[x].length * 2;
    }
  }
  return (total / 1024).toFixed(2);
}

function resetData() {
  if(confirm("âš ï¸ è­¦å‘Šï¼šè¿™å°†æ¸…ç©ºæ‰€æœ‰å¥½å‹ã€èŠå¤©è®°å½•å’Œè®¾ç½®ï¼ç¡®å®šè¦é‡ç½®å—ï¼Ÿ")) {
    localStorage.removeItem("ai_os_v13_0");
    location.reload();
  }
}

// ğŸ§¹ æ¸…ç†åŠŸèƒ½
function clearAllAvatars() {
  if(confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¥½å‹å’Œè‡ªå·±çš„å¤´åƒå—ï¼Ÿ(è¿™é€šå¸¸èƒ½é‡Šæ”¾å¤§é‡ç©ºé—´)")) {
    db.user.avatar = "";
    db.contacts.forEach(c => c.avatar = "");
    db.theme.bento.av = "";
    save();
    alert("å¤´åƒå·²æ¸…é™¤ï¼");
    openModal('settings'); // åˆ·æ–°æ˜¾ç¤º
  }
}

function clearAllChat() {
  if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ(å¥½å‹åˆ—è¡¨ä¼šä¿ç•™)")) {
    db.contacts.forEach(c => {
      c.chat = [{role:'ai', content: c.firstMsg || "ä½ å¥½ã€‚", type:'text'}];
      c.thoughts = [];
    });
    save();
    alert("èŠå¤©è®°å½•å·²æ¸…ç©ºï¼");
    openModal('settings');
  }
}

function clearTheme() {
  if(confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰èƒŒæ™¯å›¾å—ï¼Ÿ")) {
    db.theme = { bento: {}, voiceBg: "" };
    db.contacts.forEach(c => c.chatBg = "");
    save();
    alert("èƒŒæ™¯å›¾å·²é‡ç½®ï¼");
    openModal('settings');
  }
}

// ğŸ‘» åˆ é™¤å¹½çµæ•°æ®
function deleteStorageKey(key) {
  if(confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ•°æ®å—ï¼Ÿ\nKey: " + key)) {
    localStorage.removeItem(key);
    openModal('settings'); // åˆ·æ–°
  }
}

// ğŸ“¤ å¯¼å‡ºæ•°æ®
function exportData() {
  var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
  var downloadAnchorNode = document.createElement('a');
  downloadAnchorNode.setAttribute("href", dataStr);
  downloadAnchorNode.setAttribute("download", "ai_os_backup_" + Date.now() + ".json");
  document.body.appendChild(downloadAnchorNode);
  downloadAnchorNode.click();
  downloadAnchorNode.remove();
}

// ğŸ“¥ å¯¼å…¥æ•°æ®
function importData() {
  var input = getId('file-import');
  input.value = '';
  input.onchange = function(e) {
    var file = e.target.files[0];
    if(!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
      try {
        var json = JSON.parse(ev.target.result);
        if(confirm("ç¡®å®šè¦æ¢å¤å¤‡ä»½å—ï¼Ÿå½“å‰çš„æ‰€æœ‰æ•°æ®å°†è¢«è¦†ç›–ï¼")) {
          db = json;
          save();
          alert("æ¢å¤æˆåŠŸï¼å³å°†åˆ·æ–°é¡µé¢...");
          location.reload();
        }
      } catch(err) {
        alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯");
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function getId(id) { return document.getElementById(id); }

function updateTime() {
  var d = new Date();
  var t = ('0'+d.getHours()).slice(-2) + ":" + ('0'+d.getMinutes()).slice(-2);
  getId('sb-time').innerText = t;
  getId('ls-time').innerText = t;
  var m = d.getMonth()+1, dd = d.getDate();
  var w = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][d.getDay()];
  getId('tt-full').innerText = m + "æœˆ" + dd + "æ—¥ " + w + " " + t;
}

/* --- 2. æ ¸å¿ƒåŠŸèƒ½é€»è¾‘ --- */
function openApp(id) {
  var win = getId('win-' + id);
  if (win) {
    win.classList.add('show');
    if(id === 'qq') renderContactList();
    if(id === 'diary') { updateDiarySelects(); }
    if(id === 'user') loadUser();
    if(id === 'worldinfo') renderWorldInfo();
    if(id === 'presets') renderPresetCollections();
    
    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ å…³é”®å°±æ˜¯ç¼ºäº†è¿™ä¸€è¡Œï¼åŠ ä¸Šå®ƒå°±å¥½å•¦ï¼ ğŸ‘‡ğŸ‘‡ğŸ‘‡
    if(id === 'clock') initClockApp(); 
    
  } else {
    alert("åŠŸèƒ½å¼€å‘ä¸­...");
  }
}


function closeApp(id) {
  var win = getId('win-' + id);
  if (win) win.classList.remove('show');
}

// å¼¹çª—é€»è¾‘
function openModal(type) {
  var root = getId('md-root');
  var title = getId('md-t');
  var body = getId('md-b');
  root.classList.add('show');
  
  if (type === 'settings') {
    title.innerText = "å…¨å±€è®¾ç½®";
    var totalUsage = getStorageUsage();
    var color = totalUsage > 4500 ? 'red' : 'green';
    
    // åˆ†æå…·ä½“å ç”¨ (å½“å‰ç³»ç»Ÿ)
    var userSize = getSize(db.user);
    var themeSize = getSize(db.theme);
    var diarySize = getSize(db.diary) + getSize(db.ai_diary);
    var contactsHtml = "";
    
    db.contacts.forEach(c => {
        var cSize = getSize(c);
        var warn = cSize > 500 ? 'color:red;font-weight:bold' : '';
        contactsHtml += `
          <div class="storage-row">
            <span class="storage-name" style="${warn}">ğŸ‘¤ ${c.name}</span>
            <div>
              <span class="storage-size">${cSize} KB</span>
            </div>
          </div>
        `;
    });

    // ğŸ‘» æ‰«æå¹½çµæ–‡ä»¶
    var ghostHtml = "";
    var ghostCount = 0;
    for (var i = 0; i < localStorage.length; i++) {
        var key = localStorage.key(i);
        if (key !== "ai_os_v13_0") {
            var val = localStorage.getItem(key);
            var size = (val.length * 2 / 1024).toFixed(2);
            ghostHtml += `
              <div class="storage-row" style="background:#fff0f0">
                <span class="storage-name" style="color:#d63031">ğŸ‘» ${key}</span>
                <div>
                  <span class="storage-size">${size} KB</span>
                  <button class="storage-btn storage-btn-del" onclick="deleteStorageKey('${key}')">åˆ é™¤</button>
                </div>
              </div>
            `;
            ghostCount++;
        }
    }
    if(ghostCount === 0) ghostHtml = "<div style='font-size:12px;color:#999;text-align:center;padding:10px'>æ²¡æœ‰å‘ç°å¹½çµæ–‡ä»¶ï¼ŒçœŸæ£’ï¼âœ¨</div>";

    body.innerHTML = `
      <div style="font-weight:bold;margin-bottom:10px;color:#333">ğŸ”Œ API è®¾ç½®</div>
      <div class="f-item"><label class="f-lbl">API URL</label><input id="api-url" class="f-in" value="${db.api.url}"></div>
      <div class="f-item"><label class="f-lbl">API Key</label><input id="api-key" class="f-in" type="password" value="${db.api.key}"></div>
      <div class="f-item">
        <label class="f-lbl">Model</label>
        <div style="display:flex;gap:5px">
          <input id="api-model" class="f-in" value="${db.api.model}" list="model-list">
          <button class="btn btn-gray" onclick="fetchModels()">ğŸ”</button>
        </div>
        <datalist id="model-list"></datalist>
      </div>

      <div style="background:#f9f9f9;padding:10px;border-radius:10px;margin-bottom:15px">
        <div style="font-weight:bold;margin-bottom:10px;color:#d87093">ğŸ›ï¸ é«˜çº§ç”Ÿæˆè®¾ç½®</div>
        <div class="f-item">
          <label class="f-lbl">Temperature (æ¸©åº¦): <span id="val-temp">${db.api.temp}</span></label>
          <div class="f-range-wrap"><input type="range" class="f-range" min="0" max="2" step="0.1" value="${db.api.temp}" oninput="getId('val-temp').innerText=this.value;db.api.temp=parseFloat(this.value)"></div>
        </div>
        <div class="f-item">
          <label class="f-lbl">Top K: <span id="val-topk">${db.api.top_k}</span></label>
          <div class="f-range-wrap"><input type="range" class="f-range" min="0" max="100" step="1" value="${db.api.top_k}" oninput="getId('val-topk').innerText=this.value;db.api.top_k=parseInt(this.value)"></div>
        </div>
        <div class="f-item">
          <label class="f-lbl">Frequency Penalty (é¢‘ç‡æƒ©ç½š): <span id="val-freq">${db.api.freq_pen}</span></label>
          <div class="f-range-wrap"><input type="range" class="f-range" min="-2" max="2" step="0.1" value="${db.api.freq_pen}" oninput="getId('val-freq').innerText=this.value;db.api.freq_pen=parseFloat(this.value)"></div>
        </div>
        <div class="f-item">
          <label class="f-lbl">Presence Penalty (å­˜åœ¨æƒ©ç½š): <span id="val-pres">${db.api.pres_pen}</span></label>
          <div class="f-range-wrap"><input type="range" class="f-range" min="-2" max="2" step="0.1" value="${db.api.pres_pen}" oninput="getId('val-pres').innerText=this.value;db.api.pres_pen=parseFloat(this.value)"></div>
        </div>
      </div>

      <button class="btn btn-blue btn-block" onclick="saveApi()">ä¿å­˜ API & è®¾ç½®</button>
      
      <div style="margin-top:20px;border-top:1px solid #eee;padding-top:15px">
        <div style="font-weight:bold;margin-bottom:10px;color:#333">ğŸ“¦ å¤‡ä»½ä¸æ¢å¤</div>
        <div style="display:flex;gap:10px">
          <button class="btn btn-blue" style="flex:1" onclick="exportData()">ğŸ“¤ å¯¼å‡ºå¤‡ä»½</button>
          <button class="btn btn-gray" style="flex:1" onclick="importData()">ğŸ“¥ æ¢å¤å¤‡ä»½</button>
        </div>
      </div>

      <div style="margin-top:30px;border-top:1px solid #eee;padding-top:20px">
        <div style="font-weight:bold;margin-bottom:10px;color:#ff4d4f">ğŸ•µï¸â€â™€ï¸ å‚¨å­˜ç©ºé—´å¤§ä¾¦æ¢</div>
        <div style="font-size:14px;margin-bottom:15px;background:#f9f9f9;padding:10px;border-radius:8px">
          æ€»å ç”¨: <span style="color:${color};font-weight:bold;font-size:18px">${totalUsage} KB</span> / 5000 KB
        </div>
        
        <div style="font-size:12px;color:#999;margin-bottom:5px">ğŸ‘‡ å½“å‰ç³»ç»Ÿæ•°æ®</div>
        <div class="storage-row">
          <span class="storage-name">ğŸ‘¤ æˆ‘çš„èµ„æ–™(å«å¤´åƒ)</span>
          <div><span class="storage-size">${userSize} KB</span></div>
        </div>
        <div class="storage-row">
          <span class="storage-name">ğŸ“” æ‰€æœ‰æ—¥è®°</span>
          <div><span class="storage-size">${diarySize} KB</span></div>
        </div>
        <div class="storage-row">
          <span class="storage-name">ğŸ–¼ï¸ ä¸»é¢˜/èƒŒæ™¯å›¾</span>
          <div><span class="storage-size">${themeSize} KB</span><button class="storage-btn" onclick="clearTheme()">é‡ç½®</button></div>
        </div>
        <div style="max-height:100px;overflow-y:auto;border:1px solid #eee;border-radius:8px;padding:0 10px;margin:10px 0">
          ${contactsHtml}
        </div>

        <div style="font-size:12px;color:#ff4d4f;margin-top:15px;margin-bottom:5px;font-weight:bold">ğŸ‘» å‘ç°å¹½çµæ–‡ä»¶ (ä¸å±äºæœ¬ç³»ç»Ÿ)</div>
        <div style="max-height:150px;overflow-y:auto;border:1px solid #ffcccc;border-radius:8px;padding:0 10px;margin-bottom:15px">
          ${ghostHtml}
        </div>

        <div style="display:flex;gap:10px;margin-top:15px">
           <button class="btn btn-red" style="flex:1;font-size:12px" onclick="clearAllAvatars()">ğŸ§¹ æ¸…é™¤æ‰€æœ‰å¤´åƒ</button>
           <button class="btn btn-red" style="flex:1;font-size:12px" onclick="clearAllChat()">ğŸ’¬ æ¸…ç©ºèŠå¤©è®°å½•</button>
        </div>
        <button class="btn btn-gray btn-block" style="margin-top:10px" onclick="resetData()">ğŸ—‘ï¸ å½»åº•é‡ç½®æ‰€æœ‰æ•°æ®</button>
      </div>
    `;
  }
}
function closeMd() { 
    var root = getId('md-root');
    root.classList.remove('show');
    
    // âœ¨ å…³é”®ï¼šå…³é—­æ—¶æ¸…ç©ºå†…å®¹ï¼Œé˜²æ­¢ä¸‹æ¬¡æ‰“å¼€æ—¶ç¬é—´æ˜¾ç¤ºæ—§å†…å®¹
    // å»¶è¿Ÿä¸€ç‚¹ç‚¹æ¸…ç©ºï¼Œè®©å…³é—­åŠ¨ç”»æ’­å®Œ
    setTimeout(() => {
        getId('md-b').innerHTML = "";
    }, 200);
}


function saveApi() {
  db.api.url = getId('api-url').value;
  db.api.key = getId('api-key').value;
  db.api.model = getId('api-model').value;
  // Sliders update db.api directly via oninput
  save();
  closeMd();
  alert("API & è®¾ç½®å·²ä¿å­˜");
}

async function fetchModels() {
  if(!getId('api-key').value) return alert("è¯·å…ˆå¡« Key");
  var url = getId('api-url').value.replace(/\/$/, "");
  if(url.indexOf("/v1") === -1) url += "/v1";
  try {
    var res = await fetch(url + "/models", { headers: { "Authorization": "Bearer " + getId('api-key').value } });
    var data = await res.json();
    var list = getId('model-list');
    list.innerHTML = "";
    if(data.data) {
      data.data.forEach(m => { var opt = document.createElement('option'); opt.value = m.id; list.appendChild(opt); });
      alert("å·²è·å– " + data.data.length + " ä¸ªæ¨¡å‹");
    }
  } catch(e) { alert("è¿æ¥é”™è¯¯: " + e.message); }
}

/* --- 3. Bento æ¡Œé¢é€»è¾‘ --- */
function initBento() {
  var b = db.theme.bento;
  // Page 1
  if(b.av) getId('bc-av').src = b.av;
  if(b.sch) getId('bc-sch').innerText = b.sch;
  if(b.txt) getId('bc-txt').innerText = b.txt;
  
  // Page 2 (New)
  if(b.p2_av) getId('bc-p2-av').src = b.p2_av;
  if(b.p2_pill) getId('bc-p2-pill').innerText = b.p2_pill;
  if(b.p2_txt) getId('bc-p2-txt').innerText = b.p2_txt;

  ['p1-tl', 'p1-br', 'p2-tl', 'p2-br'].forEach(id => {
    if(b['img_'+id]) {
      var el = getId('img-'+id);
      if(el) el.style.backgroundImage = 'url('+b['img_'+id]+')';
    }
  });
}

function upBento(key) {
  var url = prompt("è¾“å…¥å›¾ç‰‡ URL (ç•™ç©ºæ¸…é™¤):");
  if(url === null) return;
  
  if(key === 'av') {
    db.theme.bento.av = url;
    getId('bc-av').src = url || "https://via.placeholder.com/100";
  } else if(key === 'p2-av') {
    db.theme.bento.p2_av = url;
    getId('bc-p2-av').src = url || "https://via.placeholder.com/100";
  } else {
    db.theme.bento['img_'+key] = url;
    var el = getId('img-'+key);
    if(url) el.style.backgroundImage = 'url('+url+')';
    else el.style.backgroundImage = '';
  }
  save();
}

function editBento(key) {
  var val = prompt("è¾“å…¥æ–‡å­—:");
  if(val) {
    if(key === 'p2-pill') db.theme.bento.p2_pill = val;
    else if(key === 'p2-txt') db.theme.bento.p2_txt = val;
    else db.theme.bento[key] = val;
    
    getId('bc-'+key).innerText = val;
    save();
  }
}

/* --- 4. QQ èŠå¤©é€»è¾‘ --- */
var curCid = null;
var curQuote = null;
var menuTargetIdx = -1;
var inputCallback = null;

function renderContactList() {
  var html = '';
  db.contacts.forEach(c => {
    // è·å–æœ€åä¸€æ¡æ¶ˆæ¯é¢„è§ˆ
    var lastMsg = 'æš‚æ— æ¶ˆæ¯';
    if (c.chat.length > 0) {
        var m = c.chat[c.chat.length - 1];
        if (m.type === 'text') lastMsg = m.content;
        else if (m.type === 'image') lastMsg = '[å›¾ç‰‡]';
        else if (m.type === 'voice_call') lastMsg = '[è¯­éŸ³é€šè¯]';
        else lastMsg = '[' + m.type + ']';
    }

    // ğŸ”¥ å¼ºåˆ¶æ ·å¼ï¼šwidth: 100% ç¡®ä¿å æ»¡ä¸€è¡Œï¼Œé˜²æ­¢å¹¶æ’
    html += `<div style="width:100%; display:flex; align-items:center; padding:15px; border-bottom:1px solid #f5f5f5; background:#fff; box-sizing:border-box; cursor:pointer;" onclick="enterChat('${c.id}')">
      
      <!-- å¤´åƒ -->
      <img src="${c.avatar||'https://via.placeholder.com/40'}" style="width:48px; height:48px; border-radius:50%; margin-right:12px; border:1px solid #eee; flex-shrink:0; object-fit:cover;">
      
      <!-- æ–‡å­—åŒºåŸŸ (flex:1 è‡ªåŠ¨æ’‘å¼€) -->
      <div style="flex:1; min-width:0; display:flex; flex-direction:column; align-items:flex-start;">
        <div style="font-weight:600; font-size:16px; color:#333; width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-align:left;">
            ${c.remark || c.name}
        </div>
        <div style="font-size:13px; color:#999; margin-top:4px; width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-align:left;">
            ${lastMsg}
        </div>
      </div>
      
    </div>`;
  });
  
  var listEl = getId('ct-list');
  if(listEl) listEl.innerHTML = html;
}

function toggleTopMenu() {
  var menu = getId('top-menu');
  menu.classList.toggle('show');
  if(menu.classList.contains('show')) {
    setTimeout(() => { document.addEventListener('click', closeTopMenuOutside); }, 0);
  }
}

function closeTopMenuOutside(e) {
  var menu = getId('top-menu');
  if(!e.target.closest('.top-pop-menu') && !e.target.closest('.nav-btn')) {
    menu.classList.remove('show');
    document.removeEventListener('click', closeTopMenuOutside);
  }
}

function addContact() {
  var name = prompt("è¾“å…¥å¥½å‹åå­—:");
  if(name) {
    try {
      db.contacts.push({ id: 'c'+Date.now(), name: name, avatar: '', chat: [], thoughts: [], maxReply: 1, blocked: false, balance: 5000.00, chatBg: "", linkedWorldInfo: [], linkedPresetId: "" });
      save();
      renderContactList();
    } catch(e) {
      alert("æ·»åŠ å¤±è´¥ï¼Œå­˜å‚¨ç©ºé—´å·²æ»¡ã€‚è¯·åˆ é™¤ä¸€äº›æ—§æ•°æ®ã€‚");
    }
  }
}

function importSillyTavern() {
  var input = getId('file-in');
  input.value = '';
  input.onchange = function(e) {
    var file = e.target.files[0];
    if(!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
      try {
        var json = JSON.parse(ev.target.result);
        var data = json.data || json; 
        var name = data.name || data.char_name || "æœªçŸ¥è§’è‰²";
        var fullDesc = "";
        if(data.description) fullDesc += "[è§’è‰²æè¿°]\n" + data.description + "\n\n";
        if(data.personality) fullDesc += "[æ€§æ ¼ç‰¹å¾]\n" + data.personality + "\n\n";
        if(data.scenario) fullDesc += "[å½“å‰åœºæ™¯]\n" + data.scenario + "\n\n";
        if(data.mes_example) fullDesc += "[å¯¹è¯ç¤ºä¾‹]\n" + data.mes_example + "\n\n";
        if(data.system_prompt) fullDesc += "[ç³»ç»ŸæŒ‡ä»¤]\n" + data.system_prompt;
        if(!fullDesc.trim()) fullDesc = (data.description || "") + "\n" + (data.personality || "");
        var first = data.first_mes || "ä½ å¥½ã€‚";
        db.contacts.push({
          id: 'c'+Date.now(),
          name: name,
          avatar: "", 
          desc: fullDesc, 
          firstMsg: first,
          chat: [{role:'ai', content: first, type:'text'}],
          thoughts: [],
          maxReply: 1,
          blocked: false,
          balance: 5000.00,
          chatBg: "",
          linkedWorldInfo: [],
          linkedPresetId: ""
        });
        save();
        renderContactList();
        alert("âœ… å¯¼å…¥æˆåŠŸ: " + name);
      } catch(err) {
        console.error(err);
        alert("å¯¼å…¥å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–å­˜å‚¨ç©ºé—´å·²æ»¡ã€‚");
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

/* ğŸ§  é¢„è®¾ (è„šæœ¬) é€»è¾‘ - åˆ†ç»„é‡æ„ç‰ˆ */
function createPresetCollection() {
  var name = prompt("è¯·è¾“å…¥æ–°é¢„è®¾åŒ…åç§°:");
  if(name) {
    var id = 'pc_' + Date.now();
    db.presetCollections.push({ id: id, name: name, scripts: [] });
    if(!db.activePresetId) db.activePresetId = id;
    save();
    renderPresetCollections();
  }
}

function importPreset() {
  var input = getId('file-preset');
  input.value = '';
  input.onchange = function(e) {
    var file = e.target.files[0];
    if(!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
      try {
        var json = JSON.parse(ev.target.result);
        var scripts = [];
        
        if(json.temperature !== undefined) db.api.temp = json.temperature;
        if(json.top_k !== undefined) db.api.top_k = json.top_k;

        if (json.prompts && Array.isArray(json.prompts)) {
            json.prompts.forEach(p => {
                scripts.push({
                    name: p.name || p.identifier || "æœªå‘½å",
                    content: p.content || "",
                    role: p.role || "system",
                    enabled: p.enabled !== false,
                    depth: p.injection_depth || 0,
                    trigger: "normal",
                    position: p.injection_position === 1 ? "after_char" : "at_depth"
                });
            });
        } else if (json.scripts && Array.isArray(json.scripts)) {
             json.scripts.forEach(s => {
                 scripts.push({
                     name: s.name,
                     content: s.content,
                     role: "system",
                     enabled: true,
                     depth: 0,
                     trigger: "normal",
                     position: "at_depth"
                 });
             });
        }

        if(scripts.length > 0) {
            var id = 'pc_' + Date.now();
            var name = file.name.replace('.json', '');
            db.presetCollections.push({ id: id, name: name, scripts: scripts });
            if(!db.activePresetId) db.activePresetId = id;
            save();
            renderPresetCollections();
            alert(`âœ… æˆåŠŸå¯¼å…¥é¢„è®¾åŒ…: ${name} (${scripts.length} ä¸ªè„šæœ¬)`);
        } else {
            alert("âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆçš„é¢„è®¾å†…å®¹");
        }

      } catch(err) { alert("å¯¼å…¥å¤±è´¥: " + err.message); }
    };
    reader.readAsText(file);
  };
  input.click();
}

function renderPresetCollections() {
  var html = '';
  db.presetCollections.forEach((pc, idx) => {
    var isActive = db.activePresetId === pc.id;
    html += `<div class="preset-group-item" onclick="openPresetDetail('${pc.id}')">
      <div class="pg-name">${pc.name}</div>
      <div style="display:flex;gap:10px;align-items:center">
        <button class="btn btn-gray" style="padding:0 8px;height:24px;font-size:12px" onclick="event.stopPropagation();deletePresetCollection('${pc.id}')">ğŸ—‘ï¸</button>
        <div class="pg-radio ${isActive?'active':''}" onclick="event.stopPropagation();setActivePreset('${pc.id}')"></div>
      </div>
    </div>`;
  });
  getId('preset-collections-list').innerHTML = html || '<div style="text-align:center;color:#999;margin-top:20px">æš‚æ— é¢„è®¾åŒ…ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’æ·»åŠ </div>';
}

function deletePresetCollection(id) {
  if(confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢„è®¾åŒ…å—ï¼Ÿ")) {
    db.presetCollections = db.presetCollections.filter(pc => pc.id !== id);
    if(db.activePresetId === id) db.activePresetId = "";
    save();
    renderPresetCollections();
  }
}

function setActivePreset(id) {
  db.activePresetId = id;
  save();
  renderPresetCollections();
}

var currentPcId = null;
function openPresetDetail(id) {
  currentPcId = id;
  var pc = db.presetCollections.find(x => x.id === id);
  getId('win-preset-detail').classList.add('show');
  getId('pd-title').innerText = pc.name;
  renderPresetScripts();
}

function closePresetDetail() {
  getId('win-preset-detail').classList.remove('show');
  currentPcId = null;
}

// æ‹–æ‹½æ’åºé€»è¾‘
let dragSrcEl = null;

function handleDragStart(e) {
  dragSrcEl = this;
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/html', this.innerHTML);
  this.classList.add('dragging');
}

function handleDragOver(e) {
  if (e.preventDefault) e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleDrop(e) {
  if (e.stopPropagation) e.stopPropagation();
  if (dragSrcEl !== this) {
    var srcIdx = parseInt(dragSrcEl.dataset.index);
    var targetIdx = parseInt(this.dataset.index);
    
    var pc = db.presetCollections.find(x => x.id === currentPcId);
    var item = pc.scripts.splice(srcIdx, 1)[0];
    pc.scripts.splice(targetIdx, 0, item);
    save();
    renderPresetScripts();
  }
  return false;
}

function handleDragEnd(e) {
  this.classList.remove('dragging');
}

function renderPresetScripts() {
  if(!currentPcId) return;
  var pc = db.presetCollections.find(x => x.id === currentPcId);
  var html = '';
  pc.scripts.forEach((p, idx) => {
    var icon = 'ğŸ“';
    if(p.name.includes('Wake') || p.name.includes('å”¤é†’')) icon = 'â­ï¸';
    else if(p.name.includes('Info') || p.name.includes('ä¿¡æ¯')) icon = 'ğŸ¥ƒ';
    else if(p.name.includes('Chat') || p.name.includes('History')) icon = 'ğŸ“Œ';
    else if(p.name.includes('NPD')) icon = 'ğŸ›¡ï¸';
    
    var tokenCount = p.content && p.content.length > 0 ? Math.floor(p.content.length / 2.5) : "-"; 

    html += `<div class="st-list-item" draggable="true" data-index="${idx}">
      <div class="st-li-left">
        <div class="st-li-drag">â‰¡</div>
        <div class="st-li-icon">${icon}</div>
        <div class="st-li-name">${p.name}</div>
      </div>
      <div class="st-li-right">
        <div class="st-li-edit" onclick="editPresetScript(${idx})">âœ</div>
        <label class="st-switch">
          <input type="checkbox" ${p.enabled?'checked':''} onchange="togglePresetScript(${idx})">
          <span class="st-slider"></span>
        </label>
        <div class="st-li-token">${tokenCount}</div>
      </div>
    </div>`;
  });
  getId('preset-scripts-list').innerHTML = html || '<div style="text-align:center;color:#999;margin-top:20px">æš‚æ— è„šæœ¬</div>';
  
  // Add drag listeners
  var items = document.querySelectorAll('.st-list-item');
  items.forEach(item => {
    item.addEventListener('dragstart', handleDragStart, false);
    item.addEventListener('dragover', handleDragOver, false);
    item.addEventListener('drop', handleDrop, false);
    item.addEventListener('dragend', handleDragEnd, false);
  });
}

function addPresetScript() {
  if(!currentPcId) return;
  var pc = db.presetCollections.find(x => x.id === currentPcId);
  pc.scripts.push({ name: "æ–°è„šæœ¬", content: "", enabled: true, depth: 0, role: "system", trigger: "normal", position: "at_depth" });
  save();
  renderPresetScripts();
}

// âš¡ï¸ ä¿®å¤é—ªçƒï¼šåªæ›´æ–°æ•°æ®ï¼Œä¸é‡ç»˜
function togglePresetScript(idx) {
  var pc = db.presetCollections.find(x => x.id === currentPcId);
  pc.scripts[idx].enabled = !pc.scripts[idx].enabled;
  save();
  // ä¸è°ƒç”¨ renderPresetScripts()ï¼Œé¿å…é‡ç»˜å¯¼è‡´çš„é—ªçƒ
}

var currentScriptIdx = -1;
function editPresetScript(idx) {
  currentScriptIdx = idx;
  var pc = db.presetCollections.find(x => x.id === currentPcId);
  var p = pc.scripts[idx];
  getId('pe-name').value = p.name;
  getId('pe-role').value = p.role || 'system';
  getId('pe-trigger').value = p.trigger || 'normal';
  getId('pe-pos').value = p.position || 'at_depth';
  getId('pe-depth').value = p.depth || 0;
  getId('pe-content').value = p.content || '';
  getId('preset-edit-modal').classList.add('show');
}

function closePresetEdit() { getId('preset-edit-modal').classList.remove('show'); }

function savePresetScript() {
  if(currentScriptIdx === -1 || !currentPcId) return;
  var pc = db.presetCollections.find(x => x.id === currentPcId);
  var p = pc.scripts[currentScriptIdx];
  p.name = getId('pe-name').value;
  p.role = getId('pe-role').value;
  p.trigger = getId('pe-trigger').value;
  p.position = getId('pe-pos').value;
  p.depth = parseInt(getId('pe-depth').value);
  p.content = getId('pe-content').value;
  save();
  renderPresetScripts();
  closePresetEdit();
}

function deletePresetScript() {
  if(confirm("ç¡®å®šåˆ é™¤æ­¤è„šæœ¬å—ï¼Ÿ")) {
    var pc = db.presetCollections.find(x => x.id === currentPcId);
    pc.scripts.splice(currentScriptIdx, 1);
    save();
    renderPresetScripts();
    closePresetEdit();
  }
}

/* ğŸŒ ä¸–ç•Œä¹¦é€»è¾‘ (Proç‰ˆ) */
function createWorldInfo() {
  var name = prompt("è¯·è¾“å…¥ä¸–ç•Œä¹¦åç§°:");
  if(name) {
    db.world_info.push({ name: name, entries: [], enabled: true });
    save();
    renderWorldInfo();
  }
}

function importWorldInfo() {
  var input = getId('file-world');
  input.value = '';
  input.onchange = function(e) {
    var file = e.target.files[0];
    if(!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
      try {
        var json = JSON.parse(ev.target.result);
        var entries = [];
        var rawEntries = json.entries || json;
        if(Array.isArray(rawEntries)) {
            entries = rawEntries;
        } else {
            for(var k in rawEntries) {
                entries.push(rawEntries[k]);
            }
        }
        var cleanEntries = entries.map(e => ({
            keys: Array.isArray(e.key) ? e.key : (e.key ? e.key.split(',') : []),
            secondary_keys: Array.isArray(e.secondary_keys) ? e.secondary_keys : (e.secondary_keys ? e.secondary_keys.split(',') : []),
            content: e.content || "",
            enabled: e.enabled !== false,
            depth: e.depth || 4,
            selectiveLogic: e.selectiveLogic || 0 
        }));
        
        db.world_info.push({ name: file.name.replace('.json',''), entries: cleanEntries, enabled: true });
        save();
        renderWorldInfo();
        alert("âœ… ä¸–ç•Œä¹¦å¯¼å…¥æˆåŠŸ: " + file.name);
      } catch(err) { alert("å¯¼å…¥å¤±è´¥: " + err.message); }
    };
    reader.readAsText(file);
  };
  input.click();
}

function renderWorldInfo() {
  var html = '';
  db.world_info.forEach((w, idx) => {
    var status = w.enabled ? "âœ… å·²å¯ç”¨" : "ğŸš« å·²ç¦ç”¨";
    html += `<div class="wi-list-item" onclick="openWiDetail(${idx})">
      <div>
        <div style="font-weight:bold;color:#555">${w.name}</div>
        <div style="font-size:12px;color:#999;margin-top:4px">${w.entries.length} æ¡ç›® | ${status}</div>
      </div>
      <div style="display:flex;gap:5px">
        <button class="btn btn-gray" style="padding:0 10px;height:28px;font-size:12px" onclick="event.stopPropagation();toggleWorldInfo(${idx})">${w.enabled?'ç¦ç”¨':'å¯ç”¨'}</button>
        <button class="btn btn-red" style="padding:0 10px;height:28px;font-size:12px" onclick="event.stopPropagation();delWorldInfo(${idx})">åˆ é™¤</button>
      </div>
    </div>`;
  });
  getId('wi-list').innerHTML = html || '<div style="text-align:center;color:#999;margin-top:20px">æš‚æ— ä¸–ç•Œä¹¦</div>';
}

function toggleWorldInfo(idx) {
  db.world_info[idx].enabled = !db.world_info[idx].enabled;
  save();
  renderWorldInfo();
}

function delWorldInfo(idx) {
  if(confirm("ç¡®å®šåˆ é™¤è¿™æœ¬ä¸–ç•Œä¹¦å—ï¼Ÿ")) {
    db.world_info.splice(idx, 1);
    save();
    renderWorldInfo();
  }
}

var currentWiIdx = -1;
function openWiDetail(idx) {
  currentWiIdx = idx;
  getId('win-wi-detail').classList.add('show');
  getId('wi-detail-title').innerText = db.world_info[idx].name;
  renderWiEntries();
}

function closeWiDetail() {
  getId('win-wi-detail').classList.remove('show');
  currentWiIdx = -1;
  renderWorldInfo();
}

function renderWiEntries() {
  if(currentWiIdx === -1) return;
  var book = db.world_info[currentWiIdx];
  var html = '';
  book.entries.forEach((e, idx) => {
    var statusClass = e.enabled ? 'on' : '';
    var keysStr = Array.isArray(e.keys) ? e.keys.join(',') : e.keys;
    var secKeysStr = Array.isArray(e.secondary_keys) ? e.secondary_keys.join(',') : (e.secondary_keys || "");
    
    html += `<div class="wi-card">
      <div class="wi-card-header">
        <div class="wi-row-flex">
          <div class="wi-status-dot ${statusClass}" onclick="toggleWiEntry(${idx})"></div>
          <span style="font-weight:bold;color:#ff8fab;font-size:14px">æ¡ç›® #${idx+1}</span>
        </div>
        <div class="wi-row-flex">
          <div class="wi-tag">Depth: ${e.depth||4}</div>
          <div class="wi-tag">Order: 100</div>
          <button class="btn btn-gray" style="height:24px;padding:0 8px;font-size:12px" onclick="delWiEntry(${idx})">ğŸ—‘ï¸</button>
        </div>
      </div>
      
      <div class="wi-row-flex">
        <div style="flex:1">
          <label class="f-lbl">ä¸»è¦å…³é”®å­— (é€—å·åˆ†éš”)</label>
          <input class="wi-pill-input" value="${keysStr}" onchange="updateWiEntry(${idx}, 'keys', this.value)">
        </div>
        <div style="width:80px">
          <label class="f-lbl">é€»è¾‘</label>
          <div class="wi-pill-input" style="color:#999;font-size:11px">ä¸ä»»æ„</div>
        </div>
      </div>

      <div class="wi-row-flex">
        <div style="flex:1">
          <label class="f-lbl">å¯é€‰è¿‡æ»¤å™¨ (é€—å·åˆ†éš”)</label>
          <input class="wi-pill-input" value="${secKeysStr}" placeholder="å¦‚æœä¸ºç©ºåˆ™å¿½ç•¥" onchange="updateWiEntry(${idx}, 'secondary_keys', this.value)">
        </div>
      </div>

      <div class="wi-logic-row">
        <div class="wi-logic-btn active">åŒºåˆ†å¤§å°å†™</div>
        <div class="wi-logic-btn active">å®Œæ•´å•è¯</div>
        <div class="wi-logic-btn active">ä½¿ç”¨å…¨å±€</div>
        <div class="wi-logic-btn">ä¸å¯é€’å½’</div>
      </div>

      <div>
        <label class="f-lbl">å†…å®¹</label>
        <textarea class="wi-content-area" onchange="updateWiEntry(${idx}, 'content', this.value)">${e.content}</textarea>
      </div>
      
      <div class="wi-row-flex" style="justify-content:space-between;margin-top:-5px">
        <div style="font-size:11px;color:#ccc">è¯ç¬¦: ${Math.floor(e.content.length/2.5)}</div>
        <div class="wi-row-flex">
           <span style="font-size:11px;color:#999">æ·±åº¦</span>
           <input type="number" value="${e.depth||4}" style="width:40px;border:1px solid #eee;border-radius:5px;text-align:center" onchange="updateWiEntry(${idx}, 'depth', this.value)">
        </div>
      </div>
    </div>`;
  });
  getId('wi-entries-list').innerHTML = html || '<div style="text-align:center;color:#999;margin-top:50px">ç‚¹å‡»å³ä¸Šè§’æ·»åŠ æ¡ç›®</div>';
}

function toggleWiEntry(idx) {
  var e = db.world_info[currentWiIdx].entries[idx];
  e.enabled = !e.enabled;
  save();
  renderWiEntries();
}

function updateWiEntry(idx, field, val) {
  var e = db.world_info[currentWiIdx].entries[idx];
  if(field === 'keys') e.keys = val.split(',');
  else if(field === 'secondary_keys') e.secondary_keys = val.split(',');
  else if(field === 'depth') e.depth = parseInt(val);
  else e[field] = val;
  save();
}

function addWiEntry() {
  db.world_info[currentWiIdx].entries.push({ keys: [], secondary_keys: [], content: "", enabled: true, depth: 4 });
  save();
  renderWiEntries();
}

function delWiEntry(idx) {
  if(confirm("åˆ é™¤æ­¤æ¡ç›®ï¼Ÿ")) {
    db.world_info[currentWiIdx].entries.splice(idx, 1);
    save();
    renderWiEntries();
  }
}

function enterChat(id) {
  curCid = id;
  var c = db.contacts.find(x => x.id === id);
  getId('qq-list-v').style.display = 'none';
  getId('qq-chat-v').style.display = 'flex';
  getId('chat-t').innerText = c.remark || c.name;
  getId('plus-panel').classList.remove('open');
  getId('user-balance-disp').innerText = "Â¥ " + Math.floor(db.user.balance);
  var chatWin = getId('qq-chat-v');
  if(c.chatBg) {
    chatWin.style.backgroundImage = `url(${c.chatBg})`;
  } else {
    chatWin.style.backgroundImage = "";
  }
  renderChat();
}

function exitChat() {
  curCid = null;
  getId('qq-chat-v').style.display = 'none';
  getId('qq-list-v').style.display = 'flex';
}

function renderChat() {
  if(!curCid) return;
  var c = db.contacts.find(x => x.id === curCid);
  var html = '';
  
  c.chat.forEach((m, idx) => {
    // ğŸ›‘ ä¿®å¤1ï¼šå¦‚æœæ¶ˆæ¯å†…å®¹ä¸ºç©ºï¼Œç›´æ¥è·³è¿‡ï¼Œä¸æ¸²æŸ“æ°”æ³¡
    if ((!m.content || m.content.trim() === "") && m.type === 'text') return;

    var isMe = m.role === 'user';
    var isSystem = m.role === 'system';
    
    // ğŸ›‘ ä¿®å¤2ï¼šç»™å¤´åƒå¢åŠ é»˜è®¤å›¾ï¼Œé˜²æ­¢å‡ºç°è£‚å¼€çš„å›¾æ ‡
    var defaultAv = "https://via.placeholder.com/40?text=OwO"; 
    var userAv = db.user.avatar || defaultAv;
    var contactAv = c.avatar || defaultAv;
    var av = isMe ? userAv : contactAv;
    
    if(isSystem) {
      html += `<div class="msg-system">${m.content}</div>`;
      return;
    }

    var quoteHtml = m.quote ? `<div class="quote-box">${m.quote}</div>` : '';
    var contentHtml = '';
    
    if(m.type === 'loc') {
      contentHtml = `<div class="msg-loc">
        <div class="msg-loc-top">
          <div class="msg-loc-t">${m.content}</div>
          <div class="msg-loc-d">${m.content} é™„è¿‘</div>
        </div>
        <div class="msg-loc-map-box">
          <div class="msg-loc-street"></div>
          <div class="msg-loc-dot" style="top:20%;left:30%"></div>
          <div class="msg-loc-dot" style="top:70%;left:80%"></div>
          <div class="msg-loc-shadow"></div>
          <div class="msg-loc-pin">ğŸ“</div>
        </div>
        <div class="msg-loc-btm">
          <span>åŒ—çº¬ 23Â°08â€² ä¸œç» 113Â°19â€²</span>
          <span>æŸ¥çœ‹è·¯çº¿ ></span>
        </div>
      </div>`;
    } else if(m.type === 'transfer') {
      var statusText = m.received ? "å·²æ”¶ä¸‹" : (isMe ? "ç­‰å¾…å¯¹æ–¹æ”¶ä¸‹" : "è¯·æ”¶ä¸‹");
      var receivedClass = m.received ? "received" : "";
      var icon = isMe ? 'ğŸ±' : 'ğŸ°'; 
      contentHtml = `<div class="msg-bub pink-transfer ${receivedClass}" onclick="acceptTransfer(${idx})">
        <div class="pt-icon-box">${icon}</div>
        <div class="pt-info">
          <div class="pt-amount">Â¥ ${m.content}</div>
          <div class="pt-status">${statusText}</div>
        </div>
      </div>`;
    } else if(m.type === 'voice_call') {
      contentHtml = `<div class="msg-bub msg-voice-call" onclick="startVoiceCall(true)">
        <div class="msg-voice-icon">ğŸ“</div>
        <div>${m.content}</div>
      </div>`;
    } else if(m.type === 'voice_msg') {
      contentHtml = `<div class="msg-bub msg-voice-fake" onclick="toggleVoice(this)" style="background:${isMe?'#0099ff':'#fff'};color:${isMe?'#fff':'#333'}">
        <div class="mv-top">
          <div class="mv-icon">â–¶ï¸</div>
          <div class="mv-wave">â€¢áŠáŠ||áŠ|á‹|||||á‹â€Œâ€Œâ€Œâ€ŒáŠ|â€¢</div>
          <div class="mv-sec">${Math.floor(m.content.length / 2) + 2}"</div>
        </div>
        <div class="mv-text">${m.content}</div>
      </div>`;
    } else if(m.type === 'gift') {
      var receivedClass = m.received ? "received" : "";
      var btnHtml = (!isMe && !m.received) ? `<button class="mg-btn" onclick="acceptGift(${idx})">æ”¶ä¸‹</button>` : '';
      var subText = m.received ? "å·²æ”¾å…¥èƒŒåŒ…" : "è¯·æŸ¥æ”¶å¿ƒæ„~";
      
      contentHtml = `<div class="msg-bub msg-gift ${receivedClass}">
        <div class="mg-icon">ğŸ</div>
        <div>
          <div class="mg-text">èµ é€äº† ${m.content}</div>
          <div class="mg-sub">${subText}</div>
        </div>
        ${btnHtml}
      </div>`;
    } else {
      contentHtml = `<div class="msg-bub" style="background:${isMe?'#0099ff':'#fff'};color:${isMe?'#fff':'#333'}">${quoteHtml}${m.content}</div>`;
    }
    
    // ğŸ›‘ ä¿®å¤3ï¼šç»™ img æ ‡ç­¾åŠ  onerrorï¼Œå¦‚æœå›¾ç‰‡æŒ‚äº†è‡ªåŠ¨æ˜¾ç¤ºé»˜è®¤å›¾
    html += `<div class="msg-row ${isMe?'me':''}">
      <img class="msg-av" src="${av}" onerror="this.src='https://via.placeholder.com/40?text=X'" ondblclick="handlePat('${m.role}')">
      <div class="msg-content-wrap" onclick="showBubbleMenu(event, ${idx})">
        ${contentHtml}
      </div>
      ${c.blocked && isMe ? '<div style="align-self:center;color:red;font-size:20px;margin:0 5px">!</div>' : ''}
    </div>`;
  });
  
  var box = getId('chat-box');
  box.innerHTML = html;
  box.scrollTop = box.scrollHeight;
}


function toggleVoice(el) { el.classList.toggle('show-text'); }

var voiceTimer = null;
var currentCallMsgIndex = -1; 
var voiceSeconds = 0; 

function startVoiceCall(isIncoming) {
  if(!curCid) return;
  var c = db.contacts.find(x => x.id === curCid);
  var overlay = getId('voice-call-overlay');
  var av = getId('vc-av');
  var name = getId('vc-name');
  var status = getId('vc-status');
  var subtitle = getId('vc-subtitle');
  
  av.src = c.avatar || "https://via.placeholder.com/100";
  name.innerText = c.remark || c.name;
  status.innerText = isIncoming ? "æ­£åœ¨å‘¼å«..." : "æ­£åœ¨ç­‰å¾…å¯¹æ–¹æ¥å—é‚€è¯·...";
  subtitle.innerText = "(AI çš„å£°éŸ³ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ...)";
  getId('vc-in').value = "";
  
  voiceSeconds = 0;
  if(voiceTimer) clearInterval(voiceTimer);
  voiceTimer = null;
  
  if(db.theme.voiceBg) overlay.style.backgroundImage = `url(${db.theme.voiceBg})`;
  else overlay.style.backgroundImage = "";
  
  overlay.classList.add('show');
  
  if(!isIncoming) {
    c.chat.push({ role: 'user', content: 'æ­£åœ¨é€šè¯...', type: 'voice_call' });
    currentCallMsgIndex = c.chat.length - 1;
    save();
    renderChat();
  } else {
    currentCallMsgIndex = -1; 
  }
  
  setTimeout(() => {
    status.innerText = "00:00";
    if(voiceTimer) clearInterval(voiceTimer);
    voiceSeconds = 0; 
    voiceTimer = setInterval(() => {
      voiceSeconds++;
      var m = Math.floor(voiceSeconds / 60);
      var s = voiceSeconds % 60;
      status.innerText = ('0'+m).slice(-2) + ":" + ('0'+s).slice(-2);
    }, 1000);
  }, 2000);
}

function endVoiceCall() {
  var overlay = getId('voice-call-overlay');
  overlay.classList.remove('show');
  if(voiceTimer) clearInterval(voiceTimer);
  voiceTimer = null;
  if(curCid && currentCallMsgIndex !== -1) {
    var c = db.contacts.find(x => x.id === curCid);
    if(c.chat[currentCallMsgIndex]) {
      var m = Math.floor(voiceSeconds / 60);
      var s = voiceSeconds % 60;
      var finalTime = ('0'+m).slice(-2) + ":" + ('0'+s).slice(-2);
      c.chat[currentCallMsgIndex].content = "é€šè¯æ—¶é•¿ " + finalTime;
      save();
      renderChat();
    }
  }
}

function changeVoiceBg() {
  var url = prompt("è¯·è¾“å…¥èƒŒæ™¯å›¾ç‰‡ URL (ç•™ç©ºæ¢å¤é»˜è®¤):");
  if(url !== null) {
    db.theme.voiceBg = url;
    save();
    var overlay = getId('voice-call-overlay');
    if(url) overlay.style.backgroundImage = `url(${url})`;
    else overlay.style.backgroundImage = "";
  }
}

async function sendVoiceText() {
  var input = getId('vc-in');
  var val = input.value.trim();
  if(!val) return;
  getId('vc-subtitle').innerText = "æˆ‘: " + val;
  input.value = '';
  await triggerAiVoiceReply(val);
}

async function triggerAiVoiceReply(userText) {
  if(!curCid) return;
  var c = db.contacts.find(x => x.id === curCid);
  var subtitle = getId('vc-subtitle');
  subtitle.innerText = `(${c.name} æ­£åœ¨æ€è€ƒ...)`;
  var prompt = `ä½ æ‰®æ¼”ï¼š${c.name}ã€‚è®¾å®šï¼š${c.desc}ã€‚ç”¨æˆ·ï¼š${db.user.name}ã€‚
  ä½ ä»¬æ­£åœ¨è¿›è¡Œã€è¯­éŸ³é€šè¯ã€‘ã€‚
  ç”¨æˆ·åˆšåˆšè¯´ï¼š${userText}
  è¯·ç”¨å£è¯­åŒ–çš„æ–¹å¼ç®€çŸ­å›å¤ã€‚ä¸è¦ä½¿ç”¨ä»»ä½•åŠ¨ä½œæå†™ã€‚`;
  var msgs = [{role:"system", content: prompt}];
  c.chat.slice(-5).forEach(m => {
     if(m.type === 'text') msgs.push({role: m.role==='user'?'user':'assistant', content: m.content});
  });
  msgs.push({role: "user", content: userText});
  try {
    var res = await callAI_Raw(msgs);
    subtitle.innerText = "AI: " + res;
  } catch(e) {
    subtitle.innerText = "(è¿æ¥å¤±è´¥: " + e.message + ")";
  }
}

function acceptTransfer(idx) {
  if(!curCid) return;
  var c = db.contacts.find(x => x.id === curCid);
  var msg = c.chat[idx];
  if(msg.type !== 'transfer') return;
  if(msg.received) return; 
  if(msg.role === 'user') {
    alert("è¿™æ˜¯ä½ å‘å‡ºçš„è½¬è´¦ï¼Œç­‰å¾…å¯¹æ–¹æ”¶ä¸‹å“¦~");
    return;
  }
  var amount = parseFloat(msg.content);
  db.user.balance += amount;
  msg.received = true;
  c.chat.push({ role: 'system', content: `"${db.user.name}" æ”¶ä¸‹äº† "${c.remark||c.name}" çš„è½¬è´¦` });
  save();
  renderChat();
  getId('user-balance-disp').innerText = "Â¥ " + Math.floor(db.user.balance);
}

function acceptGift(idx) {
  if(!curCid) return;
  var c = db.contacts.find(x => x.id === curCid);
  var msg = c.chat[idx];
  if(msg.type !== 'gift') return;
  if(msg.received) return;
  
  db.user.inventory.push(msg.content);
  msg.received = true;
  c.chat.push({ role: 'system', content: `"${db.user.name}" æ”¶ä¸‹äº† "${c.remark||c.name}" çš„ç¤¼ç‰©` });
  save();
  renderChat();
  alert(`å·²å°† ${msg.content} æ”¾å…¥èƒŒåŒ…ï¼ğŸ’`);
}

function handlePat(role) {
  if(!curCid) return;
  var c = db.contacts.find(x => x.id === curCid);
  if(role !== 'user') {
    var suffix = c.patMeSuffix || "";
    c.chat.push({ role: 'system', content: `â€œ${db.user.name}â€ æ‹äº†æ‹ â€œ${c.remark||c.name}â€${suffix}` });
    save();
    renderChat();
    if(role === 'ai') { } else { setTimeout(() => { triggerAiReply(true); }, 1000); }
  }
}

function showBubbleMenu(e, idx) {
  e.stopPropagation();
  menuTargetIdx = idx;
  var menu = getId('bub-menu');
  menu.style.display = 'flex';
  menu.style.top = (e.clientY - 45) + 'px';
  var left = e.clientX - 50;
  if(left < 10) left = 10;
  if(left > window.innerWidth - 120) left = window.innerWidth - 120;
  menu.style.left = left + 'px';
  document.addEventListener('click', function hideBubMenu() {
    menu.style.display = 'none';
    document.removeEventListener('click', hideBubMenu);
  });
}

function doRecall() {
  if(!curCid || menuTargetIdx === -1) return;
  var c = db.contacts.find(x => x.id === curCid);
  c.chat.splice(menuTargetIdx, 1);
  save();
  renderChat();
}

function doQuote() {
  if(!curCid || menuTargetIdx === -1) return;
  var c = db.contacts.find(x => x.id === curCid);
  var msg = c.chat[menuTargetIdx];
  var name = msg.role === 'user' ? db.user.name : (c.remark || c.name);
  var txt = msg.type === 'text' ? msg.content : '[ç‰¹æ®Šæ¶ˆæ¯]';
  curQuote = name + ": " + txt;
  getId('quote-bar').style.display = 'flex';
  getId('quote-text').innerText = curQuote.slice(0, 20) + "...";
}

function cancelQuote() {
  curQuote = null;
  getId('quote-bar').style.display = 'none';
}

function togglePlusPanel() { getId('plus-panel').classList.toggle('open'); }

function sendMsg(type, contentOverride, roleOverride) {
  var input = getId('msg-in');
  var txt = contentOverride || input.value.trim();
  if((!txt && type==='text') || !curCid) return;
  var c = db.contacts.find(x => x.id === curCid);
  if(c.blocked) return alert("å·²æ‹‰é»‘è¯¥å¥½å‹ï¼Œæ— æ³•å‘é€æ¶ˆæ¯");
  var role = roleOverride || 'user';
  if(type === 'transfer' && role === 'user') {
    var amount = parseFloat(txt);
    if(isNaN(amount) || amount <= 0) return alert("è¯·è¾“å…¥æ­£ç¡®çš„é‡‘é¢");
    if(db.user.balance < amount) return alert("ä½™é¢ä¸è¶³ï¼Œæ— æ³•è½¬è´¦ğŸ¥º");
    db.user.balance -= amount;
    getId('user-balance-disp').innerText = "Â¥ " + Math.floor(db.user.balance);
  }
  
  var msgObj = { role: role, content: txt, type: type || 'text' };
  if(curQuote && role === 'user') {
    msgObj.quote = curQuote;
    cancelQuote();
  }
  c.chat.push(msgObj);
  save();
  renderChat(); 
  if(type === 'text' && role === 'user') { input.value = ''; }
  getId('plus-panel').classList.remove('open');
  
  // ğŸ§  è‡ªåŠ¨è®°å¿†æ€»ç»“è§¦å‘ (æ¯50æ¡)
  if(c.chat.length > 0 && c.chat.length % 50 === 0) {
    summarizeChat(false); // false = silent/auto
  }
}

function openInputModal(title, placeholder, type) {
  getId('input-modal').classList.add('show');
  getId('im-title').innerText = title;
  getId('im-val').placeholder = placeholder;
  getId('im-val').value = '';
  getId('im-val').focus();
  inputCallback = function(val) {
    if(!val) return;
    sendSpecial(type, val);
  };
}

function closeInputModal() {
  getId('input-modal').classList.remove('show');
  inputCallback = null;
}

function confirmInputModal() {
  var val = getId('im-val').value;
  if(inputCallback) inputCallback(val);
  closeInputModal();
}

function sendSpecial(type, content) { sendMsg(type, content, 'user'); }

/* ğŸ›ï¸ å•†åº— & èƒŒåŒ…é€»è¾‘ */
var SHOP_ITEMS = [
  { name: "çç å¥¶èŒ¶", icon: "ğŸ¥¤", price: 20 },
  { name: "è‰è“è›‹ç³•", icon: "ğŸ°", price: 50 },
  { name: "çº¢ç«ç‘°", icon: "ğŸŒ¹", price: 99 },
  { name: "æ¸¸æˆæœº", icon: "ğŸ®", price: 500 },
  { name: "é’»æˆ’", icon: "ğŸ’", price: 1000 },
  { name: "è·‘è½¦", icon: "ğŸï¸", price: 5000 },
  { name: "æµ·æ™¯æˆ¿", icon: "ğŸï¸", price: 9999 },
  { name: "å¸ƒå¶çŒ«", icon: "ğŸ±", price: 2000 },
  { name: "æ˜Ÿæ˜Ÿå‘½åæƒ", icon: "â­ï¸", price: 520 },
  { name: "æƒ…ä¹¦", icon: "ğŸ’Œ", price: 10 },
  { name: "æ³°è¿ªç†Š", icon: "ğŸ§¸", price: 150 },
  { name: "ç§äººé£æœº", icon: "âœˆï¸", price: 88888 }
];

function openShop() {
  getId('shop-modal').classList.add('show');
  var html = '<div class="shop-grid">';
  SHOP_ITEMS.forEach((item, idx) => {
    html += `<div class="shop-item">
      <div class="si-icon">${item.icon}</div>
      <div class="si-name">${item.name}</div>
      <div class="si-price">Â¥ ${item.price}</div>
      <button class="si-btn" onclick="buyItem(${idx})">è´­ä¹°</button>
    </div>`;
  });
  html += '</div>';
  getId('shop-content').innerHTML = html;
}

function closeShop() { getId('shop-modal').classList.remove('show'); }

function buyItem(idx) {
  var item = SHOP_ITEMS[idx];
  if(db.user.balance < item.price) return alert("ä½™é¢ä¸è¶³ï¼Œå¿«å»æ‰“å·¥å§ï¼ğŸ¥º");
  
  if(confirm(`ç¡®å®šè¦è´­ä¹° ${item.name} å—ï¼Ÿ\nä»·æ ¼: Â¥${item.price}`)) {
    db.user.balance -= item.price;
    getId('user-balance-disp').innerText = "Â¥ " + Math.floor(db.user.balance);
    
    if(confirm("æ˜¯è¦é€ç»™ç°åœ¨çš„èŠå¤©å¯¹è±¡å—ï¼Ÿ(å–æ¶ˆåˆ™æ”¾å…¥è‡ªå·±èƒŒåŒ…)")) {
      if(!curCid) return alert("æ²¡æœ‰æ­£åœ¨èŠå¤©çš„å¯¹è±¡ï¼Œå·²æ”¾å…¥èƒŒåŒ…");
      var c = db.contacts.find(x => x.id === curCid);
      c.chat.push({ role: 'user', content: item.name, type: 'gift' });
      c.inventory.push(item.name);
      save();
      renderChat();
      closeShop();
      setTimeout(() => { triggerAiReply(); }, 1000);
    } else {
      db.user.inventory.push(item.name);
      save();
      alert("å·²æ”¾å…¥èƒŒåŒ…ï¼ğŸ’");
    }
  }
}

function openUserBackpack() {
  getId('backpack-modal').classList.add('show');
  var inv = db.user.inventory || [];
  var counts = {};
  inv.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
  
  var html = '<div class="backpack-grid">';
  if(inv.length === 0) html = '<div style="text-align:center;width:100%;color:#999;margin-top:20px">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ...ğŸ¥º</div>';
  else {
    for(var name in counts) {
      var item = SHOP_ITEMS.find(x => x.name === name) || { icon: 'ğŸ“¦', name: name };
      html += `<div class="backpack-item">
        <div class="bi-icon">${item.icon}</div>
        <div class="bi-name">${item.name}</div>
        <div class="bi-count">x${counts[name]}</div>
      </div>`;
    }
  }
  html += '</div>';
  getId('backpack-content').innerHTML = html;
}

function closeBackpack() { getId('backpack-modal').classList.remove('show'); }

function openAiSettings() {
  if(!curCid) return;
  
  // 1. å‡†å¤‡æ•°æ® (å’Œä¹‹å‰ä¸€æ ·ï¼Œä¿æŒä¸å˜)
  var c = db.contacts.find(x => x.id === curCid);
  
  // --- å‡†å¤‡èƒŒåŒ… HTML ---
  var inv = c.inventory || [];
  var counts = {};
  inv.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
  var bagHtml = "";
  if(inv.length === 0) bagHtml = "<div style='font-size:12px;color:#999;text-align:center'>è¿˜æ²¡æœ‰æ”¶åˆ°è¿‡ç¤¼ç‰©å“¦...</div>";
  else {
    bagHtml = "<div style='display:flex;gap:5px;overflow-x:auto;padding-bottom:5px'>";
    for(var name in counts) {
      var item = SHOP_ITEMS.find(x => x.name === name) || { icon: 'ğŸ', name: name };
      bagHtml += `<div style="flex-shrink:0;background:#fff;padding:5px;border-radius:8px;border:1px solid #eee;text-align:center;min-width:50px">
        <div style="font-size:20px">${item.icon}</div>
        <div style="font-size:10px;color:#666">${item.name}</div>
        <div style="font-size:9px;color:#999">x${counts[name]}</div>
      </div>`;
    }
    bagHtml += "</div>";
  }

  // --- å‡†å¤‡ä¸–ç•Œä¹¦ HTML ---
  var wiHtml = "";
  if(db.world_info.length === 0) {
    wiHtml = "<div style='font-size:12px;color:#999;text-align:center'>æš‚æ— ä¸–ç•Œä¹¦ï¼Œè¯·å»æ¡Œé¢ã€ä¸–ç•Œä¹¦ã€‘APPæ·»åŠ </div>";
  } else {
    wiHtml = "<div style='max-height:120px;overflow-y:auto;border:1px solid #eee;border-radius:8px;padding:5px'>";
    db.world_info.forEach(w => {
        var isLinked = c.linkedWorldInfo && c.linkedWorldInfo.includes(w.name);
        wiHtml += `<div style="display:flex;align-items:center;gap:8px;padding:5px;border-bottom:1px solid #f9f9f9">
            <input type="checkbox" ${isLinked?'checked':''} onchange="toggleWiLink('${c.id}', '${w.name}')">
            <span style="font-size:13px;color:#555">${w.name}</span>
        </div>`;
    });
    wiHtml += "</div>";
  }

  // --- å‡†å¤‡é¢„è®¾ HTML ---
  var presetHtml = "";
  if(db.presetCollections.length === 0) {
    presetHtml = "<div style='font-size:12px;color:#999;text-align:center'>æš‚æ— é¢„è®¾åŒ…ï¼Œè¯·å»æ¡Œé¢ã€é¢„è®¾ã€‘APPæ·»åŠ </div>";
  } else {
    presetHtml = `<select class="f-sel" onchange="setAiPresetLink('${c.id}', this.value)">
      <option value="">(ä½¿ç”¨å…¨å±€é»˜è®¤)</option>`;
    db.presetCollections.forEach(pc => {
        var selected = c.linkedPresetId === pc.id ? "selected" : "";
        presetHtml += `<option value="${pc.id}" ${selected}>${pc.name}</option>`;
    });
    presetHtml += `</select>`;
  }

  // 2. æ‹¼æ¥ HTML
  var finalHtml = `
    <div style="background:#f9f9f9;padding:15px;border-radius:12px;margin-bottom:15px;text-align:center">
      <div style="font-size:12px;color:#999">ğŸ’° å¯¹æ–¹é’±åŒ…ä½™é¢</div>
      <div style="font-size:24px;font-weight:bold;color:#d87093">Â¥ ${c.balance.toFixed(2)}</div>
    </div>
    
    <div style="background:#fff0f5;padding:10px;border-radius:10px;margin-bottom:15px;border:1px dashed #ffb7b2">
      <div style="font-weight:bold;margin-bottom:10px;color:#d87093;font-size:13px">ğŸ’ TA çš„èƒŒåŒ…</div>
      ${bagHtml}
    </div>

    <div style="background:#f0f8ff;padding:10px;border-radius:10px;margin-bottom:15px;border:1px solid #b3e5fc">
      <div style="font-weight:bold;margin-bottom:10px;color:#0984e3;font-size:13px">ğŸŒ ç»‘å®šä¸–ç•Œä¹¦</div>
      <div style="font-size:11px;color:#888;margin-bottom:5px">å‹¾é€‰åï¼ŒAI å°†ä¼˜å…ˆè¯»å–ç»‘å®šçš„ä¸–ç•Œä¹¦ã€‚è‹¥ä¸å‹¾é€‰ï¼Œåˆ™ä½¿ç”¨å…¨å±€å¯ç”¨çš„ä¸–ç•Œä¹¦ã€‚</div>
      ${wiHtml}
    </div>

    <div style="background:#fff0f5;padding:10px;border-radius:10px;margin-bottom:15px;border:1px solid #ffb7b2">
      <div style="font-weight:bold;margin-bottom:10px;color:#d87093;font-size:13px">ğŸ›ï¸ ç»‘å®šé¢„è®¾åŒ…</div>
      <div style="font-size:11px;color:#888;margin-bottom:5px">é€‰æ‹©ä¸€ä¸ªé¢„è®¾åŒ…ç»‘å®šç»™è¯¥ AIã€‚</div>
      ${presetHtml}
    </div>

    <div class="f-item"><label class="f-lbl">æœ¬å (AIè‡ªç§°)</label><input id="set-name" class="f-in" value="${c.name}"></div>
    <div class="f-item"><label class="f-lbl">å¤‡æ³¨ (ä½ çœ‹åˆ°çš„)</label><input id="set-remark" class="f-in" value="${c.remark||''}"></div>
    <div class="f-item"><label class="f-lbl">å¤´åƒ URL</label><input id="set-av" class="f-in" value="${c.avatar||''}"></div>
    <div class="f-item"><label class="f-lbl">èŠå¤©èƒŒæ™¯å›¾ URL</label><input id="set-bg" class="f-in" value="${c.chatBg||''}" placeholder="è¾“å…¥å›¾ç‰‡é“¾æ¥..."></div>
    <div class="f-item"><label class="f-lbl">äººè®¾ Prompt</label><textarea id="set-desc" class="f-area" style="height:80px">${c.desc||''}</textarea></div>
    <div class="f-item"><label class="f-lbl">å¼€åœºç™½</label><textarea id="set-first" class="f-area" style="height:50px">${c.firstMsg||''}</textarea></div>
    <div style="background:#f9f9f9;padding:10px;border-radius:10px;margin-bottom:15px">
      <div style="font-weight:bold;margin-bottom:10px;color:#d87093">ğŸ’¬ å›å¤è®¾ç½®</div>
      <div class="f-item"><label class="f-lbl">è¿ç»­å›å¤æ¡æ•° (1-5)</label><input id="set-max-reply" type="number" min="1" max="5" class="f-in" value="${c.maxReply||1}"></div>
    </div>
    <div style="background:#f9f9f9;padding:10px;border-radius:10px;margin-bottom:15px">
      <div style="font-weight:bold;margin-bottom:10px;color:#d87093">ğŸ‘‹ æ‹ä¸€æ‹è®¾ç½®</div>
      <div class="f-item"><label class="f-lbl">æˆ‘æ‹AIçš„åç¼€</label><input id="set-pat-me" class="f-in" value="${c.patMeSuffix||''}"></div>
      <div class="f-item"><label class="f-lbl">AIæ‹æˆ‘çš„åç¼€</label><input id="set-pat-ai" class="f-in" value="${c.patAiSuffix||''}"></div>
    </div>
    <div class="f-item" style="display:flex;align-items:center;gap:10px;margin-top:10px">
      <label>ğŸš« æ‹‰é»‘å¥½å‹</label>
      <input type="checkbox" id="set-block" ${c.blocked?'checked':''}>
    </div>
    
    <button class="btn btn-blue btn-block" style="margin-top:15px" onclick="saveAiSettings()">ä¿å­˜è®¾ç½®</button>
    <button class="btn btn-red btn-block" style="margin-top:15px; background:#ff7675; border-color:#ff7675" onclick="clearCurrentChat()">ğŸ§¹ æ¸…ç©ºèŠå¤©è®°å½•</button>
    <button class="btn btn-red btn-block" style="margin-top:15px" onclick="deleteContact()">ğŸ—‘ï¸ åˆ é™¤å¥½å‹</button>
  `;

  // 3. âš¡ï¸ ç»ˆæé˜²é—ªçƒé€»è¾‘
  var root = getId('md-root');
  var body = getId('md-b');
  var title = getId('md-t');

  // A. å…ˆå¡«å†…å®¹
  title.innerText = "ğŸ± å¥½å‹è®¾ç½®";
  body.innerHTML = finalHtml;
  body.scrollTop = 0;

  // B. å¼ºåˆ¶é‡ç»˜ (Force Reflow)
  // è¯»å– offsetWidth ä¼šå¼ºè¿«æµè§ˆå™¨ç«‹åˆ»è®¡ç®—å¥½å½“å‰çš„é«˜åº¦å’Œå¸ƒå±€
  // è¿™æ ·æµè§ˆå™¨å°±çŸ¥é“å¼¹çª—æœ‰å¤šå¤§äº†ï¼Œä¸ä¼šåœ¨æ˜¾ç¤ºçš„ä¸€ç¬é—´ä»å°å˜å¤§
  void root.offsetWidth; 

  // C. æœ€åæ˜¾ç¤º
  root.classList.add('show');
}


function toggleWiLink(cid, bookName) {
    var c = db.contacts.find(x => x.id === cid);
    if(!c.linkedWorldInfo) c.linkedWorldInfo = [];
    var idx = c.linkedWorldInfo.indexOf(bookName);
    if(idx > -1) {
        c.linkedWorldInfo.splice(idx, 1);
    } else {
        c.linkedWorldInfo.push(bookName);
    }
    save();
}

function setAiPresetLink(cid, presetId) {
    var c = db.contacts.find(x => x.id === cid);
    c.linkedPresetId = presetId;
    save();
}

function saveAiSettings() {
  var c = db.contacts.find(x => x.id === curCid);
  c.name = getId('set-name').value;
  c.remark = getId('set-remark').value;
  c.avatar = getId('set-av').value;
  c.chatBg = getId('set-bg').value; 
  c.desc = getId('set-desc').value;
  c.firstMsg = getId('set-first').value;
  c.blocked = getId('set-block').checked;
  c.patMeSuffix = getId('set-pat-me').value;
  c.patAiSuffix = getId('set-pat-ai').value;
  var mr = parseInt(getId('set-max-reply').value);
  if(mr < 1) mr = 1;
  if(mr > 5) mr = 5;
  c.maxReply = mr;
  save();
  closeMd();
  getId('chat-t').innerText = c.remark || c.name;
  var chatWin = getId('qq-chat-v');
  if(c.chatBg) chatWin.style.backgroundImage = `url(${c.chatBg})`;
  else chatWin.style.backgroundImage = "";
  renderChat();
}

function deleteContact() {
  if(confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¥½å‹å—ï¼ŸèŠå¤©è®°å½•ä¹Ÿä¼šæ¶ˆå¤±å“¦ï¼ğŸ¥º")) {
    db.contacts = db.contacts.filter(x => x.id !== curCid);
    save();
    closeMd();
    exitChat();
    renderContactList();
  }
}

async function showInnerThoughts() {
  if(!curCid) return;
  var c = db.contacts.find(x => x.id === curCid);
  if(c.chat.length === 0) return alert("è¿˜æ²¡æœ‰èŠå¤©è®°å½•å“¦~");
  
  var lastMsg = c.chat[c.chat.length - 1];
  if(lastMsg.role !== 'ai') return alert("è¦ç­‰ AI å›å¤äº†æ‰èƒ½å·å¬å¿ƒå£°å“¦ï¼ğŸ¤«");
  
  getId('thought-modal').classList.add('show');
  getId('hb-current-view').style.display = 'flex';
  getId('hb-history-view').style.display = 'none';
  getId('hb-content').innerText = "ğŸ”® æ­£åœ¨æ½œå…¥å¯¹æ–¹çš„å¤§è„‘...";
  
  // 1. æ„å»ºä¸Šä¸‹æ–‡ï¼šè¯»å–æœ€è¿‘ 5 æ¡è®°å½•ï¼Œè®© AI çŸ¥é“è¯­å¢ƒ
  var context = c.chat.slice(-5).map(m => {
      var sender = m.role === 'user' ? db.user.name : c.name;
      return `${sender}: ${m.content}`;
  }).join("\n");

  // 2. æ„é€  Prompt
  var prompt = `
  [Roleplay Task]
  You are ${c.name}. 
  Analyze your own last message to ${db.user.name}.
  
  [Character Settings]
  ${c.desc}
  
  [Recent Chat Context]
  ${context}
  
  [Your Last Message]
  "${lastMsg.content}"
  
  [Instruction]
  Reveal your inner thoughts.
  1. <real>: What are you consciously thinking? (Rational, protective, planning)
  2. <dark>: What are your subconscious, darker urges? (Possessiveness, obsession, insecurity)
  
  Output Format:
  <real>...</real>
  <dark>...</dark>
  Use Chinese. Keep it consistent with your personality.
  `;
  
  try {
    var res = await callAI_Raw([{role:"system", content: prompt}]);
    var realMatch = res.match(/<real>([\s\S]*?)<\/real>/);
    var darkMatch = res.match(/<dark>([\s\S]*?)<\/dark>/);
    var realContent = realMatch ? realMatch[1].trim() : "ï¼ˆå¿ƒæ€æ·±æ²‰ï¼Œæ— æ³•è¯»å–...ï¼‰";
    var darkContent = darkMatch ? darkMatch[1].trim() : "ï¼ˆå†…å¿ƒæ¯«æ— æ³¢æ¾œ...ï¼‰";
    
    var html = `
      <div class="hb-sticker-card">
        <div class="tape-strip"></div>
        <div class="hb-label">ğŸ’– è¡¨å±‚æƒ³æ³•</div>
        <div class="hb-text">${realContent}</div>
      </div>
      <div class="hb-sticker-card dark">
        <div class="tape-strip" style="background:rgba(200,200,200,0.5)"></div>
        <div class="hb-label" style="color:#888">ğŸ˜ˆ æ·±å±‚æ¬²æœ›</div>
        <div class="hb-text">${darkContent}</div>
      </div>
    `;
    getId('hb-content').innerHTML = html;
    
    if(!c.thoughts) c.thoughts = [];
    var lastSaved = c.thoughts[0];
    if(!lastSaved || lastSaved.msgContent !== lastMsg.content) {
        c.thoughts.unshift({
            date: new Date().toLocaleString(),
            msgContent: lastMsg.content,
            thoughtContent: html 
        });
        if(c.thoughts.length > 20) c.thoughts.pop();
        save();
    }
  } catch(e) {
    getId('hb-content').innerText = "å·å¬å¤±è´¥: " + e.message;
  }
}


function toggleThoughtHistory() {
  var curView = getId('hb-current-view');
  var histView = getId('hb-history-view');
  var btn = document.querySelector('.hb-btn-hist');
  if(curView.style.display !== 'none') {
    curView.style.display = 'none';
    histView.style.display = 'flex';
    btn.innerText = "ğŸ”™ è¿”å›";
    renderThoughtHistory();
  } else {
    curView.style.display = 'flex';
    histView.style.display = 'none';
    btn.innerText = "ğŸ“– ç¿»çœ‹æ—§è´¦";
  }
}

function renderThoughtHistory() {
  if(!curCid) return;
  var c = db.contacts.find(x => x.id === curCid);
  var list = getId('hb-hist-list');
  if(!c.thoughts || c.thoughts.length === 0) {
    list.innerHTML = "<div style='text-align:center;color:#999;margin-top:20px'>è¿˜æ²¡æœ‰å·å¬è¿‡å¿ƒå£°å“¦~</div>";
    return;
  }
  var html = '';
  c.thoughts.forEach(t => {
    html += `<div style="margin-bottom:30px;border-bottom:2px dashed #eee;padding-bottom:20px">
      <div style="font-size:12px;color:#aaa;margin-bottom:5px">${t.date}</div>
      <div style="font-style:italic;color:#888;margin-bottom:10px;background:#fff;padding:5px;border-radius:5px">â€œ${t.msgContent.slice(0, 30)}...â€</div>
      ${t.thoughtContent}
    </div>`;
  });
  list.innerHTML = html;
}

function closeThoughts() { getId('thought-modal').classList.remove('show'); }

/* â†ªï¸ è½¬å‘èŠå¤©è®°å½• */
function forwardChat() {
  if(!curCid) return;
  var currentContact = db.contacts.find(x => x.id === curCid);
  
  // 1. é€‰æ‹©ç›®æ ‡ AI
  var otherContacts = db.contacts.filter(x => x.id !== curCid);
  if(otherContacts.length === 0) return alert("æ²¡æœ‰å…¶ä»–å¥½å‹å¯ä»¥è½¬å‘äº†ğŸ¥º");
  
  var targetId = prompt("è¯·è¾“å…¥è¦è½¬å‘ç»™çš„å¥½å‹åå­— (æ¨¡ç³ŠåŒ¹é…):");
  if(!targetId) return;
  
  var target = otherContacts.find(x => (x.remark || x.name).includes(targetId));
  if(!target) return alert("æ‰¾ä¸åˆ°è¿™ä¸ªå¥½å‹ğŸ¥º");
  
  // 2. æ‰“åŒ…èŠå¤©è®°å½• (æœ€è¿‘ 20 æ¡)
  var logs = currentContact.chat.slice(-20).map(m => {
    var sender = m.role === 'user' ? db.user.name : (currentContact.remark || currentContact.name);
    return `${sender}: ${m.content}`;
  }).join("\n");
  
  if(!logs) return alert("æ²¡æœ‰èŠå¤©è®°å½•å¯ä»¥è½¬å‘ğŸ¥º");
  
  // 3. å‘é€ç»™ç›®æ ‡
  target.chat.push({
    role: 'system',
    content: `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·è½¬å‘äº†ä¸€æ®µä¸ "${currentContact.remark||currentContact.name}" çš„èŠå¤©è®°å½•ç»™ä½ ]\n\n${logs}\n\n[ç³»ç»Ÿæç¤ºï¼šè¯·é˜…è¯»ä»¥ä¸Šè®°å½•ï¼Œå¹¶å‘è¡¨ä½ çš„çœ‹æ³•]`
  });
  
  save();
  alert(`å·²è½¬å‘ç»™ ${target.remark||target.name}ï¼å¿«å»çœ‹çœ‹å®ƒçš„ååº”å§ï¼ğŸƒâ€â™€ï¸`);
  getId('plus-panel').classList.remove('open');
}

async function summarizeChat(isManual) {
  if(!curCid) return;
  var c = db.contacts.find(x => x.id === curCid);
  
  if(isManual) {
    if(!confirm("ç¡®å®šè¦ç”Ÿæˆå½“å‰èŠå¤©è®°å½•çš„è®°å¿†æ€»ç»“å—ï¼Ÿ\nè¿™å°†æ¶ˆè€—ä¸€äº› Tokenï¼Œå¹¶å­˜å…¥ã€è‡ªåŠ¨è®°å¿†ã€‘ä¸–ç•Œä¹¦ã€‚")) return;
    getId('plus-panel').classList.remove('open');
  }

  // æå–æœ€è¿‘ 50 æ¡è®°å½•
  var logs = c.chat.slice(-50).map(m => {
    var sender = m.role === 'user' ? db.user.name : c.name;
    return `${sender}: ${m.content}`;
  }).join("\n");

  if(!logs) return isManual ? alert("èŠå¤©è®°å½•å¤ªå°‘å•¦ï¼èŠä¸€ä¼šå„¿å†æ¥å§~") : null;

  var prompt = `Task: Summarize the following chat history between ${db.user.name} and ${c.name}.
  Focus on: Key events, relationship development, and important facts.
  Output Language: Chinese.
  Length: Under 100 words.
  
  Chat History:
  ${logs}`;

  try {
    if(isManual) alert("æ­£åœ¨ç”Ÿæˆè®°å¿†æ€»ç»“ï¼Œè¯·ç¨å€™... ğŸµ");
    
    var summary = await callAI_Raw([{role: "system", content: prompt}]);
    
    // ç¡®ä¿ä¸–ç•Œä¹¦å­˜åœ¨
    var bookName = "ã€è‡ªåŠ¨è®°å¿†ã€‘";
    var book = db.world_info.find(w => w.name === bookName);
    if(!book) {
        book = { name: bookName, entries: [], enabled: true };
        db.world_info.push(book);
    }
    
    // å­˜å…¥æ¡ç›®
    book.entries.push({
        keys: [c.name, "æ€»ç»“", "å›å¿†", "è®°å¿†"],
        secondary_keys: [],
        content: `[è®°å¿†æ€»ç»“ - ${new Date().toLocaleString()}]\n${summary}`,
        enabled: true,
        depth: 4,
        selectiveLogic: 0
    });
    save();
    
    if(isManual) alert("âœ… è®°å¿†æ€»ç»“å·²ç”Ÿæˆï¼\n\n" + summary);
    
  } catch(e) {
    if(isManual) alert("ç”Ÿæˆå¤±è´¥: " + e.message);
  }
}

var isAiThinking = false;

// â³ è¾…åŠ©å‡½æ•°ï¼šå»¶è¿Ÿç­‰å¾…
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

async function triggerAiReply(isPat = false) {
  if(!curCid) return;
  if(isAiThinking) return;
  
  var c = db.contacts.find(x => x.id === curCid);
  if(c.blocked) return alert("å¯¹æ–¹å·²è¢«æ‹‰é»‘ï¼Œæ— æ³•å›å¤");
  
  // UI äº¤äº’çŠ¶æ€æ›´æ–°
  var btn = document.querySelector('#qq-chat-v .btn-gray');
  var titleEl = getId('chat-t');
  var originalTitle = c.remark || c.name; 
  
  if(btn) {
      btn.innerText = "..."; 
      btn.style.opacity = "0.5"; 
      btn.style.cursor = "not-allowed"; 
      btn.disabled = true; 
  }
  titleEl.innerText = "å¯¹æ–¹æ­£åœ¨è¾“å…¥..."; 
  
  isAiThinking = true;
  
  try {
    // --- 1. è½¬è´¦æ¥æ”¶é€»è¾‘ (ä¿æŒä¸å˜) ---
    var hasReceived = false;
    c.chat.forEach(m => {
      if(m.role === 'user' && m.type === 'transfer' && !m.received) {
        m.received = true;
        var amt = parseFloat(m.content);
        c.balance += amt;
        hasReceived = true;
      }
    });
    if(hasReceived) {
      c.chat.push({ role: 'system', content: `"${c.remark||c.name}" æ”¶ä¸‹äº† "${db.user.name}" çš„è½¬è´¦` });
      save();
      renderChat();
    }
    
    // --- 2. æ„å»ºä¸Šä¸‹æ–‡ (ä¼˜åŒ–ç‰ˆ) ---
    
    // A. ä¸–ç•Œä¹¦ (ä¿æŒä¸å˜)
    var worldInfoContext = "";
    var recentText = c.chat.slice(-5).map(m => m.content).join(" ");
    var booksToScan = [];
    if(c.linkedWorldInfo && c.linkedWorldInfo.length > 0) {
        booksToScan = db.world_info.filter(w => c.linkedWorldInfo.includes(w.name));
    } else {
        booksToScan = db.world_info.filter(w => w.enabled);
    }
    if(booksToScan.length > 0) {
        booksToScan.forEach(book => {
            book.entries.forEach(entry => {
                if(entry.enabled) {
                    var isConstant = (!entry.keys || entry.keys.length === 0 || (entry.keys.length === 1 && entry.keys[0] === '*'));
                    var isTriggered = false;
                    if (!isConstant) {
                        var match = entry.keys.some(k => recentText.includes(k));
                        if (match) {
                            if (entry.secondary_keys && entry.secondary_keys.length > 0) {
                                var secMatch = entry.secondary_keys.some(k => recentText.includes(k));
                                if (secMatch) isTriggered = true;
                            } else {
                                isTriggered = true;
                            }
                        }
                    }
                    if (isConstant || isTriggered) {
                        worldInfoContext += `[World Info: ${entry.content}]\n`;
                    }
                }
            });
        });
    }

    // B. é¢„è®¾ (ä¿æŒä¸å˜)
    var presetContext = "";
    var targetPresetId = c.linkedPresetId || db.activePresetId;
    var targetPc = db.presetCollections.find(pc => pc.id === targetPresetId);
    if(targetPc && targetPc.scripts) {
        targetPc.scripts.forEach(p => {
            if(p.enabled && p.role === 'system') presetContext += `${p.content}\n`;
        });
    }

    var now = new Date();
    var timeStr = now.toLocaleString('zh-CN', { hour12: false });

    // ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šPrompt é‡å†™ ğŸ”¥ğŸ”¥ğŸ”¥
    // è¿™é‡Œçš„ Prompt æ›´åƒ SillyTavern çš„é£æ ¼ï¼Œå¼ºè°ƒæ²‰æµ¸æ„Ÿ
    var prompt = `
    [Roleplay Instructions]
    You are engaging in a text chat with ${db.user.name}.
    You are NOT an AI assistant. You are the character defined below.
    
    [CHARACTER DEFINITION]
    Name: ${c.name}
    Description: ${c.desc}
    
    [WORLD & CONTEXT]
    ${worldInfoContext}
    ${presetContext}
    Current Time: ${timeStr}
    
    [STRICT RULES]
    1. **Stay in Character**: Never break the fourth wall. Never say "As an AI".
    2. **Tone**: Use the tone, mannerisms, and speech patterns described in your Description.
    3. **Format**: This is a chat app. Keep messages relatively short and punchy, unless your character loves long speeches.
    4. **No Repetition**: Do not repeat what the user just said. Respond to it.
    5. **Action**: You can use *actions* or (thoughts) if it fits your character, but prioritize spoken dialogue.
    
    ${isPat ? '[System Event]: The user just patted your head.' : ''}
    ${hasReceived ? '[System Event]: You just received money from the user.' : ''}
    `;
    
    var msgs = [{role:"system", content: prompt}];
    
    // è¯»å–å†å²è®°å½• (å¢åŠ åˆ° 30 æ¡ä»¥è·å–æ›´å¤šè¯­å¢ƒ)
    c.chat.slice(-30).forEach(m => { 
      var content = m.content;
      if(m.role === 'system') { msgs.push({role: 'system', content: m.content}); return; }
      if(m.type !== 'text') content = `[${m.type}] ${m.content}`;
      msgs.push({role: m.role==='user'?'user':'assistant', content: content});
    });
    
    // âŒ åˆ é™¤äº†ä¹‹å‰è¿™é‡Œçš„ä¸€å¤§æ®µ "Think: ..." çš„æŒ‡ä»¤
    // âœ… æ”¹ä¸ºç®€å•çš„è§¦å‘æŒ‡ä»¤ï¼Œé˜²æ­¢ AI å•°å—¦
    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡èŠå¤©ï¼Œæˆ–è€…å†å²è®°å½•å¾ˆå°‘ï¼ŒåŠ ä¸ªå¼•å¯¼
    if (c.chat.length < 3) {
        msgs.push({role: "system", content: `[System]: Start the conversation as ${c.name}.`});
    }

    var res = await callAI_Raw(msgs);
    
    // --- 3. æ™ºèƒ½æ‹†åˆ† & å»¶è¿Ÿå‘é€ (ä¿æŒä¸å˜) ---
    var lines = res.split('\n');
    var addedCount = 0;
    var maxBubbles = c.maxReply || 1;

    for (let line of lines) {
        if (addedCount >= maxBubbles + 2) break; 

        var cleanText = line.trim();
        // ç®€å•çš„æ¸…æ´—
        if (!cleanText) continue;

        // å»é‡é€»è¾‘
        var isDuplicate = false;
        var checkRange = c.chat.slice(-3);
        for (var k = 0; k < checkRange.length; k++) {
            if (checkRange[k].role === 'ai' && checkRange[k].content === cleanText) {
                isDuplicate = true;
                break;
            }
        }
        if (isDuplicate) continue;

        var type = 'text';
        var content = cleanText;
        var quoteContent = null;

        // ç‰¹æ®ŠæŒ‡ä»¤è§£æ
        var quoteMatch = cleanText.match(/\[QUOTE:(.*?)\]/);
        if (quoteMatch) {
            quoteContent = quoteMatch[1];
            content = cleanText.replace(quoteMatch[0], "").trim();
        }
        
        var transferMatch = content.match(/\[TRANSFER:(.*?)\]/);
        var locMatch = content.match(/\[LOC:(.*?)\]/);
        var voiceMsgMatch = content.match(/\[VOICE_MSG:(.*?)\]/);
        var callMatch = content.match(/\[CALL\]/);
        var patMatch = content.match(/\[PAT\]/);
        var giftMatch = content.match(/\[GIFT:(.*?)\]/);

        if (transferMatch) {
          var amt = parseFloat(transferMatch[1]);
          if(c.balance >= amt) { type = 'transfer'; content = amt.toFixed(2); c.balance -= amt; }
          else content = "ï¼ˆä½™é¢ä¸è¶³ï¼‰";
        } else if (locMatch) { type = 'loc'; content = locMatch[1];
        } else if (voiceMsgMatch) { type = 'voice_msg'; content = voiceMsgMatch[1];
        } else if (callMatch) { type = 'voice_call'; content = 'call';
        } else if (giftMatch) { type = 'gift'; content = giftMatch[1];
        } else if (patMatch) {
            var textPart = content.replace(/\[PAT\]/g, "").trim();
            if(textPart) {
                c.chat.push({ role: 'ai', content: textPart, type: 'text' });
                addedCount++;
            }
            setTimeout(() => {
                var suffix = c.patAiSuffix || "";
                c.chat.push({ role: 'system', content: `â€œ${c.remark||c.name}â€ æ‹äº†æ‹ â€œ${db.user.name}â€${suffix}` });
                save(); renderChat();
            }, 500);
            if(!textPart) continue; 
        }

        if (!patMatch) {
            var msgObj = { role: 'ai', content: content, type: type };
            if (quoteContent) msgObj.quote = quoteContent;

            c.chat.push(msgObj);
            addedCount++;
            
            save();
            renderChat();
            
            await delay(Math.random() * 1500 + 1000); // ç¨å¾®è‡ªç„¶çš„å»¶è¿Ÿ
        }
    }
    
  } catch(e) {
    console.error(e);
    alert("AI å›å¤å¤±è´¥: " + e.message);
  } finally {
    if(btn) {
        btn.innerText = "å›å¤";
        btn.style.opacity = "1"; 
        btn.style.cursor = "pointer"; 
        btn.disabled = false; 
    }
    titleEl.innerText = originalTitle;
    isAiThinking = false;
  }
}


async function callAI_Raw(messages) {
  if(!db.api.key) return "è¯·å…ˆåœ¨æ¡Œé¢ã€è®¾ç½®ã€‘ä¸­é…ç½® API Key ğŸ”‘";
  
  var body = { 
    model: db.api.model, 
    messages: messages,
    temperature: db.api.temp,
    frequency_penalty: db.api.freq_pen,
    presence_penalty: db.api.pres_pen
  };
  if(db.api.top_k > 0) body.top_k = db.api.top_k;

  try {
    var res = await fetch(db.api.url + "/chat/completions", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer " + db.api.key },
      body: JSON.stringify(body)
    });
    
    var data = await res.json();
    
    // ğŸ›‘ é”™è¯¯æ£€æŸ¥ï¼šå¦‚æœ API è¿”å›äº†é”™è¯¯ä¿¡æ¯
    if (data.error) {
      throw new Error("API æŠ¥é”™: " + data.error.message);
    }
    
    // ğŸ›‘ æ ¼å¼æ£€æŸ¥ï¼šé˜²æ­¢ 'reading 0' é”™è¯¯
    if (!data.choices || data.choices.length === 0) {
      throw new Error("API è¿”å›äº†ç©ºæ•°æ® (å¯èƒ½æ˜¯æ¨¡å‹åç§°å¡«é”™äº†?)");
    }

    return data.choices[0].message.content;
    
  } catch (e) {
    // æŠŠé”™è¯¯æŠ›å‡ºå»ï¼Œè®©èŠå¤©ç•Œé¢æ˜¾ç¤º
    throw e;
  }
}


/* --- 6. æ—¥è®°æœ¬é€»è¾‘ (æœ€ç»ˆä¿®å¤ç‰ˆ) --- */

// æ‰“å¼€æ—¥è®°å­é¡µé¢
function openDiarySub(type) {
  getId('diary-main-view').style.display = 'none';
  getId('dsp-'+type).style.display = 'flex';
  if(type === 'user') renderDiary();
  if(type === 'ai') renderAiDiaryList();
  if(type === 'ex') updateDiarySelects();
}

// å…³é—­æ—¥è®°å­é¡µé¢
function closeDiarySub() {
  document.querySelectorAll('.diary-sub-page').forEach(el => el.style.display = 'none');
  getId('diary-main-view').style.display = 'flex';
}

// æ›´æ–°ä¸‹æ‹‰é€‰æ‹©æ¡†
function updateDiarySelects() {
  var html = '';
  db.contacts.forEach(c => {
    html += `<option value="${c.id}">${c.remark || c.name}</option>`;
  });
  getId('ai-diary-sel').innerHTML = html;
  getId('ex-diary-sel').innerHTML = html;
}

// 1. æ¸²æŸ“ç”¨æˆ·æ—¥è®° (ä¿®å¤æ—¥æœŸæ˜¾ç¤º)
function renderDiary() {
  var html = '';
  db.diary.forEach((d, idx) => {
    var favClass = d.isFav ? 'active' : '';
    
    // è§£ææ—¥æœŸï¼Œå˜æˆå¥½çœ‹çš„ "æœˆ/æ—¥" æ ¼å¼
    var dateObj = new Date(d.date);
    var day = dateObj.getDate();
    var month = dateObj.getMonth() + 1;
    var dateStr = `${month}/${day}`; 
    
    html += `<div class="note-card">
      <div class="note-header">
        <div class="note-date">${dateStr}</div>
        <div class="note-tag">User</div>
        ${d.tag ? `<div class="note-tag" style="background:#fff0f5;color:#ffb7b2">${d.tagName}</div>` : ''}
      </div>
      <div class="note-content">${d.content}</div>
      <div class="note-footer">
        <div class="note-action ${favClass}" onclick="toggleLike(${idx})">â­ï¸ æ”¶è—</div>
        <div class="note-action" onclick="delDiary(${idx})">ğŸ—‘ï¸ åˆ é™¤</div>
      </div>
    </div>`;
  });
  getId('diary-list-user').innerHTML = html || '<div style="text-align:center;color:#ccc;margin-top:40px;font-size:12px">ç©ºç©ºå¦‚ä¹Ÿ...å»å†™ä¸€ç¯‡å§</div>';
}

// æ‰“å¼€å†™æ—¥è®°å¼¹çª—
function openWriteModal() {
  getId('write-modal').style.display = 'flex';
  getId('wm-content').value = '';
  getId('wm-content').focus();
}

// å…³é—­å†™æ—¥è®°å¼¹çª—
function closeWriteModal() {
  getId('write-modal').style.display = 'none';
}

// âœ¨ ä¿å­˜æ–°æ—¥è®° (ä¿®å¤ç‰ˆï¼šå¢åŠ åé¦ˆ)
function saveNewDiary() {
  var txt = getId('wm-content').value;
  if(txt) {
    db.diary.unshift({ date: new Date().toLocaleString(), content: txt, isFav: false });
    save();
    renderDiary(); // åˆ·æ–°åˆ—è¡¨
    closeWriteModal(); // å…³é—­å¼¹çª—
    // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹æç¤ºï¼Œä½“éªŒæ›´å¥½
    setTimeout(() => alert("âœ¨ æ—¥è®°å·²ä¿å­˜ï¼"), 100);
  } else {
    alert("æ—¥è®°å†…å®¹ä¸èƒ½ä¸ºç©ºå“¦~");
  }
}

// æ”¶è—/å–æ¶ˆæ”¶è—
function toggleLike(idx) {
  db.diary[idx].isFav = !db.diary[idx].isFav;
  save();
  renderDiary();
}

// åˆ é™¤æ—¥è®°
function delDiary(idx) {
  if(confirm("ç¡®å®šè¦æ’•æ‰è¿™é¡µæ—¥è®°å—ï¼ŸğŸ—‘ï¸")) {
    db.diary.splice(idx, 1);
    save();
    renderDiary();
  }
}

// 2. æ¸²æŸ“ AI æ—¥è®° (ä¿®å¤è§£æé€»è¾‘)
function renderAiDiaryList() {
  var aiId = getId('ai-diary-sel').value;
  if(!aiId) return;
  var list = db.ai_diary.filter(d => d.aiId === aiId);
  var html = '';
  
  list.forEach(d => {
    var content = d.content;
    var weather = "æœªçŸ¥";
    var mood = "å¹³é™";
    
    // è§£æ [Weather:...] [Mood:...]
    var wMatch = content.match(/\[Weather:(.*?)\]/);
    var mMatch = content.match(/\[Mood:(.*?)\]/);
    
    if(wMatch) { weather = wMatch[1]; content = content.replace(wMatch[0], ''); }
    if(mMatch) { mood = mMatch[1]; content = content.replace(mMatch[0], ''); }
    
    content = content.trim();
    var dateObj = new Date(d.date);
    var dateStr = `${dateObj.getMonth()+1}/${dateObj.getDate()}`;

    html += `<div class="note-card" style="border-top: 4px solid #a2d2ff;">
      <div class="note-header">
        <div class="note-date" style="color:#a2d2ff">${dateStr}</div>
        <div class="note-tag" style="background:#e3f2fd;color:#a2d2ff">â˜ï¸ ${weather}</div>
        <div class="note-tag" style="background:#e3f2fd;color:#a2d2ff">âœ¨ ${mood}</div>
      </div>
      <div class="note-content">${content}</div>
    </div>`;
  });
  getId('diary-list-ai').innerHTML = html || '<div style="text-align:center;color:#ccc;margin-top:40px;font-size:12px">å®ƒè¿˜æ²¡æœ‰å†™è¿‡æ—¥è®°å“¦...</div>';
}

// ç”Ÿæˆ AI æ—¥è®° (ä¿®å¤æŒ‰é’®é€‰æ‹©å™¨)
async function generateAiDiary() {
  var aiId = getId('ai-diary-sel').value;
  if(!aiId) return;
  var c = db.contacts.find(x => x.id === aiId);
  
  // ä¿®å¤ï¼šè¿™é‡ŒåŸæ¥æ‰¾é”™äº†æŒ‰é’®ï¼Œç°åœ¨æ”¹å¥½äº†
  var btn = document.querySelector('#dsp-ai .cute-btn');
  var oldText = btn.innerText;
  btn.innerText = "AI æ­£åœ¨å›å¿†ä»Šå¤©...";
  btn.style.opacity = 0.7;
  
  var prompt = `ä½ æ‰®æ¼”ï¼š${c.name}ã€‚è®¾å®šï¼š${c.desc}ã€‚
  è¯·å†™ä¸€ç¯‡ä»Šå¤©çš„æ—¥è®°ã€‚
  
  ã€å¼ºåˆ¶æ ¼å¼è¦æ±‚ã€‘
  è¯·åŠ¡å¿…åœ¨æ—¥è®°å¼€å¤´åŒ…å«å¤©æ°”å’Œå¿ƒæƒ…æ ‡ç­¾ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
  [Weather:è¿™é‡Œå¡«å¤©æ°”] [Mood:è¿™é‡Œå¡«å¿ƒæƒ…]
  (æ¢è¡Œ)
  æ—¥è®°æ­£æ–‡...
  
  ã€å†…å®¹è¦æ±‚ã€‘
  1. å¤©æ°”å’Œå¿ƒæƒ…è¦ç¬¦åˆä½ çš„äººè®¾å’Œä»Šå¤©çš„é­é‡ã€‚
  2. æ­£æ–‡ä»¥ç¬¬ä¸€äººç§°ä¹¦å†™ï¼Œè®°å½•ä½ ä»Šå¤©å’Œç”¨æˆ·ï¼ˆ${db.user.name}ï¼‰çš„äº’åŠ¨ï¼Œæˆ–è€…ä½ è‡ªå·±çš„ç§å¯†æƒ³æ³•ã€‚
  3. è¯­æ°”è¦è‡ªç„¶ã€æ²‰æµ¸ï¼Œä¸è¦åƒæœºå™¨äººã€‚
  4. å­—æ•° 150 å­—å·¦å³ã€‚`;
  
  var chatContext = c.chat.slice(-10).map(m => (m.role==='user'?'ç”¨æˆ·':'æˆ‘') + ":" + m.content).join('\n');
  
  try {
    var res = await callAI_Raw([
      {role: "system", content: prompt},
      {role: "user", content: "æœ€è¿‘çš„èŠå¤©è®°å½•å‚è€ƒï¼š\n" + chatContext}
    ]);
    
    db.ai_diary.unshift({
      aiId: aiId,
      date: new Date().toLocaleString(),
      content: res 
    });
    save();
    renderAiDiaryList();
  } catch(e) {
    alert("ç”Ÿæˆå¤±è´¥: " + e.message);
  } finally {
    btn.innerText = oldText;
    btn.style.opacity = 1;
  }
}

// 3. äº¤æ¢æ—¥è®° (âœ¨ é‡ç‚¹ä¿®å¤ï¼šä¿®å¤äº†æŒ‰é’®æ‰¾ä¸åˆ°å¯¼è‡´æ— æ³•ç‚¹å‡»çš„é—®é¢˜)
async function startExchangeDiary() {
  var aiId = getId('ex-diary-sel').value;
  if(!aiId) return;
  var c = db.contacts.find(x => x.id === aiId);
  
  var userDiary = db.diary.length > 0 ? db.diary[0].content : "(ç”¨æˆ·ä»Šå¤©è¿˜æ²¡å†™æ—¥è®°)";
  if(db.diary.length === 0) {
    var writeNow = confirm("ä½ è¿˜æ²¡æœ‰å†™æ—¥è®°å“¦ï¼è¦ç°åœ¨å†™ä¸€ç¯‡æ¥äº¤æ¢å—ï¼Ÿ");
    if(writeNow) {
      openWriteModal();
      return;
    } else return;
  }

  // ğŸ›‘ ä¿®å¤ç‚¹ï¼šåŸæ¥è¿™é‡Œå†™çš„æ˜¯ .btn-blueï¼Œä½†æ–°ç•Œé¢æ˜¯ .cute-btnï¼Œæ‰€ä»¥æŠ¥é”™äº†
  var btn = document.querySelector('#dsp-ex .cute-btn');
  var oldText = btn.innerText;
  btn.innerText = "æ­£åœ¨äº¤æ¢ä¸­... (AI é˜…è¯»ä¸­)";
  btn.style.opacity = 0.7;

  try {
    var prompt = `ä½ æ‰®æ¼”ï¼š${c.name}ã€‚è®¾å®šï¼š${c.desc}ã€‚
    ç°åœ¨æˆ‘ä»¬åœ¨ç©ã€äº¤æ¢æ—¥è®°ã€‘ã€‚
    ã€ç”¨æˆ·çš„æ—¥è®°ã€‘ï¼š
    "${userDiary}"
    è¯·å®Œæˆä¸¤ä»¶äº‹ï¼š
    1. å†™ä¸€ç¯‡ä½ ä»Šå¤©çš„æ—¥è®°ï¼ˆç®€çŸ­ï¼Œ50å­—å·¦å³ï¼‰ã€‚
    2. é˜…è¯»ç”¨æˆ·çš„æ—¥è®°ï¼Œå†™ä¸‹ä½ çš„æ„Ÿæƒ³/å›å¤ï¼ˆæ¸©æŸ”ã€å¯çˆ±ä¸€ç‚¹ï¼‰ã€‚
    è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š
    <my_diary>
    (ä½ çš„æ—¥è®°å†…å®¹)
    </my_diary>
    <comment>
    (ä½ å¯¹ç”¨æˆ·æ—¥è®°çš„æ„Ÿæƒ³)
    </comment>`;

    var res = await callAI_Raw([{role: "system", content: prompt}]);
    
    var myDiaryMatch = res.match(/<my_diary>([\s\S]*?)<\/my_diary>/);
    var commentMatch = res.match(/<comment>([\s\S]*?)<\/comment>/);
    
    var aiDiaryContent = myDiaryMatch ? myDiaryMatch[1].trim() : "ï¼ˆAI å¿˜è®°å†™æ—¥è®°äº†...ï¼‰";
    var aiComment = commentMatch ? commentMatch[1].trim() : "ï¼ˆAI å·²é˜…ï¼‰";
    
    var userComment = prompt(`AI çš„æ—¥è®°ï¼š\n${aiDiaryContent}\n\nè¯·å†™ä¸‹ä½ çš„æ„Ÿæƒ³ï¼š`);
    if(!userComment) userComment = "ï¼ˆå·²é˜…ï¼‰";
    
    var finalContent = `ã€ğŸ’ äº¤æ¢æ—¥è®° - ä¸ ${c.name}ã€‘\n\nğŸ“… ç”¨æˆ·çš„æ—¥è®°ï¼š\n${userDiary}\n\nğŸ± AI çš„æ„Ÿæƒ³ï¼š\n${aiComment}\n\n----------------\n\nğŸ“… AI çš„æ—¥è®°ï¼š\n${aiDiaryContent}\n\nğŸ‘¤ æˆ‘çš„æ„Ÿæƒ³ï¼š\n${userComment}`;
    
    db.diary.unshift({
      date: new Date().toLocaleString(),
      content: finalContent,
      tag: 'ex',
      tagName: 'äº¤æ¢æ—¥è®°',
      isFav: true 
    });
    save();
    
    alert("äº¤æ¢æˆåŠŸï¼å·²å­˜å…¥ã€ç”¨æˆ·ç§å¯†æ—¥è®°ã€‘ä¸­ï¼ğŸŒ¸");
    openDiarySub('user'); 
    
  } catch(e) {
    alert("äº¤æ¢å¤±è´¥: " + e.message);
  } finally {
    btn.innerText = oldText;
    btn.style.opacity = 1;
  }
}

/* --- ğŸ”® å¡”ç½—å åœé€»è¾‘ (å®Œç¾å¯¼èˆªåˆ‡æ¢ç‰ˆ) --- */

var tarotState = {
    question: "",
    selectedCards: [], 
    isHistoryMode: false
};

var MAJOR_ARCANA = [
    'æ„šè€…','é­”æœ¯å¸ˆ','å¥³ç¥­å¸','å¥³çš‡','çš‡å¸','æ•™çš‡','æ‹äºº','æˆ˜è½¦','åŠ›é‡','éšè€…',
    'å‘½è¿ä¹‹è½®','æ­£ä¹‰','å€’åŠäºº','æ­»äº¡','èŠ‚åˆ¶','æ¶é­”','é«˜å¡”','æ˜Ÿæ˜Ÿ','æœˆäº®','å¤ªé˜³','å®¡åˆ¤','ä¸–ç•Œ'
];

// 1. å¼€å§‹æµç¨‹
function startTarotSession() {
    var q = getId('tarot-input-q').value.trim();
    if(!q) return alert("è¯·å…ˆåœ¨å¿ƒä¸­é»˜å¿µé—®é¢˜ï¼Œå¹¶å†™ä¸‹æ¥...");
    
    tarotState.question = q;
    tarotState.selectedCards = [];
    tarotState.isHistoryMode = false;
    
    // åˆ‡æ¢è§†å›¾
    getId('tarot-view-1').style.display = 'none';
    getId('tarot-view-2').style.display = 'flex';
    getId('tarot-view-3').style.display = 'none';
    
    // âœ¨ åˆ‡æ¢æŒ‰é’®ï¼šéšè—Xï¼Œæ˜¾ç¤ºè¿”å›
    getId('tarot-close-btn').style.display = 'none';
    getId('tarot-back-btn').style.display = 'block';
    
    renderTarotDeck();
    updateTarotSlots();
    getId('tarot-instruction').innerText = "è¯·å‡­ç›´è§‰æŠ½å–ç¬¬ 1 å¼ ç‰Œ...";
}

// 2. æ¸²æŸ“ç‰Œå †
function renderTarotDeck() {
    var deck = getId('tarot-deck');
    deck.innerHTML = "";
    var indices = Array.from({length: 22}, (_, i) => i).sort(() => Math.random() - 0.5);
    
    indices.forEach(i => {
        var card = document.createElement('div');
        card.className = 'tarot-card-back';
        card.innerText = "ğŸŒ™";
        card.onclick = function() { onCardDraw(this, i); };
        deck.appendChild(card);
    });
}

// 3. æŠ½ç‰Œé€»è¾‘
function onCardDraw(el, cardIndex) {
    if(tarotState.selectedCards.length >= 3) return;
    el.classList.add('selected');
    
    var name = MAJOR_ARCANA[cardIndex];
    var isUpright = Math.random() > 0.3; 
    var posStr = isUpright ? "æ­£ä½" : "é€†ä½";
    
    tarotState.selectedCards.push({ name: name, pos: posStr });
    updateTarotSlots();
    
    var count = tarotState.selectedCards.length;
    if(count < 3) {
        getId('tarot-instruction').innerText = `è¯·æŠ½å–ç¬¬ ${count + 1} å¼ ç‰Œ...`;
    } else {
        getId('tarot-instruction').innerText = "æŠ½å–å®Œæˆï¼å‡†å¤‡è§£è¯»...";
        setTimeout(showTarotResultPage, 800);
    }
}

function updateTarotSlots() {
    var slots = getId('tarot-slots').children;
    for(var i=0; i<3; i++) {
        var card = tarotState.selectedCards[i];
        if(card) {
            slots[i].innerHTML = `
                <div class="tarot-card-face">
                    <div style="font-size:24px;margin-bottom:5px">ğŸ´</div>
                    <div style="font-weight:bold;font-size:12px;color:#4a148c">${card.name}</div>
                    <div style="font-size:10px;color:#888">${card.pos}</div>
                </div>
            `;
        } else {
            slots[i].innerHTML = i + 1;
        }
    }
}

// 4. ç»“æœé¡µ
function showTarotResultPage() {
    getId('tarot-view-2').style.display = 'none';
    getId('tarot-view-3').style.display = 'flex';
    
    // âœ¨ ç¡®ä¿æ˜¾ç¤ºè¿”å›é”®
    getId('tarot-close-btn').style.display = 'none';
    getId('tarot-back-btn').style.display = 'block';
    
    var header = getId('tarot-result-header');
    var cardsStr = tarotState.selectedCards.map(c => `${c.name}(${c.pos})`).join('ã€');
    
    header.innerHTML = `
        <div style="font-size:12px;color:#999">é—®é¢˜ï¼š${tarotState.question}</div>
        <div style="margin-top:5px;font-weight:bold;color:#6a1b9a">ç‰Œé˜µï¼š${cardsStr}</div>
    `;
    
    getId('tarot-result-content').innerHTML = `<div style="text-align:center;margin-top:50px;color:#999">
        ğŸ”® ç‰Œé˜µå·²ç”Ÿæˆ<br>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¬å”¤ AI è¿›è¡Œè§£è¯»
    </div>`;
    
    getId('tarot-ai-btn').style.display = 'block';
}

// 5. AI è§£è¯»
async function requestTarotAI() {
    var btn = getId('tarot-ai-btn');
    var contentBox = getId('tarot-result-content');
    
    btn.disabled = true;
    btn.innerText = "ğŸ”® æ­£åœ¨è¿æ¥å®‡å®™èƒ½é‡...";
    contentBox.innerHTML = "æ­£åœ¨è§£è¯»ç‰Œæ„ï¼Œè¯·ç¨å€™...";
    
    var cardsStr = tarotState.selectedCards.map(c => `${c.name}(${c.pos})`).join('ã€');
    var prompt = `æˆ‘æ­£åœ¨è¿›è¡Œå¡”ç½—å åœã€‚
    ã€é—®é¢˜ã€‘ï¼š${tarotState.question}
    ã€æŠ½åˆ°çš„ç‰Œã€‘ï¼š${cardsStr} (ä¸‰å¼ ç‰Œé˜µï¼šè¿‡å»/ç°åœ¨/æœªæ¥ï¼Œæˆ– ç°çŠ¶/é—®é¢˜/å»ºè®®)
    
    è¯·ä½œä¸ºä¸€ä½ç¥ç§˜ã€æ¸©æŸ”çš„å¡”ç½—å¸ˆï¼Œä¸ºæˆ‘è§£è¯»è¿™ä¸‰å¼ ç‰Œçš„å«ä¹‰ï¼Œå¹¶ç»“åˆé—®é¢˜ç»™å‡ºæŒ‡å¼•ã€‚
    å­—æ•°æ§åˆ¶åœ¨ 200 å­—ä»¥å†…ã€‚`;
    
    try {
        var res = await callAI_Raw([{role: "user", content: prompt}]);
        contentBox.innerHTML = res;
        
        db.tarot_history.unshift({
            date: new Date().toLocaleString(),
            question: tarotState.question,
            cards: cardsStr,
            result: res
        });
        save();
        
        btn.style.display = 'none'; 
    } catch(e) {
        contentBox.innerText = "è§£è¯»å¤±è´¥: " + e.message;
        btn.innerText = "é‡è¯•";
        btn.disabled = false;
    }
}

// 6. é‡ç½® / è¿”å›ä¸»é¡µ
function resetTarot() {
    getId('tarot-input-q').value = "";
    getId('tarot-view-3').style.display = 'none';
    getId('tarot-view-2').style.display = 'none';
    getId('tarot-view-1').style.display = 'flex';
    getId('tarot-ai-btn').disabled = false;
    getId('tarot-ai-btn').innerText = "âœ¨ å¬å”¤ AI è§£è¯»";
    
    // âœ¨ åˆ‡æ¢å›å…³é—­æŒ‰é’®
    getId('tarot-close-btn').style.display = 'block';
    getId('tarot-back-btn').style.display = 'none';
}

// ğŸ“œ å†å²è®°å½•
function showTarotHistory() {
    var list = db.tarot_history || [];
    if(list.length === 0) return alert("è¿˜æ²¡æœ‰å åœè®°å½•å“¦~");
    
    getId('tarot-view-1').style.display = 'none';
    getId('tarot-view-2').style.display = 'none';
    getId('tarot-view-3').style.display = 'flex';
    getId('tarot-ai-btn').style.display = 'none'; 
    
    // âœ¨ æ˜¾ç¤ºè¿”å›é”®
    getId('tarot-close-btn').style.display = 'none';
    getId('tarot-back-btn').style.display = 'block';
    
    var contentBox = getId('tarot-result-content');
    var html = `<div style="padding-bottom:10px;font-weight:bold;color:#6a1b9a">ğŸ“œ å†å²è®°å½• (${list.length})</div>`;
    
    list.forEach((item, idx) => {
        html += `
        <div class="tarot-history-item" onclick="viewHistoryItem(${idx})">
            <div class="th-date">${item.date}</div>
            <div class="th-q">é—®ï¼š${item.question}</div>
            <div class="th-cards">ğŸ´ ${item.cards}</div>
        </div>`;
    });
    
    contentBox.innerHTML = html;
    getId('tarot-result-header').innerHTML = ""; 
}

function viewHistoryItem(idx) {
    var item = db.tarot_history[idx];
    var header = getId('tarot-result-header');
    var contentBox = getId('tarot-result-content');
    
    header.innerHTML = `
        <div style="font-size:12px;color:#999">${item.date}</div>
        <div style="font-weight:bold;color:#4a148c">é—®ï¼š${item.question}</div>
        <div style="margin-top:5px;color:#7b1fa2;font-size:12px">ğŸ´ ${item.cards}</div>
    `;
    contentBox.innerHTML = item.result;
    
    var backBtn = document.createElement('div');
    backBtn.innerHTML = "<a style='color:#999;font-size:12px;cursor:pointer;display:block;margin-top:10px' onclick='showTarotHistory()'>â® è¿”å›åˆ—è¡¨</a>";
    contentBox.prepend(backBtn);
}

/* --- ğŸ‘¤ ç”¨æˆ· & å¤šäººè®¾é€»è¾‘ (å‡çº§ç‰ˆ) --- */

// åŠ è½½å½“å‰ç”¨æˆ·æ•°æ®åˆ°è¾“å…¥æ¡†
function loadUser() {
  getId('u-name').value = db.user.name;
  getId('u-desc').value = db.user.desc;
  var av = db.user.avatar || "https://via.placeholder.com/100";
  getId('u-av-url').value = db.user.avatar || ""; 
  getId('u-av-preview').src = av;
  
  // é¡ºä¾¿æ¸²æŸ“é©¬ç”²åˆ—è¡¨
  renderUserProfiles();
}

// ä¿å­˜å½“å‰ä¿®æ”¹ (åªæ›´æ–°å½“å‰çŠ¶æ€)
function saveUser() {
  var nameInput = getId('u-name');
  var descInput = getId('u-desc');
  var avInput = getId('u-av-url');

  if (nameInput && nameInput.value) db.user.name = nameInput.value;
  if (descInput) db.user.desc = descInput.value;
  if (avInput) db.user.avatar = avInput.value;
  
  save();
  alert("ä¿å­˜æˆåŠŸï¼âœ¨\nå½“å‰èº«ä»½å·²æ›´æ–°ã€‚");
  loadUser();
  
  // åˆ·æ–°æ¡Œé¢åå­—
  var bentoName = document.querySelector('.tt-one-line'); 
  if(bentoName) updateTime(); 
}

// â• å­˜ä¸ºæ–°é©¬ç”²
function saveAsNewProfile() {
  var name = getId('u-name').value;
  if(!name) return alert("è¯·å…ˆè¾“å…¥æ˜µç§°ï¼");
  
  // åˆ›å»ºä¸€ä¸ªæ–°çš„äººè®¾å¯¹è±¡
  var newProfile = {
      id: 'up_' + Date.now(), // å”¯ä¸€ID
      name: name,
      avatar: getId('u-av-url').value,
      desc: getId('u-desc').value,
      balance: db.user.balance, // æŠŠå½“å‰çš„é’±ä¹Ÿå­˜è¿›å»
      inventory: [...db.user.inventory] // æŠŠå½“å‰çš„èƒŒåŒ…å¤åˆ¶ä¸€ä»½
  };
  
  if(!db.user_profiles) db.user_profiles = [];
  db.user_profiles.push(newProfile);
  save();
  renderUserProfiles();
  alert(`å·²å°† "${name}" å­˜å…¥é©¬ç”²åº“ï¼ğŸ­`);
}

// ğŸ”„ æ¸²æŸ“é©¬ç”²åˆ—è¡¨
function renderUserProfiles() {
  var list = getId('user-profiles-list');
  if(!list) return;
  
  if(!db.user_profiles || db.user_profiles.length === 0) {
      list.innerHTML = `<div style="text-align:center;color:#ccc;padding:20px;font-size:12px;border:2px dashed #eee;border-radius:15px">è¿˜æ²¡æœ‰å­˜è¿‡é©¬ç”²å“¦<br>è®¾ç½®å¥½åç‚¹å‡»â€œå­˜ä¸ºæ–°é©¬ç”²â€å§~</div>`;
      return;
  }
  
  var html = '';
  db.user_profiles.forEach((p, idx) => {
      var isActive = (p.name === db.user.name && p.desc === db.user.desc);
      var activeStyle = isActive ? "border:2px solid #ffb7b2;background:#fff0f5;" : "border:1px solid #eee;background:#fff;";
      
      html += `
      <div style="display:flex;align-items:center;padding:15px;border-radius:15px;margin-bottom:10px;${activeStyle}transition:all 0.2s;" onclick="switchUserProfile('${p.id}')">
          <img src="${p.avatar || 'https://via.placeholder.com/100'}" style="width:45px;height:45px;border-radius:50%;object-fit:cover;margin-right:12px;border:1px solid #ddd">
          <div style="flex:1;overflow:hidden">
              <div style="font-weight:bold;color:#555;font-size:15px">${p.name} ${isActive?'<span style="font-size:10px;color:#ff8fab;background:#fff;padding:2px 5px;border-radius:5px;margin-left:5px">å½“å‰</span>':''}</div>
              <div style="font-size:12px;color:#999;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.desc || 'æš‚æ— æè¿°'}</div>
          </div>
          <button class="btn btn-gray" style="padding:5px 10px;font-size:12px;height:auto;margin-left:5px" onclick="event.stopPropagation();deleteUserProfile(${idx})">ğŸ—‘ï¸</button>
      </div>
      `;
  });
  list.innerHTML = html;
}

// ğŸ­ åˆ‡æ¢é©¬ç”²
function switchUserProfile(pid) {
    var target = db.user_profiles.find(p => p.id === pid);
    if(!target) return;
    
    if(confirm(`ç¡®å®šè¦åˆ‡æ¢èº«ä»½ä¸º "${target.name}" å—ï¼Ÿ\n(å½“å‰çš„é’±åŒ…å’ŒèƒŒåŒ…ä¹Ÿä¼šå˜æˆè¿™ä¸ªé©¬ç”²çš„å“¦)`)) {
        // è¦†ç›–å½“å‰ç”¨æˆ·æ•°æ®
        db.user.name = target.name;
        db.user.avatar = target.avatar;
        db.user.desc = target.desc;
        db.user.balance = target.balance || 0;
        db.user.inventory = target.inventory ? [...target.inventory] : [];
        
        save();
        loadUser(); // åˆ·æ–°ç•Œé¢
        alert(`èº«ä»½å·²åˆ‡æ¢ï¼ç°åœ¨ä½ æ˜¯ ${target.name} å•¦ï¼âœ¨`);
    }
}

// ğŸ—‘ï¸ åˆ é™¤é©¬ç”²
function deleteUserProfile(idx) {
    if(confirm("ç¡®å®šè¦é”€æ¯è¿™ä¸ªé©¬ç”²å—ï¼Ÿ")) {
        db.user_profiles.splice(idx, 1);
        save();
        renderUserProfiles();
    }
}



/* --- ğŸ… ä¸“æ³¨æ—¶é’Ÿé€»è¾‘ (ä¿®å¤ç‰ˆ) --- */
var focusTimer = null;
var focusTotalSec = 0;
var focusLeftSec = 0;
var focusPaused = false;
var focusPauseUsed = false; 
var focusAiId = "";
var focusGiveUpStep = 0;

// ğŸµ ç™½å™ªéŸ³ (ä½¿ç”¨ mp3 æ ¼å¼ï¼Œå…¼å®¹æ€§æ›´å¥½)
var NOISE_URLS = {
    rain: "https://actions.google.com/sounds/v1/weather/rain_heavy_loud.ogg", 
    fire: "https://actions.google.com/sounds/v1/ambiences/fire.ogg", 
    forest: "https://actions.google.com/sounds/v1/animals/birds_forest_morning.ogg", 
    night: "https://actions.google.com/sounds/v1/nature/crickets_chirping.ogg"  
};

function initClockApp() {
  var sel = getId('clock-ai-sel');
  if (!sel) return;
  sel.innerHTML = ""; 
  if (!db.contacts || db.contacts.length === 0) {
    var opt = document.createElement('option');
    opt.innerText = "æ²¡æœ‰å¥½å‹...å»QQæ·»åŠ ä¸€ä¸ªå§";
    sel.appendChild(opt);
    return;
  }
  db.contacts.forEach(c => {
    var opt = document.createElement('option');
    opt.value = c.id;
    opt.innerText = c.remark || c.name;
    sel.appendChild(opt);
  });
  if (db.contacts.length > 0) sel.value = db.contacts[0].id;

  // å¼ºåˆ¶é‡ç½®è§†å›¾
  getId('clock-setup').style.display = 'flex';
  getId('clock-run').style.display = 'none';
  
  // åœæ­¢éŸ³ä¹
  var audio = getId('clock-bgm');
  audio.pause();
}

function startFocus() {
  var min = parseInt(getId('clock-val-disp').innerText);
  focusAiId = getId('clock-ai-sel').value;
  if(!focusAiId) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé™ªä¼´ AIï¼");
  
  focusTotalSec = min * 60;
  focusLeftSec = focusTotalSec;
  focusPaused = false;
  focusPauseUsed = false;
  focusGiveUpStep = 0;
  
  // åˆ‡æ¢è§†å›¾
  getId('clock-setup').style.display = 'none';
  getId('clock-run').style.display = 'flex';
  
  var c = db.contacts.find(x => x.id === focusAiId);
  getId('clock-run-av').src = c.avatar || "https://via.placeholder.com/100";
  getId('clock-run-name').innerText = c.remark || c.name;
  
  updateRing(focusTotalSec, focusTotalSec);
  getId('btn-pause').classList.remove('disabled');
  getId('pause-txt').innerText = "æš‚åœ(1)";
  getId('clock-status').innerText = "FOCUSING";
  
  var btnGiveUp = document.querySelector('.cc-giveup');
  btnGiveUp.innerHTML = 'ğŸ³ï¸<br><span style="font-size:10px">æ”¾å¼ƒ</span>';
  btnGiveUp.style.background = '#f5f5f5';
  btnGiveUp.style.color = '#999';
  
  // ğŸµ æ’­æ”¾ç™½å™ªéŸ³ (å…³é”®ä¿®å¤)
  var noiseType = getId('clock-noise-sel').value;
  var audio = getId('clock-bgm');
  if(noiseType && NOISE_URLS[noiseType]) {
      audio.src = NOISE_URLS[noiseType];
      audio.volume = 0.5; 
      audio.play().catch(e => console.log("æ’­æ”¾å¤±è´¥:", e));
  } else {
      audio.pause();
  }

  // âœ¨ è§¦å‘ AI
  triggerFocusAi('start');
  
  if(focusTimer) clearInterval(focusTimer);
  focusTimer = setInterval(tickFocus, 1000);
}

function tickFocus() {
  if(focusPaused) return;
  
  focusLeftSec--;
  updateRing(focusLeftSec, focusTotalSec);
  
  // éšæœºæŸ¥å²— (æ¯åˆ†é’Ÿ 20% æ¦‚ç‡)
  if (focusLeftSec % 60 === 0 && focusLeftSec > 60 && focusLeftSec < focusTotalSec) {
      if (Math.random() < 0.2) { 
          triggerFocusAi('random_check');
      }
  }
  
  if(focusLeftSec <= 0) {
    finishFocus();
  }
}

function updateRing(left, total) {
  var r = 120;
  var c = 2 * Math.PI * r; 
  var offset = c - (left / total) * c;
  getId('ring-bar').style.strokeDashoffset = offset;
  
  var m = Math.floor(left / 60);
  var s = left % 60;
  getId('clock-timer').innerText = ('0'+m).slice(-2) + ":" + ('0'+s).slice(-2);
}

function togglePause() {
  if(focusPaused) {
    // æ¢å¤
    focusPaused = false;
    getId('clock-status').innerText = "FOCUSING";
    getId('btn-pause').innerHTML = 'â¸<br><span style="font-size:10px">æš‚åœ(0)</span>';
    getId('btn-pause').classList.add('disabled'); 
    triggerFocusAi('resume');
    
    var audio = getId('clock-bgm');
    if(audio.src && !audio.paused) audio.play();
    
  } else {
    // æš‚åœ
    if(focusPauseUsed) return; 
    focusPaused = true;
    focusPauseUsed = true;
    getId('clock-status').innerText = "PAUSED";
    getId('btn-pause').innerHTML = 'â–¶ï¸<br><span style="font-size:10px">ç»§ç»­</span>';
    
    triggerFocusAi('pause'); 
    getId('clock-bgm').pause();
  }
}

function giveUpFocus() {
  var btn = document.querySelector('.cc-giveup');
  
  if (focusGiveUpStep === 0) {
      focusGiveUpStep = 1;
      triggerFocusAi('giveup_attempt'); 
      
      btn.style.background = '#ff4d4f';
      btn.style.color = '#fff';
      btn.innerHTML = 'âš ï¸<br><span style="font-size:10px">ç¡®å®š?</span>';
      
      setTimeout(() => {
          if(focusGiveUpStep === 1) {
              focusGiveUpStep = 0;
              btn.style.background = '#f5f5f5';
              btn.style.color = '#999';
              btn.innerHTML = 'ğŸ³ï¸<br><span style="font-size:10px">æ”¾å¼ƒ</span>';
          }
      }, 5000);
      
  } else {
      clearInterval(focusTimer);
      getId('clock-bgm').pause(); 
      triggerFocusAi('giveup_confirm'); 
      
      setTimeout(() => {
          getId('clock-setup').style.display = 'flex';
          getId('clock-run').style.display = 'none';
      }, 3000);
  }
}

function finishFocus() {
  clearInterval(focusTimer);
  getId('clock-bgm').pause(); 
  getId('clock-status').innerText = "DONE!";
  triggerFocusAi('finish');
  
  var reward = Math.floor(focusTotalSec / 60) * 2;
  db.user.balance += reward;
  save();
  setTimeout(() => {
    alert(`ä¸“æ³¨å®Œæˆï¼è·å¾— Â¥${reward} å¥–åŠ±ï¼ğŸ‰`);
    getId('clock-setup').style.display = 'flex';
    getId('clock-run').style.display = 'none';
  }, 4000);
}

// ğŸ§  æ ¸å¿ƒ AI ç”Ÿæˆé€»è¾‘ (ä¿®å¤äº† Prompt)
async function triggerFocusAi(type) {
  var c = db.contacts.find(x => x.id === focusAiId);
  var bub = getId('clock-run-bub');
  
  bub.innerText = "ğŸ’¬ ...";
  
  var instruction = "";
  
  if (type === 'start') {
      instruction = `The user just started focusing. Encourage them briefly. Also, describe what YOU are doing right now (e.g., reading, working, guarding) based on your persona.`;
  } else if (type === 'random_check') {
      instruction = `The user is focusing. Look at them. Give a short comment or reminder based on your persona.`;
  } else if (type === 'pause') {
      instruction = `The user used their ONLY chance to pause. Urge them to come back soon. Be gentle or toxic based on your persona.`;
  } else if (type === 'resume') {
      instruction = `The user resumed focusing. Acknowledge it briefly.`;
  } else if (type === 'giveup_attempt') {
      instruction = `The user clicked 'Give Up'. React STRONGLY to stop them. Scold them, beg them, or mock them based on your persona.`;
  } else if (type === 'giveup_confirm') {
      instruction = `The user gave up. Say something disappointed or cold.`;
  } else if (type === 'finish') {
      instruction = `The user finished focusing. Praise them.`;
  }

  // ğŸ”¥ å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶ AI å•æ¬¡è¾“å‡ºï¼Œç¦æ­¢åˆ—ä¸¾é€‰é¡¹
  var prompt = `Roleplay as: ${c.name}.
  Character Description: ${c.desc}.
  User: ${db.user.name}.
  Context: Focus Timer App.
  
  Task: ${instruction}
  
  CRITICAL RULES:
  1. Speak DIRECTLY to the user.
  2. DO NOT give options (like "Option A... Option B...").
  3. DO NOT output labels (like "[Gentle]...").
  4. Output ONLY ONE sentence.
  5. Keep it under 40 words.
  6. Use Chinese.`;
  
  try {
    var res = await callAI_Raw([{role:"system", content: prompt}]);
    bub.innerText = res;
  } catch(e) {
    bub.innerText = "(AI è¿æ¥å¤±è´¥)";
  }
}
init();

</script>
</body>
</html>